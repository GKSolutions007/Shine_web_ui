@model ShineWeb.Models.SingleMasterModel
@{
    ViewBag.Title = ViewData["FormName"];
}
<link href="~/Content/bootstrap.min.css" rel="stylesheet" />
<link href="~/Content/dataTables.bootstrap.min.css" rel="stylesheet" />
<link href="~/Content/navbar.css" rel="stylesheet" />
<link href="~/Content/buttonTop.css" rel="stylesheet" />
<link href="~/Content/jquery-ui.css" rel="stylesheet" />

<script src="~/Scripts/bootstrap.min.js"></script>
<script src="~/Scripts/jquery-1.10.2.min.js"></script>
<script src="~/Scripts/bootstrap-typeahead.min.js"></script>
<script src="~/Scripts/jquery.dataTables.min.js"></script>
<script src="~/Scripts/dataTables.bootstrap.min.js"></script>
<script src="~/Scripts/jquery-ui.min.js"></script>
<script src="~/Scripts/Validation.js"></script>
<script src="~/Scripts/js/refreshtoken.js"></script>

<style>
    /* Modern Theme Styles */
    body {
        background-color: #f7f9fb;
        color: #333;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    .card-box {
        background: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        margin-top: 10px;
        margin-bottom: 10px;
        border: 1px solid #eaeaea;
    }

    /* Material Form Controls */
    .form-group-material {
        position: relative;
        margin-bottom: 15px;
    }

    .form-control-material {
        border: none;
        border-bottom: 2px solid #eee;
        border-radius: 0;
        padding: 8px 5px;
        background: transparent !important;
        box-shadow: none !important;
        height: 38px;
        width: 100%;
        transition: border-color 0.3s;
    }

    .form-control-material:focus {
        border-bottom-color: #007bff;
        outline: none;
    }

    .label-material {
        position: absolute;
        top: 8px;
        left: 5px;
        font-size: 13px;
        color: #999;
        pointer-events: none;
        transition: 0.2s ease all;
    }

    .form-control-material:focus ~ .label-material,
    .form-control-material:not(:placeholder-shown) ~ .label-material,
    /* Handle select elements */
    .form-control-material:valid ~ .label-material {
        top: -12px;
        font-size: 11px;
        color: #007bff;
        font-weight: 600;
    }

    /* Specific for Date Inputs to prevent label overlapping */
    input[type="date"].form-control-material ~ .label-material {
        top: -12px;
        font-size: 11px;
    }

    /* DataTable Overrides */
    .table-container {
        margin-top: 5px;
    }

    .trclrforcolheader {
        /* User specified class - keep styles or append if needed */
        background-color: #f8f9fa !important;
        color: #495057 !important;
        border-bottom: 2px solid #dee2e6 !important;
    }

    td {
        font-size: 11px;
        cursor: pointer;
        padding: 10px 8px !important;
    }

    /* Scrollbar Styling for DataTables */
    .dataTables_scrollBody::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    .dataTables_scrollBody::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
    }

    /* Button Styling */
    .btn-modern {
        padding: 8px 20px;
        font-weight: 600;
        border-radius: 6px;
        transition: all 0.2s;
    }

    .btn-modern:active {
        transform: scale(0.98);
    }

    /* Modal Styling */
    .modalBatch {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        backdrop-filter: blur(4px);
    }

    .modalBatch-content {
        background-color: #fff;
        margin: 5% auto;
        padding: 5px;
        border-radius: 12px;
        width: 85%;
        max-height: 85vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .modal-header {
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-body {
        overflow-y: auto;
        padding: 5px 0;
        flex-grow: 1;
    }

    .modal-footer {
        padding-top: 15px;
        border-top: 1px solid #eee;
        text-align: right;
    }

    .closefg {
        font-size: 24px;
        color: #999;
        cursor: pointer;
        border: none;
        background: none;
    }

    .closefg:hover {
        color: #333;
    }
</style>

<body>
    <div class="container-fluid">
        @Html.HiddenFor(model => model.FormName, new { @autocomplete = "off", @class = "form-control", @id = "txtFormName" })
        @Html.HiddenFor(model => model.ID, new { @autocomplete = "off", @class = "form-control FormclrField", @id = "txtID" })
        
        <div class="row" style="margin-top: 20px;">
            <div class="col-md-12">
                <h4 id="MainHeading" style="font-weight: 600; color: #444;">@ViewData["FormName"]</h4>
                <div class="toastBox"></div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="card-box">
            <div class="row">
                <div class="col-md-3 col-sm-6">
                    <div class="form-group-material">
                        <select tabindex="1" class="form-control form-control-material FormclrcmbField" id="cmbUsers" required>
                            <option value="0">Select User</option>
                        </select>
                        <label class="label-material">User</label>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="form-group-material">
                        <select tabindex="2" class="form-control form-control-material FormclrcmbField" id="cmbTrans" required>
                            <option value="0">Select Transaction</option>
                        </select>
                        <label class="label-material">Transaction</label>
                        <div style="color: red; font-size: 11px; position: absolute;" id="divErrFParty" class="clrdivs"></div>
                    </div>
                </div>
                <div class="col-md-2 col-sm-6">
                    <div class="form-group-material">
                        <input tabindex="3" class="form-control form-control-material FormfilterclrField" type="date" id="dtpFFrom" placeholder=" " oninput="javascript: if (this.value > this.max) { this.value = this.max; }">
                        <label class="label-material">From Date</label>
                        <div style="color: red; font-size: 11px; position: absolute;" id="divErrFFrom" class="clrdivs"></div>
                    </div>
                </div>
                <div class="col-md-2 col-sm-6">
                    <div class="form-group-material">
                        <input tabindex="4" class="form-control form-control-material FormfilterclrField" type="date" id="dtpFTo" placeholder=" " oninput="javascript: if (this.value > this.max) { this.value = this.max; }">
                        <label class="label-material">To Date</label>
                        <div style="color: red; font-size: 11px; position: absolute;" id="divErrFTo" class="clrdivs"></div>
                    </div>
                </div>
                <div class="col-md-2 col-sm-12 text-center" style="padding-top: 5px;">
                    <button id="btnFilter" class="btn btn-primary btn-modern"><span class="glyphicon glyphicon-filter"></span> Filter</button>
                    <!-- Hidden fields preserved -->
                    <div hidden>
                        <input id="txtHUserID" /><input id="txtHFormID" /><input id="txtHID" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Tables Section -->
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-4">
                <div class="card-box table-container">
                    <h5 style="margin-top:0; font-weight: 600; font-size: 14px; margin-bottom: 15px; color: #555;">Users</h5>
                    <table class="table table-bordered table-hover" id="tblUserData" width="100%">
                        <thead>
                            <tr>
                                <th class="trclrforcolheader" style="text-align:center;font-size: 12px;width:0%;">UserID</th>
                                <th class="trclrforcolheader" style="text-align:center;font-size: 12px;width:100%;">User Name</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
            <div class="col-xs-12 col-sm-12 col-md-4">
                <div class="card-box table-container">
                    <h5 style="margin-top:0; font-weight: 600; font-size: 14px; margin-bottom: 15px; color: #555;">Transactions</h5>
                    <table class="table table-bordered table-hover" id="tblTransactions" width="100%">
                        <thead>
                            <tr>
                                <th class="trclrforcolheader" style="text-align:center;font-size: 12px;width:0%;">TransID</th>
                                <th class="trclrforcolheader" style="text-align:center;font-size: 12px;width:100%;">Transaction Name</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
            <div class="col-xs-12 col-sm-12 col-md-4">
                <div class="card-box table-container">
                    <h5 style="margin-top:0; font-weight: 600; font-size: 14px; margin-bottom: 15px; color: #555;">Details</h5>
                    <table class="table table-bordered table-hover" id="tblTransData" width="100%">
                        <thead>
                            <tr>
                                <th class="trclrforcolheader" style="text-align:center;font-size: 12px;width:0%;">ID</th>
                                <th class="trclrforcolheader" style="text-align:center;font-size: 12px;width:85%;">Description</th>
                                <th class="trclrforcolheader" style="text-align:center;font-size: 12px;width:15%;">Count</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>

        <!-- Detail Modal -->
        <div class="modalBatch" id="myModalfg">
            <div class="modalBatch-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="lblPopupheading" style="margin:0; font-weight: bold; color: #333;">Form Name</h5>
                    <button type="button" class="closefg" title="Close">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="dvAssign" style="width:100%;">
                        <table class="table table-bordered" id="tblMainHeader" style="width:100%">
                            <!-- Dynamic columns will be inserted here -->
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning btn-modern" id="btnBatchClose" style="padding: 8px 30px;">
                        <span class="glyphicon glyphicon-remove"></span> Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>

<script type="text/javascript">
    var UID = '@Session["LoginUserID"]';
    var Aurl = '@Session["APIurl"]';
    
    $(document).ready(function() {
        setDate("dtpFFrom", 0);
        setDate("dtpFTo", 0);
        
        // Handle input placeholders to trigger floating labels correctly
        $('.form-control-material').on('change blur', function() {
            if ($(this).val()) {
                $(this).addClass('has-value');
            } else {
                $(this).removeClass('has-value');
            }
        });
    });

    var TableUserData = $('#tblUserData').DataTable({
        paging: false,
        searching: false,
        info: false,
        ordering: false,
        scrollY: "250px",
        scrollX: true,
        scrollCollapse: true,
        "columnDefs": [{ "targets": [0], "visible": false, searchable: false, filter: false, ordering: false }],
    });
    var TableTransactions = $('#tblTransactions').DataTable({
        paging: false,
        searching: false,
        info: false,
        ordering: false,
        scrollY: "250px",
        scrollX: true,
        scrollCollapse: true,
        "columnDefs": [{ "targets": [0], "visible": false, searchable: false, filter: false, ordering: false }],
    });
    var TableTransData = $('#tblTransData').DataTable({
        paging: false,
        searching: false,
        info: false,
        ordering: false,
        scrollY: "250px",
        scrollX: true,
        scrollCollapse: true,
        "columnDefs": [{ "targets": [0], "visible": false, searchable: false, filter: false, ordering: false }],
    });
    var TableMainHeader = $('#tblMainHeader').DataTable({
        paging: false,
        searching: true,
        info: false,
        ordering: false,
        scrollY: "250px",
        scrollX: true,
        scrollCollapse: true,
        "columnDefs": [{ "targets": [0], "visible": false, searchable: false, filter: false, ordering: false }],
    });

    var modal = document.getElementById("myModalfg");
    var span = document.getElementsByClassName("closefg")[0];
    span.onclick = function () {
        modal.style.display = "none";
    }
    $('#btnBatchClose').click(function (e) {
        modal.style.display = "none";
    });

    function setDate(FieldID, Type) {
        $.ajax({
            url: "@Url.Action("setdate", "Home")",
            type: 'get',
            contentType: 'json',
            data: { TypeID: Type },
            success: function (data) {
                $.each(data, function (i, items) {
                    $("#" + FieldID).attr("max", items.MaxDate);
                    $("#" + FieldID).attr("min", items.MinDate);
                    $("#" + FieldID).val(items.Value);
                    if(items.Value) $("#" + FieldID).addClass('has-value');
                });
            }, 
            error: function (data) {
                if (data.status == "401") {
                    var msg = data.responseJSON.Message;
                }
            }
        });
    }

    GetData(1);
    var columns = [];
    
    function GetData(nMode, strUID = null, strFID = null, strID = null) {
        $.ajax({
            url: Aurl + "modifyhistory/get",
            type: 'get',
            contentType: 'json',
            data: { Mode: nMode, UserID: strUID, FormID: strFID, FromDate: $("#dtpFFrom").val(), ToDate: $("#dtpFTo").val(), HID: strID },
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                if (nMode == 1) {
                    $('#cmbUsers,#cmbTrans').find("option").remove();
                    $('#cmbUsers,#cmbTrans').append($('<option/>', {
                        value: 0,
                        text: "-- Select --",
                    }));
                    $.each(data, function (i, items) {
                        if (items.FType == 1) {
                            $('#cmbTrans').append($('<option/>', {
                                value: items.ID,
                                text: items.Name,
                            }));
                        }
                        if (items.FType == 2) {
                            $('#cmbUsers').append($('<option/>', {
                                value: items.ID,
                                text: items.Name,
                            }));
                        }
                    });
                }
                else if (nMode == 2) {
                    TableUserData.draw().clear(); TableTransactions.draw().clear(); TableTransData.draw().clear();
                    if (data.length > 0) {
                        $.each(data, function (i, items) {
                            TableUserData.row.add([
                                items.ID, items.Name
                            ]).draw(false);
                        });
                    } else {
                        showErrorSnackbar("No Records Found");
                    }
                }
                else if (nMode == 3) {
                    TableTransactions.draw().clear(); TableTransData.draw().clear();
                    $.each(data, function (i, items) {
                        TableTransactions.row.add([
                            items.ID, items.Name
                        ]).draw(false);
                    });
                }
                else if (nMode == 4) {
                    TableTransData.draw().clear();
                    data = eval(data);
                    $.each(data, function (i, items) {
                        TableTransData.row.add([
                            items.ID, items.Name, items.nCount
                        ]).draw(false);
                    });
                }
                else if (nMode == 5) {
                    TableMainHeader.destroy();
                    $('#tblMainHeader').empty();
                    modal.style.display = "block";

                    data = eval(data);
                    const columns1 = Object.keys(data[0]).map(key => {
                        return { title: key, data: key, className: 'trclrforcolheader_th' };
                    });

                    $('#tblMainHeader').DataTable({
                        paging: false,
                        searching: true,
                        info: false,
                        ordering: false,
                        destroy: true,
                        autoWidth: true, 
                        scrollY: "350px",
                        scrollX: true,
                        scrollCollapse: true,
                        "data": data,
                        "columns": columns1,
                        "columnDefs": [{ "targets": [0], "visible": false, searchable: false, filter: false, ordering: false }],
                    });
                    
                    // Manually re-add the user requested class to dynamic headers if needed
                    $('#tblMainHeader thead th').addClass('trclrforcolheader');
                    
                    TableMainHeader = $('#tblMainHeader').DataTable();
                    
                    $('#tblMainHeader').find('tr').last().css('background-color', 'lightgreen');
                    $("#tblMainHeader tbody tr").each(function () {
                        var i = 0;
                        $(this).find('td').each(function (index) {
                            var currentCell = $(this);
                            var nextCell = $(this).closest('tr').next('tr').find('td').eq(i).length > 0 ? $(this).closest('tr').next('tr').find('td').eq(i) : null;
                            if (nextCell != null) {
                                if (currentCell[0].innerHTML != nextCell[0].innerHTML) {
                                    currentCell.css('color', 'red');
                                }
                            }
                            i = i + 1;
                        });
                    });
                }
            }, 
            error: function (data) {
                if (data.status == "401") {
                    var msg = data.responseJSON.Message;
                }
            }
        });
    }

    $("#btnFilter").click(function () {
        var IsValid = true;
        if ($("#dtpFFrom").val() == "") {
            IsValid = false;
            $("#divErrFFrom").html("From Date should not be empty");
            showErrorSnackbar("From Date should not be empty");
        }
        if ($("#dtpFTo").val() == "") {
            IsValid = false;
            $("#divErrFTo").html("To Date should not be empty");
            showErrorSnackbar("To Date should not be empty");
        } 
        if (IsValid) {
            TableUserData.draw().clear(); TableTransactions.draw().clear(); TableTransData.draw().clear();
            GetData(2, $("#cmbUsers").val(), $("#cmbTrans").val());
        }
    });

    $('#tblUserData tbody').on('click', 'tr', function () {
        rowdata = TableUserData.row($(this)).data();
        if(!rowdata) return;
        var UID = rowdata[0];
        $("#txtHUserID").val(UID);
        GetData(3, UID, $("#cmbTrans").val());
        $(this).addClass('selected').siblings().removeClass('selected');
    });

    $('#tblTransactions tbody').on('click', 'tr', function () {
        rowdata = TableTransactions.row($(this)).data();
        if(!rowdata) return;
        var UID = $("#txtHUserID").val();
        var TID = rowdata[0];
        $("#txtHFormID").val(TID);
        $("#lblPopupheading").text(rowdata[1]);
        GetData(4, UID, TID);
        $(this).addClass('selected').siblings().removeClass('selected');
    });

    $('#tblTransData tbody').on('click', 'tr', function () {
        rowdata = TableTransData.row($(this)).data();
        if(!rowdata) return;
        var UID = $("#txtHUserID").val();
        var TID = $("#txtHFormID").val();
        var ID = rowdata[0]
        $("#txtHID").val(ID);
        GetData(5, UID, TID, ID);
        $(this).addClass('selected').siblings().removeClass('selected');
    });
</script>
