@model ShineWeb.Models.SingleMasterModel
@{
    ViewBag.Title = ViewData["FormName"];
}
<link href="~/Content/bootstrap.min.css" rel="stylesheet" />
<link href="~/Content/dataTables.bootstrap.min.css" rel="stylesheet" />
<link href="~/Content/navbar.css" rel="stylesheet" />
<link href="~/Content/buttonTop.css" rel="stylesheet" />
<link href="~/Content/dataTables.dataTables.2.2.2.css" rel="stylesheet" />
@*<link rel="stylesheet" href="~/Content/jquery-ui.css">*@

@*<script src="~/Scripts/bootstrap.min.js"></script>
    <script src="~/Scripts/jquery-1.10.2.min.js"></script>*@
<script src="~/Scripts/jquery-1.11.1.min.js"></script>
<script src="~/Scripts/bootstrap_3.3.7.min.js"></script>
<script src="~/Scripts/jquery-3.7.1.js"></script>
<script src="~/Scripts/jquery-ui.js"></script>
@*<script src="~/Scripts/datatable.js"></script>*@
<script src="~/Scripts/dataTables.2.2.2.js"></script>
<script src="~/Scripts/js/refreshtoken.js"></script>

<header>
    <link rel="stylesheet" href="~/Content/index.css">
</header>
<style>
        .gdInput {
            width: 100%;
            height: 25px;
            border-width: 0 0 0.1px 0;
            border-color: #e0d6d6;
        }

            .gdInput:disabled {
                width: 100%;
                height: 25px;
                border-width: 0 0 0 0;
                background-color: #fff;
                font-weight: bold;
            }
        /* .each {
            border-bottom: 1px solid #555;
            padding: 3px 0;
        }

        .acItem .name {
            font-size: 14px;
            font-family: Arial, Helvetica, sans-serif;
        }

        .acItem .desc {
            font-size: 10px;
            font-family: Arial, Helvetica, sans-serif;
            color: #555;
        }

        .ui-autocomplete {
            max-height: 245px;
            overflow-y: auto;
            overflow-x: hidden;
        }
    */
        th, td {
            white-space: nowrap;
        }

        .trtext-line {
            border: none;
            border-bottom: 1px #000000;
        }

        div.dataTables_wrapper {
            width: 100%;
            margin: 0 auto;
        }

        td {
            font-size: 11px;
        }

        input[type=number] {
            text-align: right;
        }

            input[type=number]::placeholder {
                text-align: left;
            }
        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }

        .modalPaymode {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 10; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        /* Modal Content/Box */
        @@media only screen and (min-width: 600px) {
            .modalPaymode-content {
                background-color: #ffffff;
                margin: 3% auto; /* 15% from the top and centered */
                padding: 1px;
                border: 1px solid #888;
                width: 50%; /* Could be more or less, depending on screen size */
                height: 50%;
                top: 1%;
                overflow: auto;
            }
        }

        @@media only screen and (max-width: 600px) {
            .modalPaymode-content {
                background-color: #ffffff;
                margin: 10% auto; /* 15% from the top and centered */
                padding: 25px;
                border: 1px solid #888;
                width: 95%; /* Could be more or less, depending on screen size */
                height: 80%;
                top: 20%;
                overflow: auto;
            }
        }
        /* The Close Button */
        .closePaymode {
            color: #aaa;
            float: right;
            font-size: 10px;
            font-weight: bold;
        }

            .closePaymode:hover,
            .closePaymode:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            }

        /* Style the tab */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

            /* Style the buttons inside the tab */
            .tab button {
                background-color: inherit;
                float: left;
                border: none;
                outline: none;
                cursor: pointer;
                padding: 14px 16px;
                transition: 0.5s;
                font-size: 17px;
            }

                /* Change background color of buttons on hover */
                .tab button:hover {
                    background-color: #ddd;
                }

                /* Create an active/current tablink class */
                .tab button.active {
                    background-color: #ccc;
                }

        /* Style the tab content */
        .tabcontent {
            display: none;
            /*padding: 6px 12px;*/
            border: none;
            border-top: none;
        }

        .form-label {
            position: relative;
            display: block;
            clear: both;
            max-width: 500px;
            margin: 0 auto;
        }

        .labelup {
            -webkit-transform: translateY(50%);
            -moz-transform: translateY(-50%);
            -ms-transform: translateY(-50%);
            -o-transform: translateY(-50%);
            transform: translateY(50%);
            -webkit-transition: all 0.2s ease-in-out;
            -moz-transition: all 0.2s ease-in-out;
            transition: all 0.2s ease-in-out;
            position: absolute;
            top: -40%;
            left: 1em;
            background: #fffefe;
            color: #2b2828;
            font-size: 1em;
            cursor: text;
            pointer-events: none;
            font-family: sans-serif;
        }

        .labelupfortextarea {
            -webkit-transform: translateY(50%);
            -moz-transform: translateY(-50%);
            -ms-transform: translateY(-50%);
            -o-transform: translateY(-50%);
            transform: translateY(50%);
            -webkit-transition: all 0.2s ease-in-out;
            -moz-transition: all 0.2s ease-in-out;
            transition: all 0.2s ease-in-out;
            position: absolute;
            top: -18%;
            left: 1em;
            background: #fffefe;
            color: #2b2828;
            font-size: 1em;
            cursor: text;
            pointer-events: none;
            font-family: sans-serif;
        }

        .footerAction {
            position: fixed;
            right: 0;
            bottom: 0;
            width: 85%;
            color: white;
            background-color: azure;
        }
        /*input:focus + .labelup,
        input:not(:placeholder-shown) + .labelup, textarea:focus + .labelup, textarea:not(:placeholder-shown) + .labelup {
            top: -35%;
            font-size: .9em;
            padding: 0 .3em;
            background: #F9F9F9;
            color: #000000;
        }*/
        .clsProd {
            position: fixed;
            right: 1%;
            bottom: 8%;
            width: 30%;
            height: 45%;
            color: black;
            background-color: #c2f6b5;
            z-index: 1000;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 35px;
            height: 18px;
        }

            .switch input {
                opacity: 0;
                width: 0;
                height: 10px;
            }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #fb7708;
            -webkit-transition: .4s;
            transition: .4s;
        }

            .slider:before {
                position: absolute;
                content: "";
                height: 15px;
                width: 15px;
                left: 2px;
                bottom: 2px;
                background-color: white;
                -webkit-transition: .4s;
                transition: .4s;
            }

        input:checked + .slider {
            background-color: #2964ef;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(15px);
            -ms-transform: translateX(15px);
            transform: translateX(15px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }

            .slider.round:before {
                border-radius: 50%;
            }
        /* tfoot > tr > th{
            text-align: right !important;
        }*/
</style>
<style>
    /* Align dropdown in DataTable cell */
    .action-dropdown {
        min-width: 100px;
        font-size: 12px;
        z-index: 9999;
        text-align: left;
    }

        /* Optional: Add hover effect */
        .action-dropdown > li > a {
            padding: 3px 12px;
            color: #333;
            text-decoration: none;
        }

            .action-dropdown > li > a:hover {
                background-color: #f5f5f5;
                color: #000;
            }

    /* Optional: Make dropdown button minimal */
    .dropdown-toggle {
        background-color: transparent !important;
        border: none !important;
        font-size: 15px;
        line-height: 1;
        padding: 2px 5px;
    }

        .dropdown-toggle::after {
            display: none;
        }
</style>
<body>

    @Html.HiddenFor(model => model.Add, new { @autocomplete = "off", @class = "form-control", @id = "txtAddID" })
    @Html.HiddenFor(model => model.Modify, new { @autocomplete = "off", @class = "form-control", @id = "txtModifyID" })
    @Html.HiddenFor(model => model.View, new { @autocomplete = "off", @class = "form-control", @id = "txtViewID" })
    @Html.HiddenFor(model => model.Cancel, new { @autocomplete = "off", @class = "form-control", @id = "txtCancelID" })
    @Html.HiddenFor(model => model.FormName, new { @autocomplete = "off", @class = "form-control", @id = "txtFormName" })
    @Html.HiddenFor(model => model.ID, new { @autocomplete = "off", @class = "form-control FormclrField", @id = "txtID" })
    @Html.HiddenFor(model => model.TransType, new { @autocomplete = "off", @class = "form-control", @id = "txtTransType" })
    @Html.HiddenFor(model => model.FormID, new { @autocomplete = "off", @class = "form-control", @id = "txtFormID" })
    <input hidden id="txtCustomerID" />
    <input hidden id="txtBAdd1" /><input hidden id="txtBAdd2" /><input hidden id="txtBAdd3" />
    <input hidden id="txtSAdd1" /><input hidden id="txtSAdd2" /><input hidden id="txtSAdd3" />
    <input hidden id="txtPincode" />

    <input hidden id="txtSAdd1" /><input hidden id="txtSAdd2" /><input hidden id="txtSAdd3" />
    <input hidden id="txtPincode" /><input hidden id="txtStatus" />
    <label id="lblName" hidden> </label>
    <label id="lblMob1" hidden></label>
    <label id="lblGSTIN" hidden></label>
    <h4 id="MainHeading">@ViewData["FormName"]</h4>

    <div class="toastBox"></div>

    <div id="dvDocuments">
        <div style="width:100%;">
            <table class="table" width="100%">
                <tr>
                    <td>
                        <button id="btnAdd" class="btn btn-info"><span class="glyphicon glyphicon-plus" style="color: white"></span>&#x2009;Add</button>
                    </td>
                    <td align="right" width="65%">
                        <table>
                            <tr>
                                <td hidden>
                                    <span class="form-label">
                                        <select class="form-control FormfilterclrField" id="cmbFilterBranch"><option value="0">Select Branch</option></select>
                                        <label class="labelup"> Branch </label>
                                    </span>
                                </td>
                                <td style="border:none">
                                    <span class="form-label">
                                        <input class="form-control FormfilterclrField" type="text" id="txtFilterParty" placeholder="">
                                        <label class="labelup"> Party</label>
                                    </span>
                                    <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrFParty" class="clrdivs"></div>
                                </td>
                                <td style="border:none">
                                    <select class="gdInput" id="cmbFilterDatetype" onchange="SetFilterDate();"></select>
                                </td>
                                <td style="border:none">
                                    <span class="form-label">
                                        <input class="form-control FormfilterclrField" type="date" id="dtpFFrom" placeholder="" oninput="javascript: if (this.value > this.max) { this.value = this.max; }">
                                        <label class="labelup"> From</label>
                                    </span>
                                    <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrFFrom" class="clrdivs"></div>
                                </td>
                                <td style="border:none">

                                    <span class="form-label">
                                        <input class="form-control FormfilterclrField" type="date" id="dtpFTo" placeholder="" oninput="javascript: if (this.value > this.max) { this.value = this.max; }">
                                        <label class="labelup"> To</label>
                                    </span>
                                    <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrFTo" class="clrdivs"></div>
                                </td>
                                <td style="border:none">
                                    <input style="font-size:14px;" class="FormfilterclrField" type="checkbox" id="chkShowAll">
                                    <label for="chkShowAll" style="font-size:14px;">All Status</label>
                                </td>
                                <td style="border:none">
                                    <button id="btnFilter" class="btn btn-primary"><span class="glyphicon glyphicon-export" style="color: white"></span>&#x2009;Filter</button>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>

        </div>
        @*<button id="btnLoadDraft" class="btn btn-primary"><span class="glyphicon glyphicon-download-alt	" style="color: white"></span>&#x2009;Load Draft Data</button>*@


        <table class="table table-bordered" id="tblMasterData" width="100%">
            <thead>
                <tr class="trclrforcolheader">
                    <th style="text-align:center;font-size: 12px;width:0%;">ID</th>
                    <th style="text-align:center;font-size: 12px;width:0%;">StatusID</th>
                    <th style="text-align:center;font-size: 12px;width:10%;">Doc ID</th>
                    <th style="text-align:center;font-size: 12px;width:10%;">Date</th>
                    <th style="text-align:center;font-size: 12px;width:12%;">Ref No</th>
                    <th style="text-align:center;font-size: 12px;width:20%;">Party Name</th>
                    <th style="text-align:center;font-size: 12px;width:10%;">Payment Mode</th>
                    <th style="text-align:center;font-size: 12px;width:10%;">Amount</th>
                    <th style="text-align:center;font-size: 12px;width:10%;">Balance</th>
                    <th style="text-align:center;font-size: 12px;width:9%;">Status</th>
                    <th style="text-align:center;font-size: 12px;width:6%;">User</th>
                    <th style="text-align:center;font-size: 12px;width:3%;" title="View">
                        <span class="glyphicon glyphicon-eye-open" style="font-size:16px">
                        </span>
                    </th>
                    <th style="text-align:center;font-size: 12px;width:3%;" title="Edit">
                        <span class="glyphicon glyphicon-pencil" style="font-size:16px">
                        </span>
                    </th>
                    @*<th style="text-align:center;font-size: 12px;width:3%;" title="Edit">
                            <span class="glyphicon glyphicon-pencil" style="font-size:16px">
                            </span>
                        </th>
                        <th style="text-align:center;font-size: 12px;width:3%;" title="Cancel">
                            <span class="glyphicon glyphicon-remove-circle" style="font-size:16px">
                            </span>
                        </th>
                        <th style="text-align:center;font-size: 12px;width:3%;" title="View">
                            <span class="glyphicon glyphicon-eye-open" style="font-size:16px">
                            </span>
                        </th>*@
                </tr>
            </thead>
        </table>
    </div>

    <div id="dvMain">
        <hr />
        <div class="row">
            <div id="dvCollection">
                <div class="col-sm-12 col-md-12 col-lg-12">
                    <div class="col-sm-12 col-md-4 col-lg-4">
                        <table width="100%">
                            <tr hidden>
                                <td style="border:none;" colspan="2">
                                    <div>
                                        <input type="radio" name="searchtype" id="rdoPartywise" checked="checked" />
                                        <label for="rdoPartywise" style="font-size:15px">Party</label>&ensp;&ensp;
                                        <input type="radio" name="searchtype" id="rdoDocwise" />
                                        <label for="rdoDocwise" style="font-size:15px">Document No</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2" align="left" style="padding-bottom:10px;">
                                    <label style="font-size:15px">Party </label>&ensp;
                                    <label class="switch">
                                        <input type="checkbox" id="chkPartyorDocNo">
                                        <span class="slider round"></span>
                                    </label>&ensp;
                                    <label style="font-size:15px">Document No</label>
                                </td>
                            </tr>
                            <tr class="bgclrfortr" id="trSearchDocID">
                                <td style="border:none;" colspan="2">
                                    <div>
                                        <span class="form-label">
                                            <input class="form-control FormclrField" type="number" id="txtSearchDocID" placeholder="">
                                            <label class="labelup"> Doc ID</label>
                                        </span>
                                    </div>
                                    <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrSearchDocID" class="clrdivs"></div>
                                </td>
                            </tr>
                            <tr class="bgclrfortr" id="trBeat">
                                <td style="border:none;">
                                    <div>
                                        <span class="form-label">
                                            <select class="form-control FormclrcmbField" id="cmbBeat"><option value="0">Select</option></select>
                                            <label class="labelup"> Beat</label>
                                        </span>
                                        <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrBeat" class="clrdivs"></div>
                                    </div>
                                </td>
                                <td style="border:none;">
                                    <div>
                                        <span class="form-label">
                                            <select class="form-control FormclrcmbField" id="cmbSalesman"><option value="0">Select</option></select>
                                            <label class="labelup"> Salesman</label>
                                        </span>
                                        <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrSalesman" class="clrdivs"></div>
                                    </div>
                                </td>
                            </tr>
                            <tr class="bgclrfortr">
                                <td style="border:none;" colspan="2">
                                    <div class="input-group">
                                        <span class="form-label">
                                            <input class="form-control FormclrField" type="text" id="txtSearch" placeholder="">
                                            <label class="labelup"> Select *</label>
                                        </span>
                                        <span id="VendInfo" class="input-group-addon"><span class="glyphicon glyphicon-info-sign" style="background-color:white;"></span></span>
                                    </div>
                                    <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrSearch" class="clrdivs"></div>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-sm-12 col-md-4 col-lg-4">
                        <table width="100%">
                            @*<tr class="bgclrfortr" hidden>
                                    <td style="border:none;" colspan="2">
                                        <span class="form-label">
                                            <select class="form-control FormclrcmbField" id="cmbBranch" hidden><option value="0">Select Branch</option></select>
                                            <label class="labelup"> Branch *</label>
                                        </span>
                                        <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrBranch" class="clrdivs"></div>

                                    </td>
                                </tr>*@
                            <tr>
                                <td style="border:none;">
                                    <span class="form-label">
                                        <select class="form-control FormclrcmbField" id="cmbPaymode"><option value="0">Select Paymode</option></select>
                                        <label class="labelup"> Payment Mode*</label>
                                    </span>
                                    <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrPaymode" class="clrdivs"></div>
                                </td>
                                <td style="border:none;">
                                    <span class="form-label">
                                        <input class="form-control FormclrField txtsettag" txttag="0" type="number" id="txtAmount" placeholder="">
                                        <label class="labelup"> Amount</label>
                                    </span>
                                    <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrAmount" class="clrdivs"></div>
                                </td>
                            </tr>
                            <tr>
                                <td style="border:none;">
                                    <div>
                                        <label>Balance : </label><label id="lblBalance" style="font-size:14px;font-weight:600;padding-left:10px;">0.00</label>
                                    </div>
                                </td>
                                <td style="border:none;">
                                    <div>
                                        <span class="form-label">
                                            <input class="form-control FormclrField" type="text" id="txtRefNo" placeholder="">
                                            <label class="labelup"> Ref No</label>
                                        </span>
                                        <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrRefNo" class="clrdivs"></div>
                                    </div>
                                </td>
                            </tr>
                            <tr id="trVisa">
                                <td style="border:none;">
                                    <span class="form-label">
                                        <input class="form-control FormclrField txtsettag" txttag="0" type="number" id="txtVisaPern" placeholder="">
                                        <label class="labelup"> Visa %</label>
                                    </span>
                                    <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrVisaPern" class="clrdivs"></div>
                                </td>
                                <td style="border:none;">
                                    <span class="form-label">
                                        <input class="form-control FormclrField txtsettag" txttag="0" type="number" id="txtVisaAmt" placeholder="">
                                        <label class="labelup"> Visa Amount</label>
                                    </span>
                                    <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrVisaAmt" class="clrdivs"></div>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-sm-12 col-md-4 col-lg-4">
                        <table width="100%">
                            <tr>
                                <td style="border:none;">
                                    <label style="font-size:14px">Doc ID : </label><label id="lblDocID" style="font-size:14px">INV/2425/001</label>
                                </td>
                                <td style="border:none;">
                                    <div>
                                        <span class="form-label">
                                            <input class="form-control FormclrField" type="date" id="dtpDate" oninput="javascript: if (this.value > this.max) { this.value = this.max; }" />
                                            <label class="labelup">Date *</label>
                                        </span>
                                        <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrDate" class="clrdivs"></div>
                                    </div>
                                </td>
                            </tr>
                            @*<tr hidden>
                                    <td style="border:none;" colspan="2">
                                        <div>
                                            <span class="form-label">
                                                <select class="form-control FormclrcmbField" id="cmbUDN"><option value="0">Select UDN</option></select>
                                                <label class="labelup">UDN</label>
                                            </span>
                                            <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrorOnCode" class="clrdivs"></div>
                                        </div>
                                    </td>
                                </tr>*@
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div>
            <div class="row">
                <hr />
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <table width="100%">
                        <tr>
                            <td style="border:none;" width="20%">
                                <div class="toggle">
                                    <input type="radio" name="sizeBy" id="rdoAdvanceData" />
                                    <label for="rdoAdvanceData" id="lblrdoAdv">Payable <label for="rdoAdvanceData" id="lblAdvDocCount"></label></label>
                                    <input type="radio" name="sizeBy" id="rdoOSData" checked="checked" />
                                    <label for="rdoOSData" id="lblrdoOS">Receivable <label for="rdoOSData" id="lblOSDocCount"></label></label>
                                </div>
                            </td>
                            <td style="border:none;" width="20%">
                            </td>
                            <td style="border:none;" width="12%">
                                <span class="form-label">
                                    <input id="txtHDClosingBalance" hidden />
                                    <input class="form-control FormclrField" type="text" id="txtClosingBalance" placeholder="" style="align-content:flex-end">
                                    <label class="labelup">Closing Balance</label>
                                </span>
                                <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrClosingBalance" class="clrdivs"></div>
                            </td>
                            <td style="border:none;" width="12%">
                                <span class="form-label">
                                    <input class="form-control FormclrField txtsettag" type="number" id="txtTotAdjustmentAmount" txttag="0" placeholder="">
                                    <label class="labelup">Adjustment Amount</label>
                                </span>
                                <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrTotAdjustmentAmount" class="clrdivs"></div>
                            </td>
                            <td style="border:none;" width="12%">
                                <span class="form-label">
                                    <input class="form-control FormclrField txtsettag" type="number" id="txtAdjustedAmount" txttag="0" placeholder="">
                                    <label class="labelup">Adjused Amount</label>
                                </span>
                                <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrAdjustedAmount" class="clrdivs"></div>
                            </td>
                            <td style="border:none;" width="12%">
                                <span class="form-label">
                                    <input class="form-control FormclrField txtsettag" type="number" txttag="0" id="txtRemainingAmount" placeholder="">
                                    <label class="labelup">Remaining Amount</label>
                                </span>
                                <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrRemainingAmount" class="clrdivs"></div>
                            </td>
                            <td style="border:none;" width="12%">
                                <span class="form-label">
                                    <input class="form-control FormclrField txtsettag" type="text" txttag="0" id="txtBalance" placeholder="">
                                    <label class="labelup">Balance</label>
                                </span>
                                <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrBalance" class="clrdivs"></div>
                            </td>
                        </tr>
                    </table>
                    <div id="dvGrid1" align="center">
                        <table class="table table-bordered row-border order-column" id="tblGridoneData" width="100%">
                            <thead>
                                <tr>
                                    <th style="text-align:center;font-size: 12px;width:0%;" class="trclrforcolheader">ID</th>
                                    <th style="text-align:center;font-size: 12px;width:0%;" class="trclrforcolheader">DocPrefix</th>
                                    <th style="text-align:center;font-size: 12px;width:0%;" class="trclrforcolheader">FAID</th>
                                    <th style="text-align:center;font-size: 12px;width:0%;" class="trclrforcolheader">InvDocVal</th>
                                    <th style="text-align:center;font-size: 12px;width:2%;" class="trclrforcolheader">#</th>
                                    <th style="text-align:center;font-size: 12px;width:10%; padding-right:10px;" class="trclrforcolheader">Doc ID</th>
                                    <th style="text-align:center;font-size: 12px;width:10%; padding-right: 1px;" class="trclrforcolheader">Date</th>
                                    <th style="text-align:center;font-size: 12px;width:25%; padding-right: 25px;" class="trclrforcolheader">Ref No</th>
                                    <th style="text-align:center;font-size: 12px;width:20%; padding-right: 20px;" class="trclrforcolheader">Doc Type</th>
                                    <th style="text-align:center;font-size: 12px;width:10%; padding-right: 1px;" class="trclrforcolheader">Doc Value</th>
                                    <th style="text-align:center;font-size: 12px;width:10%; padding-right: 1px;" class="trclrforcolheader">Outstandings</th>
                                    <th style="text-align:center;font-size: 12px;width:13%; padding-right: 30px;" class="trclrforcolheader">Adj Amt</th>
                                </tr>
                            </thead>
                            <tfoot>
                                <tr>
                                    <th colspan="10"></th>
                                    <th>
                                        <label id="lblG1TotalBalance" lbltag="0" class="lblsettag">
                                            0.00
                                        </label>
                                    </th>
                                    <th>
                                        <label id="lblG1AdjAmt" lbltag="0" class="lblsettag">
                                            0.00
                                        </label>
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div id="dvGrid2" align="center">
                        <table class="table table-bordered row-border order-column" id="tblGridtwoData" width="100%">
                            <thead>
                                <tr>
                                    <th style="text-align:center;font-size: 12px;width:0%;" class="trclrforcolheader">ID</th>
                                    <th style="text-align:center;font-size: 12px;width:0%;" class="trclrforcolheader">DocPrefix</th>
                                    <th style="text-align:center;font-size: 12px;width:0%;" class="trclrforcolheader">FAID</th>
                                    <th style="text-align:center;font-size: 12px;width:0%;" class="trclrforcolheader">InvDocVal</th>
                                    <th style="text-align:center;font-size: 12px;width:2%;" class="trclrforcolheader">#</th>
                                    <th style="text-align:center;font-size: 12px;width:15%;" class="trclrforcolheader">Doc ID</th>
                                    <th style="text-align: center; font-size: 12px; width: 8%; padding-right: 5px;" class="trclrforcolheader">Date</th>
                                    <th style="text-align: center; font-size: 12px; width: 8%; padding-right: 40px;" class="trclrforcolheader">Ref No</th>
                                    <th style="text-align: center; font-size: 12px; width: 15%; padding-right: 45px;" class="trclrforcolheader">Doc Type</th>
                                    <th style="text-align: center; font-size: 12px; width: 8%; padding-right: 20px;" class="trclrforcolheader">Doc Value</th>
                                    <th style="text-align: center; font-size: 12px; width: 8%; padding-right: 20px;" class="trclrforcolheader">Outstandings</th>
                                    <th style="text-align: center; font-size: 12px; width: 14%; padding-right: 30px;" class="trclrforcolheader">Coll Amt</th>
                                    <th style="text-align: center; font-size: 12px; width: 8%; padding-right: 1px;" class="trclrforcolheader">Adj Amt(+/-)</th>
                                    <th style="text-align: center; font-size: 12px; width: 4%; padding-right: 1px;" class="trclrforcolheader">Disc %/₹</th>
                                    <th style="text-align: center; font-size: 12px; width: 8%; padding-right: 1px;" class="trclrforcolheader">Full Adj</th>
                                    <th style="text-align: center; font-size: 12px; width: 12%; padding-right: 15px;" class="trclrforcolheader">Total Amt Adj</th>
                                    <th style="text-align: center; font-size: 12px; width: 10%; padding-right: 15px;" class="trclrforcolheader">Balance</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="10"></th>
                                    <th style="text-align: right;">
                                        <label id="lblG2TotalOS" lbltag="0" class="lblsettag">
                                            0.00
                                        </label>
                                    </th>
                                    <th style="text-align: right;">
                                        <label id="lblG2CollAmt" lbltag="0" class="lblsettag">
                                            0.00
                                        </label>
                                    </th>
                                    <th>
                                        <label id="lblG2AdjAmt" lbltag="0" class="lblsettag">
                                            0.00
                                        </label>
                                    </th>
                                    <th>
                                        <label id="lblG2DiscAmt" lbltag="0" class="lblsettag">
                                            0.00
                                        </label>
                                    </th>
                                    <th>
                                        <label id="lblG2WriteoffAmt" lbltag="0" class="lblsettag">
                                            0.00
                                        </label>
                                    </th>
                                    <th>
                                        <label id="lblG2TotAdjAmt" lbltag="0" class="lblsettag">
                                            0.00
                                        </label>
                                    </th>
                                    <th>
                                        <label id="lblG2Balance" lbltag="0" class="lblsettag">
                                            0.00
                                        </label>
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            <div class="rows" style="padding-bottom:100px;">
                <div class="col-sm-12 col-md-3 col-lg-3"></div>
                <div class="col-sm-12 col-md-3 col-lg-3"></div>
                <div class="col-sm-12 col-md-3 col-lg-3">
                    <table width="100%">
                        <tr class="bgclrfortr">
                            <td style="border:none;" colspan="2">
                                <div>
                                    <span class="form-label">
                                        <input class="form-control FormclrField" type="text" id="txtRemarks" placeholder="">
                                        <label class="labelup">Remarks</label>
                                    </span>
                                    <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrRemarks" class="clrdivs"></div>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="col-sm-12 col-md-3 col-lg-3">
                    <table width="100%">
                        <tr class="bgclrfortr">
                            <td style="border:none;" colspan="2">
                                <div>
                                    <span class="form-label">
                                        <textarea class="form-control FormclrField" rows="3" id="txtNarration"></textarea>
                                        <label class="labelupfortextarea">Narration</label>
                                    </span>
                                    <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrNarration" class="clrdivs"></div>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            @*<button id="btnProdAdd" class="btn btn-info"><span class="glyphicon glyphicon-plus" style="color: white"></span>&#x2009;Add</button>*@
        </div>

        <div class="footerAction modal-footer">
            <!--<div style="padding-right:20px" align="right">-->
            @*<button id="btnChkPM">Check PM</button>*@
            @*<button type="button" class="btn clrforpdf" id="btnPDF"><i class='fa-regular fa-file-pdf' style='color:white'></i> PDF</button>
                <button type="button" class="btn clrforpreview" id="btnPreview"><span class="glyphicon glyphicon-print"> Preview</span></button>*@
            <!--<button type="button" class="btn btn-danger" id="btnClear"><span class="glyphicon glyphicon-refresh"> Clear</span></button>
                <button type="button" class="btn btn-success" id="btnSave"><span class="glyphicon glyphicon-saved"> Save</span></button>
                <button type="button" class="btn btn-warning" id="btnClose"><span class="glyphicon glyphicon-remove"> Close</span></button>
            </div>-->
            <table width="100%">
                <tr>
                    <td width="15%" align="left" style="padding-left:20px">
                        <div>
                            <span class="form-label">
                                <select class="form-control" id="cmbPrintProfile"><option value="0">Select</option></select>
                                <label class="labelup"> Print Profile</label>
                            </span>
                            <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrPrintProfile" class="clrdivs"></div>
                        </div>
                    </td>
                    <td style="border:none;" width="5%">
                        <div>
                            <span class="form-label">
                                <input id="txtNoofCopies" class="form-control" value="1" />
                                <label class="labelup">Copies</label>
                            </span>
                            <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrPrintProfile" class="clrdivs"></div>
                        </div>
                    </td>

                    <td width="80%" align="right">
                        <div style="padding-right:20px" align="right">
                            <button type="button" class="btn" id="btnWhatsapp" style="background-color:green;color:white"><i class='fa-brands fa-whatsapp' style='color:white'></i> Whatsapp</button>
                            <button type="button" class="btn clrforpdf" id="btnEmail"><span class="glyphicon glyphicon-envelope"> Mail</span></button>
                            <button type="button" class="btn clrforpdf" id="btnPDF"><i class='fa-regular fa-file-pdf' style='color:white'></i> PDF</button>
                            <button type="button" class="btn btn-primary" id="btnPreview"><span class="glyphicon glyphicon-print"> Preview</span></button>
                            <button type="button" class="btn clrforpreview" id="btnPrint"><span class="glyphicon glyphicon-print"> Print</span></button>
                            <button type="button" class="btn btn-danger" id="btnClear"><span class="glyphicon glyphicon-refresh"> Clear</span></button>
                            <button type="button" class="btn btn-success" id="btnSave"><span class="glyphicon glyphicon-saved"> Save</span></button>
                            <button type="button" class="btn btn-warning" id="btnClose"><span class="glyphicon glyphicon-remove"> Close</span></button>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div class="modalPaymode" id="myModalPayment">
        <div class="modal-dialog" style="width:auto;">
            <div class="modalPaymode-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <button type="button" class="closePaymode">&times;</button>
                    <h5 class="modal-title" style="color:black"><b>Payment Mode : </b><label id="lblSelPaymode"></label></h5>

                    @*<hr />*@
                </div>
                <!-- Modal body -->
                <div class="modal-body">
                    <div style="padding-top: 1px; width: 100%;">
                        <div class="col-sm-12 col-md-6 col-lg-6">
                            <table width="100%">
                                <tr>
                                    <td colspan="2">
                                        <div id="dvcmbfrom">
                                            <span class="form-label">
                                                <select tabindex="5" class="form-control FormclrcmbField" id="cmbFromAccount"><option value="0">Select</option></select>
                                                <label class="labelup">Account No *</label>
                                            </span>
                                        </div>
                                        <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrFromAccount" class="clrdivs"></div>

                                        <div>
                                            <label>Balance : </label><label id="lblBankAccBalance" style="font-size:14px;font-weight:600;padding-left:10px;">0.00</label>
                                        </div>
                                    </td>
                                </tr>

                                <tr id="trBTMode">
                                    <td colspan="2">
                                        <div>
                                            <span class="form-label">
                                                <select tabindex="5" class="form-control FormclrcmbField" id="cmbBTMode"><option value="0">Select</option></select>
                                                <label class="labelup">Transfer Mode</label>
                                            </span>
                                        </div>
                                        <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrBTMode" class="clrdivs"></div>
                                    </td>
                                </tr>
                                <tr id="trNEFT">
                                    <td style="border:none;" colspan="2">
                                        <div>
                                            <span class="form-label">

                                                <input class="form-control FormclrField" type="text" step="any" id="txtNEFT" placeholder="">
                                                <label class="labelup">Cheque/Ref No</label>
                                            </span>
                                            <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrNEFT" class="clrdivs"></div>
                                        </div>
                                    </td>
                                </tr>
                                <tr id="trChqNo">
                                    <td style="border:none;" colspan="2">
                                        <div>
                                            <span class="form-label">
                                                <select tabindex="5" class="form-control FormclrcmbField" id="cmbChequeNo"><option value="0">Select</option></select>
                                                <label class="labelup">Cheque No</label>
                                            </span>
                                            <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrChequeNo" class="clrdivs"></div>
                                        </div>
                                    </td>
                                </tr>

                                <tr id="trChqDate">
                                    <td style="border:none;" colspan="2">
                                        <div>
                                            <span class="form-label">
                                                <input class="form-control FormclrField" type="date" step="any" id="dtpChequeDate" placeholder="">
                                                <label class="labelup">Cheque Date</label>
                                            </span>
                                            <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrChequeDate" class="clrdivs"></div>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>

                        <div class="col-sm-12 col-md-6 col-lg-6">
                            <table width="100%">
                                <tr>
                                    <td colspan="2">
                                        <div>
                                            <span class="form-label">
                                                @*<input class="form-control FormclrField" type="number" step="any" id="txtBankName" placeholder="">*@
                                                <select class="form-control FormclrcmbField" id="cmbBankName"><option value="0">Select</option></select>
                                                <label class="labelup">Bank Name</label>
                                            </span>
                                        </div>
                                        <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrBankName" class="clrdivs"></div>
                                    </td>
                                <tr>
                                    <td style="border:none;" colspan="2">
                                        <div>
                                            <span class="form-label">
                                                <input class="form-control FormclrField" type="text" step="any" id="txtBranchName" placeholder="">
                                                <label class="labelup">Branch Name</label>
                                            </span>
                                            <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrBranchName" class="clrdivs"></div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="border:none;" colspan="2">
                                        <div>
                                            <span class="form-label">
                                                <input class="form-control FormclrField" type="text" step="any" id="txtIFSC" placeholder="">
                                                <label class="labelup">IFSC Code</label>
                                            </span>
                                            <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrIFSC" class="clrdivs"></div>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <span class="form-label">

                    </span>
                </div>

                <!-- Modal footer -->
                <div class="modal-footer" style="background-color:skyblue">
                    <div style="padding-top:0px" align="right">

                        <button type="button" class="btn btn-danger" id="btnPaymentClear"><span class="glyphicon glyphicon-refresh"> Clear</span></button>
                        <button type="button" class="btn btn-success" id="btnPaymentAccept"><span class="glyphicon glyphicon-saved"> Accept</span></button>
                        <button type="button" class="btn btn-warning" id="btnPaymentClose"><span class="glyphicon glyphicon-remove"> Close</span></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
  

</body>


<script type="text/javascript">
    //document.body.style.zoom = "85%";
    $("#txtDocID").prop("disabled", true);
    //dvDocuments,
    $("#dvMain").hide();
    $(".FormBtField").prop("disabled", true);
    //<tr class="trclrforcolheader">
    //    <th style="text-align:center;font-size: 12px;width:0%;">ID</th>0
    //    <th style="text-align:center;font-size: 12px;width:10%;">Doc ID</th>1
    //    <th style="text-align:center;font-size: 12px;width:10%;">Date</th>2
    //    <th style="text-align:center;font-size: 12px;width:12%;">Ref No</th>3
    //    <th style="text-align:center;font-size: 12px;width:20%;">Party Name</th>4
    //    <th style="text-align:center;font-size: 12px;width:10%;">Payment Mode</th>5
    //    <th style="text-align:center;font-size: 12px;width:10%;">Amount</th>6
    //    <th style="text-align:center;font-size: 12px;width:10%;">Balance</th>7
    //    <th style="text-align:center;font-size: 12px;width:9%;">Status</th>8
    //    <th style="text-align:center;font-size: 12px;width:3%;" title="Edit">
    //        <span class="glyphicon glyphicon-pencil" style="font-size:16px">10
    //        </span>
    //    </th>
    //    <th style="text-align:center;font-size: 12px;width:3%;" title="Cancel">
    //        <span class="glyphicon glyphicon-remove-circle" style="font-size:16px">11
    //        </span>
    //    </th>
    //    <th style="text-align:center;font-size: 12px;width:3%;" title="View">
    //        <span class="glyphicon glyphicon-eye-open" style="font-size:16px">12
    //        </span>
    //    </th>
    //</tr>
    var Table = $('#tblMasterData').DataTable({pageLength: ItemsperPage,lengthMenu: [[10, 20, 50, 100, -1], [10, 20, 50, 100, "All"]],
        "bFilter": true,
        "bSearchable": true,
        "bInfo": true,
        "bPaginate": true,
        "ordering": true,
        scrollY: "400px",
        scrollX: true,
        scrollCollapse: true,
        "columnDefs": [{ "targets": [0,1], "visible": false, searchable: false }, { "targets": [5], "width": "10%" }, { "targets": [4], "width": "22%" }, { "targets": [5], "width": "8%" }, { "targets": [11, 9, 10], "class": "text-center" }],
    });

    var TableGrid1Data = $('#tblGridoneData').DataTable({
        paging: false,
        searching: false,
        info: false,
        ordering: true,
        scrollY: "250px",
        scrollX: true,
        scrollCollapse: true,
        "columnDefs": [{ "targets": [0, 1, 2,3], "visible": false, searchable: false, ordering: false }, { "targets": [4], "class": "text-center" }
            , { "targets": [7], "width": "25%" }, { "targets": [8], "width": "20%" }, { "targets": [9], "class": "text-right", "width": "13%" }]
    });
    var TableGridtwoData = $('#tblGridtwoData').DataTable({
        paging: false,
        searching: false,
        info: false,
        ordering: true,
        scrollY: "250px",
        scrollX: true,
        scrollCollapse: true,
        "columnDefs": [{ "targets": [0, 1, 2, 3], "visible": false, searchable: false, ordering: false }, { "targets": [4], "class": "text-center" },
        { "targets": [7], "width": "10%" }, { "targets": [8], "width": "10%" }, { "targets": [12], "width": "6%" }, { "targets": [13], "width": "7%" }
            , { "targets": [14], "width": "8%" }, { "targets": [14], "width": "8%" }]
    });

    //dvGrid1,dvGrid2,rdoAdvanceData,rdoOSData
    $("#dvGrid1").hide();
    $("#rdoOSData").click(function () {
        $("#dvGrid2").show();
        $("#dvGrid1").hide();
    });
    $("#rdoAdvanceData").click(function () {
        $("#dvGrid1").show();
        $("#dvGrid2").hide();
    });
    //$("#VendInfo").hide();
    $("#VendInfo").click(function () {
        if ($("#txtCustomerID").val() != "") {
            var vinfo = "<u>Code :</u> " + $("#lblName").text() + "<br/><u>Mob No</u> : " + $("#lblMob1").text() + "<br/>" + "<u>GSTIN</u> : " + $("#lblGSTIN").text() + "<br/><br/>";
            vinfo += "<u>Billing Address :</u><br/>" + $("#txtBAdd1").val() + "<br/>" + $("#txtBAdd2").val() + "<br/>" + $("#txtBAdd3").val() + "<br/><br/>";
            vinfo += "<u>Shipping Address :</u><br/>" + $("#txtSAdd1").val() + "<br/>" + $("#txtSAdd2").val() + "<br/>" + $("#txtSAdd3").val() + "<br/><br/>";
            vinfo += "<u>Pincode : </u>" + $("#txtPincode").val();
            InfoDialogMsg(vinfo, 'Party Info');

        } else {
            showErrorSnackbar("Select Party");
        }
    });
    var modalPayment = document.getElementById("myModalPayment");
    var spanPayment = document.getElementsByClassName("closePaymode")[0];
    spanPayment.onclick = function () {
        modalPayment.style.display = "none";
    }
    $('#btnPaymentClose').click(function (e) {
        modalPayment.style.display = "none";
    });
    $("#btnChkPM").click(function (e) {
        modalPayment.style.display = "block";
        PaymodeConfig();
    });

    //rdoPartywise,rdoDocwise

    //document.getElementById('VendInfo').remove();
    var nDocPrefix = $("#txtFormID").val();
    var UID = '@Session["LoginUserID"]';
    var Aurl = '@Session["APIurl"]';
    var DecVal = '@Session["DecimalValues"]';
    var DefBranch = '@Session["DefaultBranch"]';
    var ConfigRoundtype = '@Session["RoundoffType"]';
    var ConfigRoundvalue = '@Session["RoundoffValue"]';
    var ConfigWriteoffAmt = '@Session["WriteoffAmt"]';
    var VisaPern = '@Session["VisaPern"]';
    var BatchMode = 0; // 0 - New product, 1 - Edit Product
    var nTransMode = 1, nIsDraft = 0;
    var PrintTransID = nDocPrefix == 19 ? 8 : 9, PrintConfigID = 0;
    setDate("dtpDate", 0);
    setDate("dtpFFrom", 0);
    setDate("dtpFTo", 0);

    setTimeout(function () {
        GetFilterData();
    }, 800);
    GetData(1);

if ($("#txtAddID").val() == 0) {
    $("#trAdd").hide();
    $("#btnAdd").hide();
}

if ($("#txtReurnPricePerm").val() == 0) {
    $("#trRetPrice").hide();
    }
    GetPrintProfile(PrintTransID);
    function GetPrintProfile(nTransID) {
        $.ajax({
            url: Aurl + "printprofileconfig/getprofile",
            type: 'get',
            contentType: 'json',
            data: { TransID: nTransID },
            xhrFields: {
                withCredentials: true
            },
            async: false,
            success: function (data) {
                $('#cmbPrintProfile').find("option").remove();
                $('#cmbPrintProfile').append($('<option/>', {
                    value: 0,
                    text: "-- Select --",
                }));
                var lstdata = eval(data)
                var getdef = lstdata.filter(pr => pr.DefaultConfig == 1);
                var defid = getdef.length > 0 ? getdef[0].ConfigID : 0;
                $.each(lstdata, function (i, items) {
                    $('#cmbPrintProfile').append($('<option/>', {
                        value: items.ConfigID,
                        text: items.ConfigName, 'data-automail': items.AutoMail
                    }));
                    $('#cmbPrintProfile').val(defid);
                    PrintConfigID = defid;
                });
            }
        });
    }
//18 - payment, 19 - collection
    if (nDocPrefix == 19) {
        $("#trBeat,#trSalesman").show();
        $("#trSearchDocID").hide();
        $("#lblrdoAdv").text("Payable");
        $("#lblrdoOS").text("Receivable");

    } else {
        $("#trBeat,#trSalesman").hide();
        $("#trSearchDocID").hide();
        $("#lblrdoAdv").text("Receivable");
        $("#lblrdoOS").text("Payable");
    }

    function PaymodeConfig() {
        $("#trBTMode,#trNEFT,#trChqNo,#trChqDate").hide();
        $("#cmbBankName,#txtBranchName,#txtIFSC").prop("disabled", true);
        var PMID = $("#cmbPaymode").val();
        if (nDocPrefix == 19) {//COLLECTION
            if (PMID == "2" || PMID == "3") // CHEQUE & DD
            {
                $("#cmbBankName,#txtBranchName,#txtIFSC").prop("disabled", false);
                $("#trNEFT,#trChqDate").show();
            }
            else {
                $("#trNEFT").show();
                $("#cmbBankName,#txtBranchName,#txtIFSC").prop("disabled", true);
            }
        }
        else {//PAYMENT
            if (PMID == "2" || PMID == "3") // CHEQUE & DD
            {
                $("#trChqDate,#trChqNo").show();
            }
            else {
                $("#trNEFT").show();
            }
        }
    }
    $("#chkPartyorDocNo").click(function (e) {
        var ischk = $("#chkPartyorDocNo").is(":checked");// false - partywise, true - doc no wise
        if (ischk) {
            if (nDocPrefix == 19) {
                $("#trBeat,#trSalesman").hide();
                $("#trSearchDocID").show();
            } else {
                $("#trBeat,#trSalesman").hide();
                $("#trSearchDocID").show();
            }
        }
        else {
            if (nDocPrefix == 19) {
                $("#trBeat,#trSalesman").show();
                $("#trSearchDocID").hide();
            } else {
                $("#trBeat,#trSalesman").hide();
                $("#trSearchDocID").hide();
            }
        }
        ClearForm();
    });
    $("#rdoPartywise").click(function () {
        if (nDocPrefix == 19) {
            $("#trBeat,#trSalesman").show();
            $("#trSearchDocID").hide();
        } else {
            $("#trBeat,#trSalesman").hide();
            $("#trSearchDocID").hide();
        }
        ClearForm();
    });
    $("#rdoDocwise").click(function () {
        if (nDocPrefix == 19) {
            $("#trBeat,#trSalesman").hide();
            $("#trSearchDocID").show();
        } else {
            $("#trBeat,#trSalesman").hide();
            $("#trSearchDocID").show();
        }
        ClearForm();
    });
    $("#btnAdd").click(function () {
        //dvDocuments,
        nTransMode = 1;
        $("#dvMain").show();
        $("#dvDocuments").hide();
        ClearForm();
    })
    $("#btnClose").click(function () {
        //dvDocuments,
        if (ClosecfFocus != 3) { CloseConfirmDialogMsg("Do you want to close?"); } else { CloseForm(); }
    });
    function CloseForm() {
        var rdo1 = $("#rdoMainTableData").is(":checked");
        //var rdo2 = $("#rdoDraftTableData").is(":checked");
        $("#dvMain").hide();
        $("#dvDocuments").show();
        $("#MainHeading").text($("#txtFormName").val());
        //GetData(rdo1 ? 6 : 10);
        GetFilterData();
    }

    $('input[type=number]').focusin(function (e) {
        $(this).select();
    });
    function SetTagZero() {
        var inputs = $(".txtsettag");
        for (var i = 0; i < inputs.length; i++) {
            var field = $(inputs[i]);
            var FID = field[0].id;
            if (FID != "")
                updateInputColumn(FID, 0);
        }
        inputs = $(".lblsettag");
        for (var i = 0; i < inputs.length; i++) {
            var field = $(inputs[i]);
            var FID = field[0].id;
            if (FID != "") {
                updateLabelColumn(FID, 0);
            }
        }
    }
    function updateLabelColumn(labelID, netValue) {
        //const label = document.getElementById(`dgvProdGross${rowId}`);
        const label = document.getElementById(labelID);
        label.setAttribute('lbltag', netValue.toFixed(4));
        label.innerText = netValue.toFixed(DecVal);
        label.title = netValue.toFixed(4);
    }
    function updateInputColumn(inputID, netValue) {
        //const label = document.getElementById(`dgvProdGross${rowId}`);
        const input = document.getElementById(inputID);
        var value = netValue != "" ? netValue : 0;
        input.setAttribute('txttag', parseFloat(value).toFixed(4));
        input.value = parseFloat(value).toFixed(DecVal);
        input.title = netValue;
    }
    $(".txtsettag").focusin(function (e) {
        var id = e.target.id;
        const val = document.getElementById(id).getAttribute("txttag");
        $("#" + id).val(val);
        $("#" + id).select();
        txtValuechanged = false;
    });
    $(".txtsettag").blur(function (e) {
        var val = e.target.value;
        var id = e.target.id;
        if (id == "txtTradeDiscPern") {
            console.log("3. Tr Disc : " + val);
        }
        if (!txtValuechanged)
            updateInputColumn(id, val);
    });
    $('#tblGridoneData tbody').on('focusin', 'td>.txtsettag', function (e) {
        // .clsdgvTag
        var id = e.target.id;
        var name = e.target.name;
        var value = e.target.value;
        //getTagValue(id, name);
        const val = document.getElementById(id).getAttribute("txttag");
        $("#" + id).val(val);
        $("#" + id).select();
        ProdGridChange = false;
    });
    var ProdGridChange = false;
    $('#tblGridoneData tbody').on('blur', 'td>.txtsettag', function (e) {
        // .clsdgvTag
        var id = e.target.id;
        var name = e.target.name;
        var value = e.target.value;
        //setTagValue(id, name, value);
        if (!ProdGridChange) {
            updateInputColumn(id, e.target.value);
        }
        //CalculateBatchGrid();
    });

    //$('#tblGridoneData tbody').on('dblclick', 'td>.lblHeaderBal', function (e) {
    //    var tg = e.target;
    //    var id = e.target.id;
    //    var collamt = parseFloat(document.getElementById("txtAmount").getAttribute("txttag"));
    //    var val = document.getElementById(id).getAttribute("lbltag");
    //    var refid = document.getElementById(id).getAttribute("refadjid");
    //    updateInputColumn(refid, val);
    //    calculateGrid1Value();
    //});
    $('#tblGridtwoData tbody').on('focusin', 'td>.txtsettag', function (e) {
        // .clsdgvTag
        var id = e.target.id;
        var name = e.target.name;
        var value = e.target.value;
        //getTagValue(id, name);
        const val = document.getElementById(id).getAttribute("txttag");
        $("#" + id).val(val);
        $("#" + id).select();
        ProdGridChange = false;
    });

    $('#tblGridtwoData tbody').on('blur', 'td>.txtsettag', function (e) {
        // .clsdgvTag
        var id = e.target.id;
        var name = e.target.name;
        var value = e.target.value;
        //setTagValue(id, name, value);
        if (!ProdGridChange) {
            updateInputColumn(id, e.target.value);
        }
        //CalculateBatchGrid();
    });

    //$('#tblGridtwoData tbody').on('dblclick', 'td>.lblFooterBal', function (e) {
    //    var tg = e.target;
    //    var id = e.target.id;
    //        var val = document.getElementById(id).getAttribute("lbltag");
    //        var refid = document.getElementById(id).getAttribute("refadjid");
    //        updateInputColumn(refid, val);
    //        calculateGrid2Value();
    //});
    //GetData(2, DefBranch, $("#dtpDate").val());
    $("#cmbBranch,#dtpDate").change(function (e) {
        ("#btnClear").click();
    });
    var BatchRID = 0, ProductRID = 0;

    function Scrolltoid(id) {
        //window.scrollTo(id[0].offsetLeft, id[0].offsetTop);
        window.scrollTo({ left: 0, top: document.body.scrollHeight, behavior: "smooth" });
    }
    function calculateGrid1Value() {
        var dAdjAmt = 0;
        $("#tblGridoneData tbody tr").each(function () {
            $(this).find("input").each(function (index) {
                const fieldName = $(this).attr("name");
                const fieldID = $(this).attr("id");
                if (fieldName == "AdjCollAmtHeader") {
                    dAdjAmt += parseFloat($(this).attr('txttag'));
                }
            });
        });
        updateLabelColumn("lblG1AdjAmt", dAdjAmt);
        var collamt = parseFloat(document.getElementById("txtAmount").getAttribute("txttag"));
        var AlreadyAdjamt = parseFloat(document.getElementById("txtAdjustedAmount").getAttribute("txttag"));
        updateInputColumn("txtTotAdjustmentAmount", dAdjAmt + collamt);
        var remAmt = ((dAdjAmt + collamt) - AlreadyAdjamt)
        ///updateInputColumn("txtRemainingAmount", remAmt);
        CalculateAdjustvalues();
    }

    $("#txtAmount").change(function (e) {
        txtValuechanged = true;
        var id = e.target.id;
        var val = (e.target.value != "") ? e.target.value : 0;
        var name = e.target.name;
        updateInputColumn(id, val);
        calculateGrid1Value();
        var clsbl = $("#txtHDClosingBalance").val() != "" ? parseFloat($("#txtHDClosingBalance").val()) : 0;
        console.log("Cls Bal : ", clsbl);
        var bal = 0;
        if (nDocPrefix == 19)//collection
            bal = (clsbl) - parseFloat(val);
        else
            bal = (clsbl) + parseFloat(val);
        console.log("After amount Bal : ", bal);
        var crdr = bal >= 0 ? "Dr" : "Cr";
        var clb = parseFloat(Math.abs(bal)).toFixed(DecVal);
        console.log("Final Bal : ", clb);
        $("#txtBalance").val(clb.toString() + " " + crdr);
        //updateInputColumn("txtBalance", Math.abs(bal))
        $("#txtBalance").css("color", bal > 0  ? "Red" : "Green");
        var PMID = $("#cmbPaymode").val();
        if (PMID == 5) {
            var VisPen = parseFloat(document.getElementById("txtVisaPern").getAttribute("txttag"));
            var CollAmt = parseFloat(val);
            var dVisaAmt = CollAmt +((parseFloat(VisPen) * CollAmt) / 100);
            updateInputColumn("txtVisaAmt", dVisaAmt);
        }
    });
    $("#txtVisaPern").change(function (e) {
        var val = e.target.value;
        var PMID = $("#cmbPaymode").val();
        if (PMID == 5) {
            var collamt = parseFloat(document.getElementById("txtAmount").getAttribute("txttag"));
            var dVisaAmt = collamt + (parseFloat(val) * CollAmt) / 100;
            updateInputColumn("txtVisaAmt", dVisaAmt);
        }
    });
    $("#txtVisaAmt").change(function (e) {
        var val = e.target.value;
        var PMID = $("#cmbPaymode").val();
        if (PMID == 5) {
            var collamt = parseFloat(document.getElementById("txtAmount").getAttribute("txttag"));
            var dVisaP = (parseFloat(val) / CollAmt) * 100;
            updateInputColumn("txtVisaPern", dVisaP);
        }
    });
    function calculateGrid2Value_old() {
        //lblG1AdjAmt
        var G1AdjAmt = parseFloat(document.getElementById("lblG1AdjAmt").getAttribute("lbltag"));
        var orgcollamt = parseFloat(document.getElementById("txtAmount").getAttribute("txttag"));
        var PMID = $("#cmbPaymode").val();
        var dAdjAmt = 0, dTotalAdjAmt = 0;
        $("#tblGridtwoData tbody tr").each(function () {
            var CurrRowIndex = TableGridtwoData.row($(this)).index();
            var CollAmt = 0, AdjAmtPM = 0, DiscPern = 0, DiscAmt = 0, Balance = 0, dTAA = 0,dWriteoff = 0;
            $(this).find("label").each(function (index) {
                const fieldName = $(this).attr("name");
                const fieldID = $(this).attr("id");
                if (fieldName == "G2OS") {
                    Balance = parseFloat($(this).attr('lbltag'));
                }
            })
            $(this).find("input").each(function (index) {
                const fieldName = $(this).attr("name");
                const fieldID = $(this).attr("id");
                if (fieldName == "AdjCollAmtFooter") {
                    var val = parseFloat($(this).attr('txttag'));
                    var maxval = parseFloat($(this).attr('max'));
                    var dAvaAdjAmt = parseFloat(document.getElementById("txtTotAdjustmentAmount").getAttribute("txttag"));
                    var dTotRemAmt = parseFloat(document.getElementById("txtRemainingAmount").getAttribute("txttag"));
                    console.log("Adj upto : ", dAvaAdjAmt, " Rem Amt : ", dTotRemAmt, " val : ", val);
                    if (val > maxval) {
                        dAdjAmt += 0;
                        CollAmt = 0;
                        updateInputColumn(fieldID, 0);
                        showErrorSnackbar("Collect Amount should be less than Balance");
                    } else {
                        //if (dTotRemAmt >= val) {
                        if (PMID == 9)//Note Adj
                        {
                            dAdjAmt += val;
                            CollAmt = parseFloat(val);
                        }
                        else {
                            if (val > (orgcollamt + G1AdjAmt)) {//check with header colltion amount + G1 Adj Amt
                                dAdjAmt += 0;
                                CollAmt = 0;
                                updateInputColumn(fieldID, 0);
                                showErrorSnackbar("Amount should be less than Given Collection Amount");
                            }
                            else {
                                if (val > dTotRemAmt) {//check with Remaining amount
                                    dAdjAmt += 0;
                                    CollAmt = 0;
                                    updateInputColumn(fieldID, 0);
                                    showErrorSnackbar("Amount should be less than Remaining Amount");
                                } else {
                                    dAdjAmt += val;
                                    CollAmt = parseFloat(val);
                                }
                            }
                        }
                        //}
                        //else {
                        //    if (CurrRowIndex == nGrid2CurrentRowIndex) {
                        //        CollAmt = 0;
                        //        updateInputColumn(fieldID, 0);
                        //        showErrorSnackbar("Collect Amount should be less than Remaining Amount");
                        //    }
                        //}
                    }
                }
                else if (fieldName == "AdjAmt") {
                    if (CollAmt > 0) {
                        AdjAmtPM = parseFloat($(this).attr('txttag'));
                    } else{
                        updateInputColumn(fieldID, 0);
                        AdjAmtPM = 0;
                    }
                    
                }
                else if (fieldName == "AdjDiscPern") {
                    //DiscPern = parseFloat($(this).attr('txttag'));
                    if (CollAmt > 0) {
                        var disval = parseFloat($(this).attr('txttag'));
                        var calpern = (disval * Balance) / 100;
                        var adjamtinminus = AdjAmtPM >= 0 ? 0 : AdjAmtPM;
                        var sum = CollAmt + calpern - adjamtinminus;
                        if (Balance >= sum) {
                            DiscPern = disval;
                        } else {
                            if (nTransMode == "1" || nTransMode == 2) {
                                showErrorSnackbar("Amount mismatched");
                            }
                            updateInputColumn(fieldID, 0);
                            DiscPern = 0;
                        }
                    }
                    else {
                        updateInputColumn(fieldID, 0);
                        DiscPern = 0;
                    }
                }
                else if (fieldName == "AdjDiscAmt") {
                    //DiscAmt = parseFloat($(this).attr('txttag'));
                    if (CollAmt > 0) {
                        var disval = parseFloat($(this).attr('txttag'));
                        var adjamtinminus = AdjAmtPM >= 0 ? 0 : AdjAmtPM;
                        var sum = CollAmt + disval - adjamtinminus;
                        if (Balance >= sum) {
                            updateInputColumn(fieldID, disval);
                            DiscAmt = disval;
                        } else {
                            if (nTransMode == "1" || nTransMode == 2) {
                                showErrorSnackbar("Amount mismatched");
                            }
                            updateInputColumn(fieldID, 0);
                            DiscAmt = 0;
                        }
                    }
                    else {
                        updateInputColumn(fieldID, 0);
                        DiscAmt = 0;
                    }
                }
            });
            $(this).find("label").each(function (index) {
                const fieldName = $(this).attr("name");
                const fieldID = $(this).attr("id");
                if (fieldName == "WriteoffAmt") {
                    if (CollAmt > 0) {
                        dWriteoff = parseFloat($(this).attr('lbltag'));
                    }
                    else {
                        updateLabelColumn(fieldID, 0);
                        dWriteoff = 0;
                    }
                }
                if (fieldName == "G2TotalAdjAmount") {
                    var PMAdjamt = AdjAmtPM > 0 ? 0 : Math.abs(AdjAmtPM);
                    var totadj = CollAmt + DiscAmt + PMAdjamt + dWriteoff
                    updateLabelColumn(fieldID, totadj);
                    dTotalAdjAmt += totadj;
                    dTAA = totadj;
                }
                if (fieldName == "G2Balance") {
                    //if (CollAmt > 0) {
                    //    var val = parseFloat(Balance - dTAA);
                    //    updateLabelColumn(fieldID, val);
                    //} else {
                    //    updateLabelColumn(fieldID, 0);
                    //}
                    var val = nTransMode == 5 || nTransMode == 4 ? 0 : parseFloat(Balance - dTAA);
                    updateLabelColumn(fieldID, val);
                }
            });
        });
        //updateLabelColumn("lblG2CollAmt", dAdjAmt);
        //updateLabelColumn("lblG2TotAdjAmt", dTotalAdjAmt);
        SumG2FooterLabels();
        updateInputColumn("txtAdjustedAmount", dTotalAdjAmt);
        console.log("Tot Adj Amt : ", parseFloat(document.getElementById("txtTotAdjustmentAmount").getAttribute("txttag")));
        console.log("Adj Amt : ", dTotalAdjAmt);
        var remamt = parseFloat(document.getElementById("txtTotAdjustmentAmount").getAttribute("txttag")) - dTotalAdjAmt;
        updateInputColumn("txtRemainingAmount", remamt);
    }
    function calculateGrid2Value() {

        const G1AdjAmt = getTag("#lblG1AdjAmt", "lbltag");
        const orgCollAmt = getTag("#txtAmount", "txttag");
        const PMID = $("#cmbPaymode").val();

        let dAdjAmt = 0, dTotalAdjAmt = 0;

        $("#tblGridtwoData tbody tr").each(function () {

            const $r = $(this);
            const idx = TableGridtwoData.row($r).index();

            // Read all values
            let Balance = getTagEl($r, "label[name='G2OS']");
            let CollAmt = getTagEl($r, "input[name='AdjCollAmtFooter']");
            let AdjAmtPM = getTagEl($r, "input[name='AdjAmt']");
            let DiscPern = getTagEl($r, "input[name='AdjDiscPern']");
            let DiscAmt = getTagEl($r, "input[name='AdjDiscAmt']");
            let Writeoff = getTagEl($r, "label[name='WriteoffAmt']");

            let dWriteoff = 0;
            let dTAA = 0;
            console.log("CollAmt : ", CollAmt);
            // ----- Validate Collection Amount -----
            if (CollAmt) {
                let maxval = getMaxEl($r, "input[name='AdjCollAmtFooter']");
                let remAmt = getTag("#txtRemainingAmount", "txttag");
                let totAdj = getTag("#txtTotAdjustmentAmount", "txttag");
                console.log("remAmt : ", remAmt);
                if (CollAmt > maxval) {
                    CollAmt = resetInput($r, "input[name='AdjCollAmtFooter']", "Collect Amount should be less than Balance");
                }
                else if (PMID == 9) {
                    dAdjAmt += CollAmt;
                }
                else if (CollAmt > (orgCollAmt + G1AdjAmt)) {
                    CollAmt = resetInput($r, "input[name='AdjCollAmtFooter']", "Amount should be less than Given Collection Amount");
                }
                else if (CollAmt > remAmt) {
                    CollAmt = resetInput($r, "input[name='AdjCollAmtFooter']", "Amount should be less than Remaining Amount");
                }
                else {
                    dAdjAmt += CollAmt;
                }
            }

            // ----- Validate AdjAmt -----
            if (CollAmt > 0) {
                AdjAmtPM = AdjAmtPM || 0;
            } else {
                AdjAmtPM = resetInput($r, "input[name='AdjAmt']", "");
            }

            // ----- Discount % -----
            if (CollAmt > 0) {
                let calDisc = (DiscPern * Balance) / 100;
                let minusAdj = AdjAmtPM >= 0 ? 0 : AdjAmtPM;

                if (Balance < (CollAmt + calDisc - minusAdj)) {
                    DiscPern = resetInput($r, "input[name='AdjDiscPern']", "Amount mismatched");
                }
            } else {
                DiscPern = resetInput($r, "input[name='AdjDiscPern']", "");
            }

            // ----- Discount Amount -----
            if (CollAmt > 0) {
                let minusAdj = AdjAmtPM >= 0 ? 0 : AdjAmtPM;

                if (Balance < (CollAmt + DiscAmt - minusAdj)) {
                    DiscAmt = resetInput($r, "input[name='AdjDiscAmt']", "Amount mismatched");
                }
            } else {
                DiscAmt = resetInput($r, "input[name='AdjDiscAmt']", "");
            }

            // ----- Writeoff -----
            dWriteoff = CollAmt > 0 ? Writeoff : resetLbl($r, "label[name='WriteoffAmt']");

            // ----- Total Adjustment -----
            let PMAdj = AdjAmtPM > 0 ? 0 : Math.abs(AdjAmtPM);
            let totAdj = CollAmt + DiscAmt + PMAdj + dWriteoff;

            updateLbl($r, "label[name='G2TotalAdjAmount']", totAdj);
            dTotalAdjAmt += totAdj;

            // ----- Balance -----
            let newBal = (nTransMode == 4 || nTransMode == 5) ? 0 : (Balance - totAdj);
            updateLbl($r, "label[name='G2Balance']", newBal);

        });

        // ----- Footer updates -----
        SumG2FooterLabels();
        updateInputColumn("txtAdjustedAmount", dTotalAdjAmt);

        let remaining = getTag("#txtTotAdjustmentAmount", "txttag") - dTotalAdjAmt;
        updateInputColumn("txtRemainingAmount", remaining);
    }
    function getTag(selector, attr) {
        return parseFloat($(selector).attr(attr)) || 0;
    }

    function getTagEl($row, selector) {
        return parseFloat($row.find(selector).attr("txttag") || $row.find(selector).attr("lbltag")) || 0;
    }

    function getMaxEl($row, selector) {
        return parseFloat($row.find(selector).attr("max")) || 0;
    }

    function resetInput($row, selector, msg) {
        if (msg) showErrorSnackbar(msg);
        let id = $row.find(selector).attr("id");
        updateInputColumn(id, 0);
        return 0;
    }

    function resetLbl($row, selector) {
        let id = $row.find(selector).attr("id");
        updateLabelColumn(id, 0);
        return 0;
    }

    function updateLbl($row, selector, val) {
        let id = $row.find(selector).attr("id");
        updateLabelColumn(id, val);
    }


    var nGrid1CurrentRowIndex = -1;
    $('#tblGridoneData tbody').on('focusin', 'tr', function () {
        nGrid1CurrentRowIndex = TableGrid1Data.row(this).index()
    });
    var nGrid2CurrentRowIndex = -1;
    $('#tblGridtwoData tbody').on('focusin', 'tr', function () {
        nGrid2CurrentRowIndex = TableGridtwoData.row(this).index()
    });

    $('#tblGridoneData tbody').on('change', '.AdjCollAmtHeader', function (e) {
        var id = e.target.id;
        var val = e.target.value;
        var name = e.target.name;
        ProdGridChange = true;
        updateInputColumn(id, val);
        calculateGrid1Value();
    });
    $('#tblGridoneData tbody').on('keydown', '.AdjCollAmtHeader', function (e) {
        var kyc = e.keyCode;
        var val = e.target.value;
        if (kyc == "32") {
            var currrowdata = TableGrid1Data.row(nGrid1CurrentRowIndex).data();
            var CurrRowDocID = currrowdata[0];
            $("#tblGridoneData tbody tr").each(function () {
                var CollAmt = 0, AdjAmtPM = 0, DiscPern = 0, DiscAmt = 0, Balance = 0;
                var rowData = TableGrid1Data.row($(this)).data();
                var RowDocID = rowData[0];
                if (CurrRowDocID == RowDocID) {
                    $(this).find("label").each(function (index) {
                        const fieldName = $(this).attr("name");
                        const fieldID = $(this).attr("id");
                        if (fieldName == "G1Balance") {
                            Balance = parseFloat($(this).attr('lbltag'));
                        }
                    })
                    $(this).find("input").each(function (index) {
                        const fieldName = $(this).attr("name");
                        const fieldID = $(this).attr("id");
                        if (fieldName == "AdjCollAmtHeader") {
                            updateInputColumn(fieldID, Balance);
                        }
                    });
                }
            });
            calculateGrid1Value();
        }
    });
    function G2Sumvalue(RowIndex) {
        var dAdjAmt = 0, dTotalAdjAmt = 0;
        $("#tblGridtwoData tbody tr").each(function () {
            var CurrRowIndex = TableGridtwoData.row($(this)).index();
            if (RowIndex != CurrRowIndex) {
                $(this).find("label").each(function (index) {
                    const fieldName = $(this).attr("name");
                    const fieldID = $(this).attr("id");
                    if (fieldName == "G2TotalAdjAmount") {
                        dTotalAdjAmt = dTotalAdjAmt + parseFloat($(this).attr("lbltag"));
                    }
                });
            }
        });
        return dTotalAdjAmt;
    }
    $('#tblGridtwoData tbody').on('keydown', '.AdjCollAmtFooter', function (e) {
        const key = e.keyCode;
        const isSpace = key === 32;
        const isCtrlSpace = key === 32 && e.ctrlKey;
        if (isSpace && !e.ctrlKey) {
            e.preventDefault();
            //showErrorSnackbar("Key Down Space Pressed, Value : " + val);
            var currrowdata = TableGridtwoData.row(nGrid2CurrentRowIndex).data();
            var CurrRowDocID = currrowdata[0];

            var dG1AdjAmt = parseFloat(document.getElementById("lblG1AdjAmt").getAttribute("lbltag"));//
            var dG2TotAdjAmt = G2Sumvalue(nGrid2CurrentRowIndex);
            var dCollAmt = parseFloat(document.getElementById("txtAmount").getAttribute("txttag"));

            var calcdiff = (dCollAmt + dG1AdjAmt - dG2TotAdjAmt)
            console.log("Amt : " + calcdiff);
            var dTotRemAmt = parseFloat(document.getElementById("txtRemainingAmount").getAttribute("txttag"));
            if (dTotRemAmt > 0) {
                var dAdjAmt = 0, dTotalAdjAmt = 0, fieldval = 0;
                $("#tblGridtwoData tbody tr").each(function () {
                    var CollAmt = 0, AdjAmtPM = 0, DiscPern = 0, DiscAmt = 0, Balance = 0;
                    var rowData = TableGridtwoData.row($(this)).data();
                    var RowDocID = rowData[0];
                    if (CurrRowDocID == RowDocID) {
                        $(this).find("label").each(function (index) {
                            const fieldName = $(this).attr("name");
                            const fieldID = $(this).attr("id");
                            if (fieldName == "G2OS") {
                                Balance = parseFloat($(this).attr('lbltag'));
                            }
                            if (fieldName == "WriteOff") {
                                updateLabelColumn(fieldID, 0);
                            }
                        })
                        $(this).find("input").each(function (index) {
                            const fieldName = $(this).attr("name");
                            const fieldID = $(this).attr("id");
                            if (fieldName == "AdjCollAmtFooter") {
                                //CollAmt = dTotRemAmt > Balance ? Balance : dTotRemAmt;
                                CollAmt = (dCollAmt + dG1AdjAmt - dG2TotAdjAmt) <= Balance ? (dCollAmt + dG1AdjAmt - dG2TotAdjAmt) : Balance;
                                fieldval = CollAmt;
                                updateInputColumn(fieldID, CollAmt);
                                //parseFloat($(this).attr('txttag'));
                            }
                            else if (fieldName == "AdjDiscPern") {
                                DiscPern = 0;
                                updateInputColumn(fieldID, 0);
                            }
                            else if (fieldName == "AdjDiscAmt") {
                                DiscAmt = 0;
                                updateInputColumn(fieldID, 0);
                            }
                            else if (fieldName == "AdjAmt") {
                                AdjAmtPM = 0;
                                updateInputColumn(fieldID, 0);
                            }
                        });
                        $(this).find("select").each(function (index) {
                            const fieldName = $(this).attr("name");
                            const fieldID = $(this).attr("id");
                            if (fieldName == "FullyAdj") {
                                $(this).val(0);
                            }
                        });
                    }
                });
                calculateGrid2Value();
                CalculateAdjustvalues();
            }
            else {
                showErrorSnackbar("Remaining Amount should be greater than zero");
            }
        }
        else if (isCtrlSpace) {
            e.preventDefault();
            const row = $(this).closest("tr");
            const rowData = TableGridtwoData.row(row).data();
            const currRowDocID = rowData[0];
            const $r = $(e.target).closest("tr");
            let Balance = getTagEl($r, "label[name='G2OS']");
            let CollAmt = getTagEl($r, "input[name='AdjCollAmtFooter']");
            let AdjAmtPM = getTagEl($r, "input[name='AdjAmt']");
            let DiscPern = getTagEl($r, "input[name='AdjDiscPern']");
            let DiscAmt = getTagEl($r, "input[name='AdjDiscAmt']");
            let Writeoff = getTagEl($r, "label[name='WriteoffAmt']");
            let G2RemBal = getTagEl($r, "label[name='G2Balance']");
            
            
            row.find("input").each(function () {
                const field = $(this);
                const name = field.attr("name");

                if (name === "AdjCollAmtFooter") {
                    //balance = parseFloat(field.attr("lbltag"));
                    updateInputColumn(field[0].id, G2RemBal)
                }
            });
            var totadj = G2RemBal + DiscAmt + Writeoff + (AdjAmtPM >= 0 ? 0 : Math.abs(AdjAmtPM));
            var newg2rembal = Balance - totadj;
            updateLbl($r, "label[name='G2TotalAdjAmount']", totadj);
            updateLbl($r, "label[name='G2Balance']", newg2rembal);
            //calculateGrid2Value();
            SumG2FooterLabels();
            setTimeout(() => {
                CalculateAdjustvalues();
            }, 500)
        }
    });
    $('#tblGridtwoData_test tbody').on('keydown', '.AdjCollAmtFooter', function (e) {

        const key = e.keyCode;
        const isSpace = key === 32;
        const isCtrlSpace = key === 32 && e.ctrlKey;

        if (isSpace) {
            e.preventDefault();
            //console.log("value ", e.target.value);
            //showErrorSnackbar("value : "+ e.target.value)

            // --- CURRENT ROW ---
            const row = $(this).closest("tr");
            const rowData = TableGridtwoData.row(row).data();
            const currRowDocID = rowData[0];
            
            // --- COMMON VALUES ---
            const dG1AdjAmt = parseFloat($("#lblG1AdjAmt").attr("lbltag"));
            const dCollAmt = parseFloat($("#txtAmount").attr("txttag"));
            const dTotRemAmt = parseFloat($("#txtRemainingAmount").attr("txttag"));
            const dG2TotAdjAmt = G2Sumvalue(nGrid2CurrentRowIndex);

            
            if (dTotRemAmt <= 0) {
                showErrorSnackbar("Remaining Amount should be greater than zero");
                return;
            }

            // Calculate available amount
            const diffAmt = dCollAmt + dG1AdjAmt - dG2TotAdjAmt;

            // --- PROCESS ONLY CURRENT ROW ---
            let balance = 0;

            // LABEL updates
            row.find("label").each(function () {
                const field = $(this);
                const name = field.attr("name");

                if (name === "G2OS") {
                    balance = parseFloat(field.attr("lbltag"));
                }

                if (name === "WriteOff") {
                    updateLabelColumn(field.attr("id"), 0);
                }
            });

            // INPUT updates
            row.find("input").each(function () {
                const field = $(this);
                const fieldID = field.attr("id");
                const name = field.attr("name");

                switch (name) {
                    case "AdjCollAmtFooter":
                        const collAmt = Math.min(diffAmt, balance);
                        updateInputColumn(fieldID, collAmt);
                        break;

                    case "AdjDiscPern":
                    case "AdjDiscAmt":
                    case "AdjAmt":
                        updateInputColumn(fieldID, 0);
                        break;
                }
            });
            
            // SELECT update
            row.find("select[name='FullyAdj']").val(0);
        }
        calculateGrid2Value();
        setTimeout(() => {
            CalculateAdjustvalues();
        }, 500)
    });

    $('#tblGridtwoData_older tbody').on('change', '.AdjCollAmtFooter', function (e) {//old method
        var dTotAdjAmt = parseFloat(document.getElementById("txtTotAdjustmentAmount").getAttribute("txttag"));
        var id = e.target.id;
        var val = e.target.value;
        var name = e.target.name;
        ProdGridChange = true;

        if (dTotAdjAmt > 0) {
            updateInputColumn(id, val);
            calculateGrid2Value();
            // const $row = $(this).closest("tr");
            CalculateAdjustvalues();
        } else {
            showErrorSnackbar("Adjustment Amount should be greater than zero");
            updateInputColumn(id, 0);
        }
    });
    $('#tblGridtwoData tbody').on('change', '.AdjCollAmtFooter', function (e) {

        var dTotAdjAmt = getTag("#txtTotAdjustmentAmount", "txttag");
        var id = e.target.id;
        var val = parseFloat(e.target.value) || 0;
        var name = e.target.name;
        ProdGridChange = true;

        if (dTotAdjAmt <= 0) {
            showErrorSnackbar("Adjustment Amount should be greater than zero");
            updateInputColumn(id, 0);
            return;
        }

        updateInputColumn(id, val);

        // -----------------------------------------
        // PROCESS ONLY CURRENT ROW
        // -----------------------------------------
        const $r = $(e.target).closest("tr");

        const G1AdjAmt = getTag("#lblG1AdjAmt", "lbltag");
        const orgCollAmt = getTag("#txtAmount", "txttag");
        const PMID = $("#cmbPaymode").val();

        let Balance = getTagEl($r, "label[name='G2OS']");
        let CollAmt = getTagEl($r, "input[name='AdjCollAmtFooter']");
        let AdjAmtPM = getTagEl($r, "input[name='AdjAmt']");
        let DiscPern = getTagEl($r, "input[name='AdjDiscPern']");
        let DiscAmt = getTagEl($r, "input[name='AdjDiscAmt']");
        let Writeoff = getTagEl($r, "label[name='WriteoffAmt']");

        let dWriteoff = 0;
        //

        
        // -----------------------------------------
        // VALIDATE COLLECTION AMOUNT
        // -----------------------------------------
        if (CollAmt > 0) {

            let maxval = getMaxEl($r, "input[name='AdjCollAmtFooter']");
            let remAmt = getTag("#txtRemainingAmount", "txttag");

            if (CollAmt > maxval) {
                CollAmt = resetInput($r, "input[name='AdjCollAmtFooter']", "Collect Amount should be less than Balance");
            }
            else if (PMID != 9 && CollAmt > (orgCollAmt + G1AdjAmt)) {
                CollAmt = resetInput($r, "input[name='AdjCollAmtFooter']", "Amount should be less than Given Collection Amount");
            }
            else if (CollAmt > remAmt) {
                CollAmt = resetInput($r, "input[name='AdjCollAmtFooter']", "Amount should be less than Remaining Amount");
            }
        } else {
            //showErrorSnackbar("Reset Disc % , ₹")
            // If collection is 0, reset related fields
            CollAmt = resetInput($r, "input[name='AdjCollAmtFooter']", "");
            AdjAmtPM = resetInput($r, "input[name='AdjAmt']", "");
            DiscPern = resetInput($r, "input[name='AdjDiscPern']", "");
            DiscAmt = resetInput($r, "input[name='AdjDiscAmt']", "");
            Writeoff = resetLbl($r, "label[name='WriteoffAmt']");
        }

        // -----------------------------------------
        // DISCOUNT VALIDATIONS
        // -----------------------------------------
        if (CollAmt > 0) {

            let minusAdj = AdjAmtPM >= 0 ? 0 : AdjAmtPM;

            // Discount %
            if (Balance < (CollAmt + (DiscPern * Balance) / 100 - minusAdj)) {
                DiscPern = resetInput($r, "input[name='AdjDiscPern']", "Amount mismatched");
            }

            // Discount Amount
            if (Balance < (CollAmt + DiscAmt - minusAdj)) {
                DiscAmt = resetInput($r, "input[name='AdjDiscAmt']", "Amount mismatched");
            }
            //showErrorSnackbar("Disc update");
        }

        // -----------------------------------------
        // TOTAL ADJUSTMENT CALCULATION
        // -----------------------------------------
        let PMAdj = AdjAmtPM > 0 ? 0 : Math.abs(AdjAmtPM);

        let totAdj = CollAmt + DiscAmt + PMAdj + dWriteoff;
        updateLbl($r, "label[name='G2TotalAdjAmount']", totAdj);

        // -----------------------------------------
        // CALCULATE NEW BALANCE
        // -----------------------------------------
        let newBal = (nTransMode == 4 || nTransMode == 5) ? 0 : (Balance - totAdj);

        updateLbl($r, "label[name='G2Balance']", newBal);

        // -----------------------------------------
        // FOOTER UPDATE
        // -----------------------------------------
        SumG2FooterLabels();
        setTimeout(() => {
            CalculateAdjustvalues();
        }, 500);
    });

    $('#tblGridtwoData tbody').on('change', '.AdjFooter', function (e) {

        ProdGridChange = true;

        const $row = $(this).closest("tr");
        console.log("Row data ", $row);
        const rowData = TableGridtwoData.row($row).data();
        const CurrRowDocID = rowData[0];

        const fieldVal = parseFloat(e.target.value || 0);
        const fieldId = e.target.id;

        updateInputColumn(fieldId, fieldVal);

        // ----------- Read required row fields --------------
        const Balance = parseFloat($row.find("label[name='G2OS']").attr("lbltag")) || 0;
        const CollAmt = parseFloat($row.find("input[name='AdjCollAmtFooter']").attr("txttag")) || 0;
        const DiscAmt = parseFloat($row.find("input[name='AdjDiscAmt']").attr("txttag")) || 0;

        let AdjAmtPM = 0;
        let dWriteoff = 0;

        // ----------- Validate and set AdjAmt --------------
        const $AdjAmt = $row.find("input[name='AdjAmt']");
        const adjId = $AdjAmt.attr("id");

        if (CollAmt <= 0) {
            showErrorSnackbar("Collected Amount should be greater than zero");
            updateInputColumn(adjId, 0);
        } else {

            const Val = fieldVal;

            // positive adjustment
            if (Val > 0 && Val <= Balance) {
                AdjAmtPM = Val;
                updateInputColumn(adjId, Val);
            }
            // negative adjustment
            else if (Val <= 0 && Balance >= (CollAmt + DiscAmt + Math.abs(Val))) {
                AdjAmtPM = Val;
                updateInputColumn(adjId, Val);
            }
            else {
                AdjAmtPM = 0;
                updateInputColumn(adjId, 0);
                showErrorSnackbar("Amount Mismatched");
            }
        }

        // ----------- Writeoff always zero --------------
        $row.find("label[name='WriteoffAmt']").each(function () {
            updateLabelColumn($(this).attr("id"), 0);
        });

        // ----------- Total Adjustment Calculation -------
        const PMAdj = AdjAmtPM > 0 ? 0 : Math.abs(AdjAmtPM);
        const totalAdj = CollAmt + DiscAmt + PMAdj + dWriteoff;

        $row.find("label[name='G2TotalAdjAmount']").each(function () {
            updateLabelColumn($(this).attr("id"), totalAdj);
        });

        // ----------- Update Balance for this row only ----
        const newBalance = Balance - totalAdj;

        $row.find("label[name='G2Balance']").each(function () {
            updateLabelColumn($(this).attr("id"), newBalance);
        });

        // ----------- Reset FullyAdj Dropdown ------------
        $row.find("select[name='FullyAdj']").val(0);

        // ----------- Update Footer Values ---------------
        SumG2FooterLabels();
        updateInputColumn("txtAdjustedAmount", totalAdj);

        // ----------- Recalculate totals -----------------
        CalculateAdjustvalues();
    });

    $('#tblGridtwoData tbody').on('change', '.AdjFooter_old', function (e) {
        var currrowdata = TableGridtwoData.row(nGrid2CurrentRowIndex).data();
        var CurrRowDocID = currrowdata[0];
        var dTotAdjAmt = parseFloat(document.getElementById("txtTotAdjustmentAmount").getAttribute("txttag"));
        var id = e.target.id;
        var fieldval = e.target.value;
        var name = e.target.name;
        ProdGridChange = true;
        updateInputColumn(id, fieldval);
        var dAdjAmt = 0, dTotalAdjAmt = 0;
        $("#tblGridtwoData tbody tr").each(function () {
            var CollAmt = 0, AdjAmtPM = 0, DiscPern = 0, DiscAmt = 0, Balance = 0, dTAA = 0, dWriteoff = 0;
            var rowData = TableGridtwoData.row($(this)).data();
            var RowDocID = rowData[0];
            $(this).find("label").each(function (index) {
                const fieldName = $(this).attr("name");
                const fieldID = $(this).attr("id");
                if (fieldName == "G2OS") {
                    Balance = parseFloat($(this).attr('lbltag'));
                }
            })
            if (CurrRowDocID == RowDocID) {

                $(this).find("input").each(function (index) {
                    const fieldName = $(this).attr("name");
                    const fieldID = $(this).attr("id");
                    if (fieldName == "AdjCollAmtFooter") {
                        CollAmt = parseFloat($(this).attr('txttag'));
                    }
                    else if (fieldName == "AdjDiscPern") {
                        DiscPern = parseFloat($(this).attr('txttag'));
                    }
                    else if (fieldName == "AdjDiscAmt") {
                        DiscAmt = parseFloat($(this).attr('txttag'));
                    }
                });
                $(this).find("input").each(function (index) {
                    const fieldName = $(this).attr("name");
                    const fieldID = $(this).attr("id");
                    if (fieldName == "AdjAmt") {
                        var Val = parseFloat(fieldval);
                        AdjAmtPM = parseFloat(0);
                        if (CollAmt > 0)
                        {
                            if (Val > 0)
                            {
                                if (Val <= Balance) {
                                    updateInputColumn(fieldID, Val);
                                    AdjAmtPM = parseFloat(Val);
                                }
                                else {
                                    updateInputColumn(fieldID, 0);
                                    showErrorSnackbar("Amount Mismatched");
                                }
                            }
                            else {
                                if (Balance >= (CollAmt + DiscAmt + Math.abs(Val)))
                                {
                                    updateInputColumn(fieldID, Val);
                                    AdjAmtPM = parseFloat(Val);
                                }
                                else
                                {
                                    updateInputColumn(fieldID, 0);
                                    showErrorSnackbar("Amount Mismatched");
                                }
                            }
                        }
                        else
                        {
                            showErrorSnackbar("Collected Amount should be greater than zero");
                            updateInputColumn(fieldID, 0);
                        }
                    }
                });
                $(this).find("label").each(function (index) {
                    const fieldName = $(this).attr("name");
                    const fieldID = $(this).attr("id");
                    if (fieldName == "WriteoffAmt") {
                        if (fieldName == "WriteoffAmt") {
                            //$(this).val(0);
                            dWriteoff = 0;// parseFloat($(this).attr('lbltag'));
                            updateLabelColumn(fieldID, 0);
                        }
                        //dWriteoff = parseFloat($(this).attr('lbltag'));
                    }
                    if (fieldName == "G2TotalAdjAmount") {
                        var PMAdjamt = AdjAmtPM > 0 ? 0 : Math.abs(AdjAmtPM);
                        var totadj = CollAmt + DiscAmt + PMAdjamt + dWriteoff;
                        updateLabelColumn(fieldID, totadj);
                        dTotalAdjAmt += totadj;
                        dTAA = totadj;
                    }
                    //if (fieldName == "G2Balance") {
                    //    var RemOS = Balance - dTAA;
                    //    updateLabelColumn(fieldID, RemOS);
                    //}
                });
                $(this).find("select").each(function (index) {
                    const fieldName = $(this).attr("name");
                    const fieldID = $(this).attr("id");
                    if (fieldName == "FullyAdj") {
                        $(this).val(0);
                    }
                });
            }
            $(this).find("label").each(function (index) {
                const fieldName = $(this).attr("name");
                const fieldID = $(this).attr("id");
                if (fieldName == "G2Balance") {
                    var RemOS = Balance - dTAA;
                    updateLabelColumn(fieldID, RemOS);
                }
            });
        });
        //calculateGrid2Value();
        SumG2FooterLabels();
        updateInputColumn("txtAdjustedAmount", dTotalAdjAmt);

        CalculateAdjustvalues();
    });
    function CalculateAdjustvalues() {
        var G1CollValue = getG1FooterSum(1);
        var HeaderCollAmt = parseFloat(document.getElementById("txtAmount").getAttribute("txttag"));
        var AdjustUpto = HeaderCollAmt + G1CollValue;
       
        var G2CollValue = getG2FooterSum(1);
        var G2AdjValue = getG2FooterSum(2);
        var G2DiscValue = getG2FooterSum(3);
        var G2WriteoffAmt = getG2FooterSum(5);
        
        //console.log("G2AdjValue", G2AdjValue);
        //console.log("AdjustedAmount", AdjustedValue + G2DiscValue + G2WriteoffAmt);
        if (G2AdjValue <= 0) {
            var AdjustedValue = AdjustUpto + Math.abs(G2AdjValue);
            updateInputColumn("txtAdjustedAmount", (G2CollValue + G2DiscValue + G2WriteoffAmt) + Math.abs(G2AdjValue));
            updateInputColumn("txtTotAdjustmentAmount", AdjustedValue);
        } else {
           
            var AdjustedValue = G2CollValue +  Math.abs(G2AdjValue);
            updateInputColumn("txtTotAdjustmentAmount", AdjustUpto);
            updateInputColumn("txtAdjustedAmount", AdjustedValue + G2DiscValue + G2WriteoffAmt);
            //showSuccessSnackbar("Adjusted Amount : " + AdjustedValue + G2DiscValue + G2WriteoffAmt);
        }
        var totadjmtamt = parseFloat(document.getElementById("txtTotAdjustmentAmount").getAttribute("txttag"));
        var totadjtedamt = parseFloat(document.getElementById("txtAdjustedAmount").getAttribute("txttag"));
        console.log("totadjmtamt", totadjmtamt, "totadjtedamt", totadjtedamt);
        var RemAmt = parseFloat(document.getElementById("txtTotAdjustmentAmount").getAttribute("txttag")) - parseFloat(document.getElementById("txtAdjustedAmount").getAttribute("txttag"))
        updateInputColumn("txtRemainingAmount", RemAmt + G2DiscValue);
        //bal cal for disc amt
        var clsbl = $("#txtHDClosingBalance").val() != "" ? parseFloat($("#txtHDClosingBalance").val()) : 0;
        var val = $("#txtAmount").val() != "" ? parseFloat($("#txtAmount").val()) : 0;
        var G2DiscAmt = parseFloat(document.getElementById("lblG2DiscAmt").getAttribute("lbltag"));
        var bal = 0;
        if (nDocPrefix == 19)//collection
            bal = ((clsbl) - parseFloat(val)) - G2DiscAmt;
        else
            bal = ((clsbl) + parseFloat(val)) - G2DiscAmt;
        console.log("After amount Bal : ", bal);
        var crdr = bal >= 0 ? "Dr" : "Cr";
        var clb = parseFloat(Math.abs(bal)).toFixed(DecVal);
        console.log("Final Bal : ", clb);
        $("#txtBalance").val(clb.toString() + " " + crdr);
        //updateInputColumn("txtBalance", Math.abs(bal))
        $("#txtBalance").css("color", bal > 0 ? "Red" : "Green");
    }

    function getG2FooterSum(CollType) {
        let total = 0;
        if (CollType == 1) { // Collected amount column
            $('.AdjCollAmtFooter').each(function () {
                let val = parseFloat($(this).attr('txttag'));
                if (!isNaN(val)) {
                    total += val;
                }
            });
        }
        if (CollType == 2) { // Adj amount column
            $('.AdjFooter').each(function () {
                let val = parseFloat($(this).attr('txttag'));
                if (!isNaN(val)) {
                    total += val;
                }
            });
        }
        if (CollType == 3) { // Disc amount column
            $('.AdjDiscAmt').each(function () {
                let val = parseFloat($(this).attr('txttag'));
                if (!isNaN(val)) {
                    total += val;
                }
            });
        }
        if (CollType == 4) { // Total Adj amount column            
            $('.dgv2lblTotAdjAmt').each(function () {
                let val = parseFloat($(this).attr('lbltag'));
                if (!isNaN(val)) {
                    total += val;
                }
            });
        }
        if (CollType == 5) { // Total writeoff amount column            
            $('.dgv2WriteoffAmt').each(function () {
                let val = parseFloat($(this).attr('lbltag'));
                if (!isNaN(val)) {
                    total += val;
                }
            });
        }
        return total;
    }
    function getG1FooterSum(CollType) {
        let total = 0;
        if (CollType == 1) { // Collected amount column
            $('.AdjCollAmtHeader').each(function () {
                let val = parseFloat($(this).attr('txttag'));
                if (!isNaN(val)) {
                    total += val;
                }
            });
        }
        return total;
    }
    function SumG2FooterLabels() {
        var dCollAmt = 0, dDiscAmt = 0, dAdjAmt = 0, dTotAdjAmt = 0, dRemOS = 0, dBalance = 0, dTAA = 0,dTotWriteoff = 0;
        $("#tblGridtwoData tbody tr").each(function () {
            $(this).find("input").each(function (index) {
                const fieldName = $(this).attr("name");
                const fieldID = $(this).attr("id");
                if (fieldName == "AdjCollAmtFooter") {
                    dCollAmt += parseFloat($(this).attr('txttag'));
                }
                else if (fieldName == "AdjDiscAmt") {
                    dDiscAmt += parseFloat($(this).attr('txttag'));
                }
                else if (fieldName == "AdjAmt") {
                    dAdjAmt += parseFloat($(this).attr('txttag'));
                }
            });
            $(this).find("label").each(function (index) {
                const fieldName = $(this).attr("name");
                const fieldID = $(this).attr("id");
                if (fieldName == "G2OS") {
                    dBalance = parseFloat($(this).attr('lbltag'));
                }
                if (fieldName == "G2TotalAdjAmount") {
                    dTotAdjAmt += parseFloat($(this).attr('lbltag'));
                    dTAA = parseFloat($(this).attr('lbltag'));
                }
                if (fieldName == "G2Balance") {
                    var val = parseFloat($(this).attr('lbltag'));
                    dRemOS += val;
                }
                if (fieldName == "WriteoffAmt") {
                    var val = parseFloat($(this).attr('lbltag'));
                    dTotWriteoff += val;
                }
            });
        });
       
        updateLabelColumn("lblG2CollAmt", dCollAmt);
        updateLabelColumn("lblG2DiscAmt", dDiscAmt);
        updateLabelColumn("lblG2AdjAmt", dAdjAmt);
        updateLabelColumn("lblG2TotAdjAmt", dTotAdjAmt);
        updateLabelColumn("lblG2WriteoffAmt", dTotWriteoff);        
        updateLabelColumn("lblG2Balance", dRemOS);
    }

    $('#tblGridtwoData tbody').on('change', '.cmbFullyAdj', function (e) {
        var $dropdown = $(this);
        const isFullyAdjusted = $dropdown.val() === "1";
        const row = $dropdown.closest('tr');
        const rowIndex = TableGridtwoData.row(row).index();
        var $totalAdjLabel = $('#dgv2TotalAdjAmount' + rowIndex);
        var originalAdjValue = parseFloat($totalAdjLabel.attr('lbltag')) || 0;

        var $totalBalanceLabel = $('#dgv2OS' + rowIndex);
        var originalBalanceValue = parseFloat($totalBalanceLabel.attr('lbltag')) || 0;

        var $FinalBalanceLabel = $('#dgv2Bal' + rowIndex);
        //
        var $CollAmtfield = $('#dgv2CollAmt' + rowIndex);
        var dCollAmt = parseFloat($CollAmtfield.attr('txttag')) || 0;

        const $AdjAmtfield = $('#dgv2AdjAmt' + rowIndex);
        var dAdjAmt = parseFloat($AdjAmtfield.attr('txttag')) || 0;

        var $DiscAmtfield = $('#dgv2DiscAmt' + rowIndex);
        var dDiscAmt = parseFloat($DiscAmtfield.attr('txttag')) || 0;

        var $dgvcurrwriteoff = $('#dgv2WriteoffAmt' + rowIndex);
        var WriteoffFooterSum = getG2FooterSum(5);
        if (isFullyAdjusted) {
            // Get the Total Adj Amount label for the current row
            
            //var sumofamt = dCollAmt;
            // Subtract ConfigWriteoffAmt and update label and attribute
            var diffwrtoff = parseFloat(originalBalanceValue - originalAdjValue).toFixed(DecVal);
            var availblewriteoff = parseFloat(ConfigWriteoffAmt) - WriteoffFooterSum;
            var newValue = parseFloat(availblewriteoff) >= parseFloat(diffwrtoff) ? parseFloat(diffwrtoff) : 0;
            if (newValue == 0) {
                $dropdown.val(0);
            }
            //var dwo = newValue
            
            // Update label and lbltag
            $dgvcurrwriteoff.text(parseFloat(newValue).toFixed(DecVal)).attr('lbltag', newValue).attr('title', newValue);
            var finaltotadj = parseFloat(originalAdjValue) + parseFloat(newValue);
            $totalAdjLabel.text(parseFloat(finaltotadj).toFixed(DecVal)).attr('lbltag', parseFloat(finaltotadj)).attr('title', parseFloat(finaltotadj));

            $FinalBalanceLabel.text(parseFloat(originalBalanceValue - finaltotadj).toFixed(DecVal)).attr('lbltag', parseFloat(originalBalanceValue - finaltotadj)).attr('title', parseFloat(originalBalanceValue - finaltotadj));

            //updateLabelColumn(""+aid+"", originalAdjValue + newValue);
            //updateLabelColumn("" + aid1 + "",  newValue);
        } else {
            var totadj = (dCollAmt + dDiscAmt + (dAdjAmt > 0 ? 0 : Math.abs(dAdjAmt)));
            var dbal = originalBalanceValue - totadj;
            $dgvcurrwriteoff.text("0.00").attr('lbltag', "0").attr('title', "0");
            $totalAdjLabel.text(parseFloat(totadj).toFixed(DecVal)).attr('lbltag', totadj).attr('title', totadj);

            $FinalBalanceLabel.text(parseFloat(dbal).toFixed(DecVal)).attr('lbltag', parseFloat(dbal)).attr('title', parseFloat(dbal));
        }
        //calculateGrid2Value();
        SumG2FooterLabels();
    });

    $('#tblGridtwoData_older tbody').on('change', '.AdjDiscPern,.AdjDiscAmt', function (e) {//old function
        var currrowdata = TableGridtwoData.row(nGrid2CurrentRowIndex).data();
        var CurrRowDocID = currrowdata[0];
        var dTotAdjAmt = parseFloat(document.getElementById("txtTotAdjustmentAmount").getAttribute("txttag"));
        var id = e.target.id;
        var fieldval = parseFloat(e.target.value);
        var CurrentFName = e.target.name;
        ProdGridChange = true;
        updateInputColumn(id, fieldval);
        var dAdjAmt = 0, dTotalAdjAmt = 0,dTotDiscAmt = 0;
        $("#tblGridtwoData tbody tr").each(function () {
            var CollAmt = 0, AdjAmtPM = 0, DiscPern = 0, DiscAmt = 0, Balance = 0, dTAA = 0, dWriteoff = 0;
            var rowData = TableGridtwoData.row($(this)).data();
            var RowDocID = rowData[0];
            $(this).find("label").each(function (index) {
                const fieldName = $(this).attr("name");
                const fieldID = $(this).attr("id");
                if (fieldName == "G2OS") {
                    Balance = parseFloat($(this).attr('lbltag'));
                }
            });
            if (CurrRowDocID == RowDocID) {

                $(this).find("input").each(function (index) {
                    const fieldName = $(this).attr("name");
                    const fieldID = $(this).attr("id");
                    if (fieldName == "AdjCollAmtFooter") {
                        CollAmt = parseFloat($(this).attr('txttag'));
                    }
                    else if (fieldName == "AdjAmt") {
                        AdjAmtPM = parseFloat($(this).attr('txttag'));
                    }
                    else if (fieldName == "AdjDiscPern") {
                        var Disval = parseFloat($(this).attr('txttag'));

                        if (Disval >= 0) {
                            if (CurrentFName == "AdjDiscAmt") {
                                var calpern = (fieldval / Balance) * 100;
                                var adjamtinminus = AdjAmtPM >= 0 ? 0 : AdjAmtPM;
                                var sum = CollAmt + fieldval - adjamtinminus;
                                if (Balance >= sum) {
                                    updateInputColumn(fieldID, calpern);
                                    DiscPern = calpern;
                                } else {
                                    showErrorSnackbar("Amount mismatched")
                                    updateInputColumn(fieldID, 0);
                                    DiscPern = 0;
                                }
                            }
                            else {
                                const fullValue = document.getElementById(fieldID).getAttribute('txttag');
                                var val = fullValue != "" ? parseFloat(fullValue) : 0;
                                var adjamtinminus = AdjAmtPM >= 0 ? 0 : AdjAmtPM;
                                var calpern = (val * Balance) / 100;
                                var sum = CollAmt + calpern - adjamtinminus;
                                if (Balance >= sum) {
                                    //updateInputColumn(fieldID, calpern);
                                    DiscPern = val;
                                } else {
                                    showErrorSnackbar("Amount mismatched")
                                    updateInputColumn(fieldID, 0);
                                    DiscPern = 0;
                                }
                                //updateInputColumn(fieldID, val);
                                //DiscPern = val;
                            }
                        }
                        else {
                            showErrorSnackbar("Discount % should be greater than zero")
                            updateInputColumn(fieldID, 0);
                        }
                    }
                    else if (fieldName == "AdjDiscAmt") {
                        //DiscAmt = parseFloat($(this).attr('txttag'));
                        var Disval = parseFloat($(this).attr('txttag'));
                        if (Disval >= 0)
                        {
                            if (CurrentFName == "AdjDiscPern") {
                                var calpern = (DiscPern * Balance) / 100;
                                var adjamtinminus = AdjAmtPM >= 0 ? 0 : AdjAmtPM;
                                updateInputColumn(fieldID, calpern);
                                DiscAmt = calpern;
                            } else {
                                const fullValue = document.getElementById(fieldID).getAttribute('txttag');
                                var val = fullValue != "" ? parseFloat(fullValue) : 0;
                                var adjamtinminus = AdjAmtPM >= 0 ? 0 : AdjAmtPM;
                                var sum = CollAmt + val - adjamtinminus;
                                if (Balance >= sum) {
                                    //updateInputColumn(fieldID, calpern);
                                    DiscAmt = val;
                                } else {
                                    showErrorSnackbar("Amount mismatched")
                                    updateInputColumn(fieldID, 0);
                                    DiscAmt = 0;
                                }
                                //updateInputColumn(fieldID, val);
                                //DiscAmt = val;
                            }
                        }
                        else
                        {
                            showErrorSnackbar("Discount Amount should be greater than zero")
                            updateInputColumn(fieldID, 0);
                        }
                    }
                });
                $(this).find("label").each(function (index) {
                    const fieldName = $(this).attr("name");
                    const fieldID = $(this).attr("id");
                    if (fieldName == "WriteoffAmt") {
                        console.log("writeoff field trigger");
                        $(this).val(0);
                        dWriteoff = 0;// parseFloat($(this).attr('lbltag'));
                        updateLabelColumn(fieldID, 0);
                    }
                    if (fieldName == "G2TotalAdjAmount") {
                        var PMAdjamt = AdjAmtPM > 0 ? 0 : Math.abs(AdjAmtPM);
                        var totadj = CollAmt + DiscAmt + PMAdjamt + dWriteoff;
                        updateLabelColumn(fieldID, totadj);
                        dTotalAdjAmt += totadj;
                        dTAA = totadj;
                    }
                    //if (fieldName == "G2Balance") {
                    //    var val = parseFloat(Balance - dTAA);
                    //    updateLabelColumn(fieldID, val);
                    //}
                });
                $(this).find("select").each(function (index) {
                    const fieldName = $(this).attr("name");
                    const fieldID = $(this).attr("id");
                    if (fieldName == "FullyAdj") {
                        $(this).val(0);
                    }
                });
            }
            $(this).find("label").each(function (index) {
                const fieldName = $(this).attr("name");
                const fieldID = $(this).attr("id");
                if (fieldName == "G2Balance") {
                    var val = parseFloat(Balance - dTAA);
                    updateLabelColumn(fieldID, val);
                }
            });
            //$(this).find("input").each(function (index) {
            //    const fieldName = $(this).attr("name");
            //    const fieldID = $(this).attr("id");
            //    if (fieldName == "AdjDiscAmt") {
            //        dTotDiscAmt += parseFloat($(this).attr('txttag'));
            //    }
            //});
        });
        //updateLabelColumn("lblG2DiscAmt", dTotDiscAmt);
        SumG2FooterLabels();
        //updateInputColumn("txtAdjustedAmount", dTotalAdjAmt);

        //var remamt = parseFloat(document.getElementById("txtTotAdjustmentAmount").getAttribute("txttag")) - dTotalAdjAmt;
        CalculateAdjustvalues();
    });
    $('#tblGridtwoData tbody').on('change', '.AdjDiscPern,.AdjDiscAmt', function (e) {

        var $row = $(e.target).closest("tr");        // ✔ only this row
        var rowData = TableGridtwoData.row($row).data();
        var CurrRowDocID = rowData[0];

        var dTotAdjAmt = parseFloat($("#txtTotAdjustmentAmount").attr("txttag"));
        var id = e.target.id;
        var fieldval = parseFloat(e.target.value);
        var CurrentFName = e.target.name;

        ProdGridChange = true;
        updateInputColumn(id, fieldval);

        // ---------------------------
        // READ ALL FIELDS OF CURRENT ROW
        // ---------------------------

        var CollAmt = parseFloat($row.find("input[name='AdjCollAmtFooter']").attr("txttag")) || 0;
        var AdjAmtPM = parseFloat($row.find("input[name='AdjAmt']").attr("txttag")) || 0;
        var DiscPern = parseFloat($row.find("input[name='AdjDiscPern']").attr("txttag")) || 0;
        var DiscAmt = parseFloat($row.find("input[name='AdjDiscAmt']").attr("txttag")) || 0;
        var Balance = parseFloat($row.find("label[name='G2OS']").attr("lbltag")) || 0;

        // ---------------------------
        // CALCULATE ONLY FOR THIS ROW
        // ---------------------------

        if (CurrentFName === "AdjDiscAmt") {
            var calpern = (fieldval / Balance) * 100;
            updateInputColumn($row.find("input[name='AdjDiscPern']").attr("id"), calpern);
            DiscPern = calpern;
            DiscAmt = fieldval;
        }

        if (CurrentFName === "AdjDiscPern") {
            var calamt = (fieldval * Balance) / 100;
            updateInputColumn($row.find("input[name='AdjDiscAmt']").attr("id"), calamt);
            DiscAmt = calamt;
            DiscPern = fieldval;
        }

        // Writeoff always 0 on change
        updateLabelColumn($row.find("label[name='WriteoffAmt']").attr("id"), 0);

        // Total adjustment = Coll + DiscAmt + PM adj + writeoff
        var PMAdjamt = AdjAmtPM > 0 ? 0 : Math.abs(AdjAmtPM);
        var totadj = CollAmt + DiscAmt + PMAdjamt;

        updateLabelColumn($row.find("label[name='G2TotalAdjAmount']").attr("id"), totadj);

        // Balance after adjustment
        var newBal = Balance - totadj;
        if (newBal < 0) {

            showErrorSnackbar("Amount mismatched");

            // Reset discount fields
            DiscPern = 0;
            DiscAmt = 0;

            // Update UI immediately
            updateInputColumn($row.find("input[name='AdjDiscPern']").attr("id"), 0);
            updateInputColumn($row.find("input[name='AdjDiscAmt']").attr("id"), 0);

            // Recalculate total adjustment without discount
            totadj = CollAmt + PMAdjamt;   // no DiscAmt

            // Recalculate balance
            newBal = Balance - totadj;
        }

        // Update adjusted values
        updateLabelColumn($row.find("label[name='G2TotalAdjAmount']").attr("id"), totadj);
        updateLabelColumn($row.find("label[name='G2Balance']").attr("id"), newBal);

        // Reset FullyAdj dropdown
        $row.find("select[name='FullyAdj']").val(0);

        // ---------------------------
        // UPDATE FOOTER & GLOBAL VALUES
        // ---------------------------
        SumG2FooterLabels();
        CalculateAdjustvalues();
    });

    //$("#tblGridoneData").change(function (e) {
    var txtValuechanged = false;

function setDate1(FieldID,Type) {
    $.ajax({
         url: "@Url.Action("setdate", "Home")",
        type: 'get',
        contentType: 'json',
        data: { TypeID: Type },
        success: function (data) {
            $.each(data, function (i, items) {
                $("#" + FieldID).attr("max", items.MaxDate);
                $("#" + FieldID).attr("min", items.MinDate);
                $("#" + FieldID).val(items.Value);
            });
        }
    })
    }
    $("#trVisa").hide();
    function PaymodeChangeFieldValidation(PMID) {
        var selval = PMID;

        updateInputColumn("txtVisaPern", 0); updateInputColumn("txtVisaAmt", 0);


        $("#cmbBankName").val(0);
        $("#txtBranchName,#txtIFSC").val("");
        $('#cmbChequeNo').find("option").remove();
        $('#cmbChequeNo').append($('<option/>', {
            value: 0,
            text: "-- Select --",
        }));

        if (selval == 2 || selval == 3 || selval == 4 || selval == 5) {
            $("#cmbFromAccount").val(DefBankAcc);


        } else {
            $("#cmbFromAccount").val(0);
        }
        $('#cmbMode').append($('<option/>', {
            value: 0,
            text: "-- Select --",
        }));
        $("#cmbFromAccount,#cmbBTMode,#cmbChequeNo").val(0); $("#txtNEFT,#txtBankName,#txtIFSC").val("");
        $("#dtpChequeDate").val($("#dtpDate").val());
        $("#cmbChequeNo,#dtpChequeDate").hide();
        $("#cmbFromAccount,#dvcmbfrom").show(); $("#trVisa").hide();
        var md = [];
        //cmbFromAccount,cmbBTMode,txtNEFT,cmbChequeNo,dtpChequeDate,txtBankName,txtBranchName,txtIFSC
        if (selval == 2) {// cheque
            if (nDocPrefix == "18") {//payment
                $("#cmbChequeNo,#dtpChequeDate").show();
                $("#cmbFromAccount").val(DefBankAcc);
                //call cheque no load for sel acc
                md = arrBankAccountData.filter(t => t.ID == DefBankAcc);
                if (md.length > 0) {
                    $("#cmbFromAccount").val(md[0].ID);
                    $("#cmbBankName").val(md[0].BankID);
                    $("#txtBranchName").val(md[0].Branch);
                    $("#txtIFSC").val(md[0].IFSC);
                    //showErrorSnackbar("IFSC : " + md[0].IFSC + ", Branch : " + md[0].Branch);
                }
                var id = $("#txtID").val() != "" ? $("#txtID").val() : "0"
                GetData(5, DefBankAcc, id);
            }
            else {//collection
                $("#cmbFromAccount,#dvcmbfrom").hide();
                $("#dtpChequeDate").show();
                $("#cmbFromAccount").val(0);
            }
        } else if (selval == 3) {//dd
            if (nDocPrefix == "18") {//payment
                $("#cmbChequeNo,#dtpChequeDate").show();
                $("#cmbFromAccount").val(DefBankAcc);
            } else {//collection
                $("#cmbFromAccount,#dvcmbfrom").hide();
                $("#dtpChequeDate").show();
                $("#cmbFromAccount").val(0);
            }
        }
        else if (selval == 4) {//bank transfer
            if (nDocPrefix == "18") {//payment
                $("#cmbChequeNo,#dtpChequeDate").hide();
                $("#cmbFromAccount").val(DefBankAcc);
            }
            else {//collection
                $("#cmbChequeNo,#dtpChequeDate").hide();
                $("#cmbFromAccount").val(DefBankAcc);
            }
            md = arrBankAccountData.filter(t => t.ID == DefBankAcc);
            if (md.length > 0) {
                $("#cmbFromAccount").val(md[0].ID);
                $("#cmbBankName").val(md[0].BankID);
                $("#txtBranchName").val(md[0].Branch);
                $("#txtIFSC").val(md[0].IFSC);
                //showErrorSnackbar("IFSC : " + md[0].IFSC + ", Branch : " + md[0].Branch);
            }
        }
        else if (selval == 5) {
            $("#trVisa").show();
            var CollAmt = parseFloat(document.getElementById("txtAmount").getAttribute("txttag"));
            var dVisaAmt = (parseFloat(VisaPern) * CollAmt) / 100;
            updateInputColumn("txtVisaPern", VisaPern); updateInputColumn("txtVisaAmt", dVisaAmt);
            md = arrBankAccountData.filter(t => t.ID == DefBankAcc);
            if (md.length > 0) {
                $("#cmbFromAccount").val(md[0].ID);
                $("#cmbBankName").val(md[0].BankID);
                $("#txtBranchName").val(md[0].Branch);
                $("#txtIFSC").val(md[0].IFSC);
                //showErrorSnackbar("IFSC : " + md[0].IFSC + ", Branch : " + md[0].Branch);
            }
        }
        if ($("#cmbPaymode").val() != 1 && md.length > 0) {//cash
            var faid = md[0].FAID;
            GetClosingBalance(7, faid, $("#dtpDate").val());
        } else {
            $("#lblBankAccBalance").text("0.00");
        }
    }
    $("#cmbPaymode").change(function (e) {
        var selval = e.target.value;
        PaymodeChangeFieldValidation(selval);

        if (selval == 2 && nDocPrefix == 19) {
            var cid = $("#txtCustomerID").val();
            GetData(7, null, cid);
        }
        if ($("#cmbPaymode").val() == 1) {//cash
            GetClosingBalance(6, 13, $("#dtpDate").val());
        } else {
            $("#lblBalance").text("0.00");
        }
    });
    $("#txtSearchDocID").change(function (e) {
        TableGrid1Data.draw().clear(); TableGrid1Data.draw().clear();
        TableGridtwoData.draw().clear(); TableGridtwoData.draw().clear();

        $("#txtCustomerID,#txtSearch").val(""),
            $("#lblName,#lblMob1,#lblGSTIN").text(""),
            $("#cmbCreditTerm,#cmbPaymode,#cmbBeat,#cmbSalesman").val(0),
            $("#txtBAdd1,#txtBAdd2,#txtBAdd3,#txtSAdd1,#txtSAdd2,#txtSAdd3,#txtPincode,#txtClosingBalance").val("");
        updateLabelColumn("lblG1TotalBalance", 0);
        updateLabelColumn("lblG2TotalOS", 0);
        if (nDocPrefix == 19) {
            $("#lblrdoAdv").text("Payable");
            $("#lblrdoOS").text("Receivable");
        } else {
            $("#lblrdoAdv").text("Receivable");
            $("#lblrdoOS").text("Payable");
        }
        var DocID = e.target.value;
        if (DocID != "") {
            GetData(6, DocID);
        }
    });
    var TempAL = [], arrBankAccountData = [],arrPartyPreviousbankinfo=[];
    var nIndexarrProdCode = 0, nIndexarrProdName = 0, nIndexarrProdCodeName = 0 ,DefBankAcc = 0;
    var prodids = 0;

    function GetData(nMode, strName = null, strID = null, dtpDt = null) {
        $.ajax({
            url: Aurl + "collectionpayment/get",
            type: 'get',
            contentType: 'json',
            data: { Mode: nMode, DocPrefix: nDocPrefix, CodeName: strName, ID: strID, BranchID: $("#cmbBranch").val(), Date: $("#dtpDate").val() },
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                if (nMode == 1) {
                    $('#cmbPaymode,#cmbCreditTerm,#cmbBranch,#cmbUDN,#cmbFilterBranch,#cmbBeat,#cmbSalesman,#cmbBTMode,#cmbFromAccount,#cmbBankName').find("option").remove();
                    $('#cmbPaymode,#cmbCreditTerm,#cmbBranch,#cmbUDN,#cmbFilterBranch,#cmbBeat,#cmbSalesman,#cmbBTMode,#cmbFromAccount,#cmbBankName').append($('<option/>', {
                        value: 0,
                        text: "-- Select --",
                    }));
                    arrVendor = [], arrVendorCode = [], arrVendorName = [], arrBankAccountData = [];
                    nIndexarrVendor = 0, nIndexarrProd = 0;
                    $.each(data, function (i, items) {
                        if (items.FType == 1) {
                            var ven = {
                                "label": items.Code + " | " + items.Name,
                                "name": items.Name,
                                "code": items.Code,
                                "id": items.ID,
                            }
                            arrVendor.push(ven);
                            arrVendorCode[nIndexarrVendor] = items.Code;
                            arrVendorName[nIndexarrVendor] = items.Name;
                            nIndexarrVendor++;
                        }
                        if (items.FType == 2) {
                            $('#cmbBranch,#cmbFilterBranch').append($('<option/>', {
                                value: items.ID,
                                text: items.Name,
                            }));
                        }
                        if (items.FType == 3) {
                            $('#cmbUDN').append($('<option/>', {
                                value: items.ID,
                                text: items.Name,
                            }));
                        }
                        if (items.FType == 4) {
                            $("#lblDocID").text(items.Name);
                        }
                        if (items.FType == 5) {
                            $('#cmbPaymode').append($('<option/>', {
                                value: items.ID,
                                text: items.Name,
                            }));
                        }
                        if (items.FType == 6) {
                            $('#cmbCreditTerm').append($('<option/>', {
                                value: items.ID,
                                text: items.Name,
                            }));
                        }
                        if (items.FType == 7) {
                            $('#cmbBeat').append($('<option/>', {
                                value: items.ID,
                                text: items.Name,
                            }));
                        }
                        if (items.FType == 8) {
                            $('#cmbSalesman').append($('<option/>', {
                                value: items.ID,
                                text: items.Name,
                            }));
                        }
                        if (items.FType == 9) {
                            var BADetails = (items.Name).split('|');
                            $('#cmbFromAccount').append($('<option/>', {
                                value: items.ID,
                                text: BADetails[0],
                            }));
                            var BAInfo = {
                                "ID": items.ID,
                                "FAID": items.Code,
                                "AccNo": BADetails[0],
                                "Bank": BADetails[1],
                                "Branch": BADetails[2],
                                "IFSC": BADetails[3],
                                "MICR": BADetails[4],
                                "DefYN": BADetails[5],
                                "BankID": BADetails[6],
                            }
                            if (BADetails[5] == "1") {
                                DefBankAcc = items.ID;
                                //$("#cmbFromAccount").val(items.ID);
                                //$("#cmbBankName").val(BADetails[6]);
                                //$("#txtBranchName").val(BADetails[2]);
                                //$("#txtIFSC").val(BADetails[3]);
                            }
                            arrBankAccountData.push(BAInfo);
                        }
                        if (items.FType == 10) {
                            $('#cmbBTMode').append($('<option/>', {
                                value: items.ID,
                                text: items.Name,
                            }));
                        }
                        if (items.FType == 11) {
                            $('#cmbBankName').append($('<option/>', {
                                value: items.ID,
                                text: items.Name,
                            }));
                        }
                    });
                    SetAutlistforFields();
                    $("#cmbBranch").val(DefBranch);

                }
                else if (nMode == 2) {
                    $.each(data, function (i, items) {
                        var pm = items.PaymentModeID != "" && items.PaymentModeID != "7" ? items.PaymentModeID : "1";
                        $("#txtCustomerID").val(items.ID),
                            $("#txtSearch").val(items.Name),//Code
                            $("#lblName").text(items.Code),
                            $("#cmbRating").text(items.Ratings),
                            $("#lblMob1").text(items.Mob1),
                            $("#lblGSTIN").val(items.GSTIN),
                            $("#cmbCreditTerm").val(items.CreditTermID),
                            $("#cmbPaymode").val(pm),
                            $("#txtBAdd1").val(items.Billadd1),
                            $("#txtBAdd2").val(items.Billadd2),
                            $("#txtBAdd3").val(items.Billadd3),
                            $("#txtSAdd1").val(items.Shipadd1),
                            $("#txtSAdd2").val(items.shipadd2),
                            $("#txtSAdd3").val(items.Shipadd3),
                            $("#txtPincode").val(items.Pincode);
                        if ($("#cmbBeat").val() == 0) {
                            $("#cmbBeat").val(items.BeatID);
                        }
                        if ($("#cmbSalesman").val() == 0) {
                            $("#cmbSalesman").val(items.SalesmanID);
                        }
                        var osval = parseFloat(items.OSValue).toFixed(DecVal);
                        var ostype = items.CreditlimitOS;
                        var Osbytype = ostype == "Cr" ? osval * -1 : osval;
                        $("#txtHDClosingBalance").val(Osbytype);
                        $("#txtBalance").val(osval + " " + ostype);
                        $("#txtClosingBalance").val(osval + " " + ostype);
                        $("#txtClosingBalance,#txtBalance").css("color", ostype == "Dr" ? "Red" : "Green");

                        //$("#cmbTaxType").val(items.TaxTypeID),
                        //$("#cmdPriceType").val(items.PriceTypeID),
                        PaymodeChangeFieldValidation($("#cmbPaymode").val());
                        GetOSDocuments(1, items.ID, 0);
                        if (pm == 2) {
                            GetData(7, null, items.ID);
                        }
                    });
                    if ($("#cmbPaymode").val() == 1) {//cash
                        GetClosingBalance(6, 13, $("#dtpDate").val());
                    } else {
                        $("#lblBalance").text("0.00");
                    }
                }
                else if (nMode == 33) {
                    arrVendor = [], arrVendorCode = [], arrVendorName = [], arrBankAccountData = [];
                    nIndexarrVendor = 0, nIndexarrProd = 0;
                    $.each(data, function (i, items) {
                        var ven = {
                            "label": items.Code + " | " + items.Name,
                            "name": items.Name,
                            "code": items.Code,
                            "id": items.ID,
                        }
                        arrVendor.push(ven);
                        arrVendorCode[nIndexarrVendor] = items.Code;
                        arrVendorName[nIndexarrVendor] = items.Name;
                        nIndexarrVendor++;
                    });
                    $("#txtSearch").autocomplete({
                        minLength: 0, autoFocus: true,
                        source: arrVendor,
                        //focus: function (event, ui) {
                        //    $("#txtSearch").val(ui.item.name);
                        //    return false;
                        //},
                        select: function (event, ui) {
                            $("#txtSearch").val(ui.item.name);
                            GetData(2, ui.item.code);
                            //$("#txtRemarks").val(ui.item.id);
                            return false;
                        },
                    }).autocomplete("instance")._renderItem = function (ul, item) {
                        return $("<li class='each'>")
                            .append("<div class='acItem'><span class='name'>" +
                                item.label + "</span></div>")
                            .appendTo(ul);
                    };
                }
                else if (nMode == 6) {
                    if (data.length > 0) {
                        $.each(data, function (i, items) {
                            $("#txtCustomerID").val(items.ID), $("#txtSearch").val(items.Name), $("#lblName").text(items.Code);
                            GetData(2, items.Code);
                        });
                    } else {
                        showErrorSnackbar("No records found");
                    }
                }
                else if (nMode == 7) {
                    arrPartyPreviousbankinfo = []
                    $.each(data, function (i, items) {
                        var bi = {
                            "label": items.IFSC,
                        }
                        arrPartyPreviousbankinfo.push(bi);
                        $("#txtBranchName").val(items.Branch);
                        $("#cmbBankName option:contains(" + items.Bank + ")").attr('selected', 'selected');
                        $("#txtIFSC").val(items.IFSC);
                    });
                    const key = 'label'
                    var arrayUniqueByKey = [...new Map(arrPartyPreviousbankinfo.map(item => [item[key], item])).values()];
                    var tempifsc = [];
                    for (var i = 0; i < arrayUniqueByKey.length; i++) {
                        if (arrayUniqueByKey[i].label != "") {
                            tempifsc.push(arrayUniqueByKey[i]);
                        }
                    }
                    $("#txtIFSC").autocomplete({
                        minLength: 0, autoFocus: true,
                        source: tempifsc,
                        select: function (event, ui) {
                            return false;
                        },
                    }).autocomplete("instance")._renderItem = function (ul, item) {
                        return $("<li class='each'>")
                            .append("<div class='acItem'><span class='name'>" +
                                item.label + "</span></div>")
                            .appendTo(ul);
                    };
                }
                else if (nMode == 5) {
                    $.each(data, function (i, items) {
                        $('#cmbChequeNo').append($('<option/>', {
                            value: items.ID,
                            text: items.Name,
                        }));
                    });
                }
            }
        });
    }
    $("#cmbBeat,#cmbSalesman").change(function (e) {
        var BeatID = $("#cmbBeat").val();
        var SalesmanID = $("#cmbSalesman").val();
        $("#txtCustomerID").val(""),
            $("#txtSearch").val(""),
            $("#lblName").text("");
        GetData(33, BeatID, SalesmanID);
    });
    $('#cmbFromAccount').change(function (e) {
        var SelID = e.target.value;
        //$('#lnkViewFromBank').hide();
        $("#cmbBankName").val(0);
        $("#txtBranchName,#txtIFSC").val("");
        $('#cmbChequeNo').find("option").remove();
        $('#cmbChequeNo').append($('<option/>', {
            value: 0,
            text: "-- Select --",
        }));
        var PMID = $("#cmbPaymode").val();
        var md = arrBankAccountData.filter(t => t.ID == SelID);
        if (md.length > 0) {
            $("#cmbBankName").val(md[0].BankID);
            $("#txtBranchName").val(md[0].Branch);
            $("#txtIFSC").val(md[0].IFSC);
            //showErrorSnackbar("IFSC : " + md[0].IFSC + ", Branch : " + md[0].Branch);
        }
        if (nDocPrefix == 18) {
            if (PMID == "2") {
                if (SelID > 0) {
                    var id = $("#txtID").val() != "" ? $("#txtID").val() : "0"
                    GetData(5, SelID, id);
                }
            }
        }
        if ($("#cmbPaymode").val() != 1 && md.length > 0) {//cash
            var faid = md[0].FAID;
            GetClosingBalance(7, faid, $("#dtpDate").val());
        } else {
            $("#lblBankAccBalance").text("0.00");
        }
    });
    function GetClosingBalance(nMode, nID, strVal = "") {
        $.ajax({
            url: Aurl + "contra/get",
            type: 'get',
            contentType: 'json',
            data: { TransID: 0, Mode: nMode, ID: nID, Value: strVal },
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                if (nMode == 6) {// type change
                    $("#lblBalance").text("0.00");
                    $.each(data, function (i, items) {
                        var bal = parseFloat(items.Balance).toFixed(DecVal) + " " + items.ContType;
                        $("#lblBalance").text(bal);
                    });
                }
                if (nMode == 7) {// type change
                    $("#lblBankAccBalance").text("0.00");
                    $.each(data, function (i, items) {
                        var bal = parseFloat(items.Balance).toFixed(DecVal) + " " + items.ContType;
                        $("#lblBankAccBalance").text(bal);
                    });
                }
            }
        });
    }
    function GetOSDocuments(nMode, nCustID,nID) {
        TableGrid1Data.draw().clear(); TableGrid1Data.draw().clear();
        TableGridtwoData.draw().clear(); TableGridtwoData.draw().clear();
        $.ajax({
            url: Aurl + "collectionpayment/getosdocs",
            type: 'get',
            contentType: 'json',
            data: {
                Mode: nMode, DocPrefix: nDocPrefix, PartyID: nCustID, BranchID: $("#cmbBranch").val(),
                Date: $("#dtpDate").val(), TransID: nID
            },
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                var G1So = 1, G2So = 1, G1Bal = 0, G2Bal = 0;
                var disbfields = nTransMode == 4 || nTransMode == 5 ? "disabled" : "";
                var CollPayOSData = eval(data)
                var g1data = CollPayOSData.filter(d => d.TypeID == "1");
                var g2data = CollPayOSData.filter(d => d.TypeID == "2");
                //start
                var G1dataSet = g1data.map(function (items, nRowIndex) {
                    G1Bal += parseFloat(items.Balance);
                    return [
                        items.ID,
                        items.DocPrefix,
                        items.FAID,
                        items.DocValue,
                        (nRowIndex + 1),
                        items.DocID,
                        items.Tran_Date,
                        items.DocRef,
                        items.TransName,
                        '<label name="G1NetAmount" lbltag="' + items.NetAmt + '" title="' + items.NetAmt + '" class="lblsettag" id="dgv1NetAmount' + nRowIndex + '">' + parseFloat(items.NetAmt).toFixed(DecVal) + '</label>',
                        '<label name="G1Balance" lbltag="' + items.Balance + '" title="' + items.Balance + '" class="lblsettag lblHeaderBal" id="dgv1Balance' + nRowIndex + '" refadjid="dgv1AdjAmt' + nRowIndex + '">' + parseFloat(items.Balance).toFixed(DecVal) + '</label>',
                        '<input type="number" txttag="0" title="0" name="AdjCollAmtHeader"  class="txtsettag AdjCollAmtHeader gdInput"  id="dgv1AdjAmt' + nRowIndex + '"  min="0" max="' + items.Balance + '" oninput="maxCheckGrid1(this)"/>'
                    ];
                });
                $('#tblGridoneData').DataTable({
                    scrollY: "250px",
                    scrollX: true,
                    scrollCollapse: true,
                    paging: false,
                    destroy: true,
                    data: G1dataSet,
                    fixedColumns: false,
                    searching: false,
                    ordering: false,
                    sorting: true,
                    info: false,
                    columns: [
                        { title: "ID", visible: false, className: "dt-body-left" },
                        { title: "DocPrefix", visible: false, className: "dt-body-left" },
                        { title: "FAID", visible: false, className: "dt-body-left" },
                        { title: "InvDocVal", visible: false, className: "dt-body-left" },
                        { title: "#", className: "dt-body-left", width: "3%" },
                        { title: "Doc ID", className: "dt-body-left", width: "30%" },
                        { title: "Date", className: "dt-body-right", width: "7%" },
                        { title: "Ref No", className: "dt-body-right", width: "6%" },
                        { title: "Doc Type", className: "dt-body-left", width: "6%" },
                        { title: "Doc Value", className: "dt-body-right", width: "7%" },
                        { title: "Outstandings", className: "dt-body-right", width: "7%" },
                        { title: "Adj Amt", className: "dt-body-right", width: "6%" },
                    ]
                });
                TableGrid1Data = $('#tblGridoneData').DataTable();
                //end
                //g2start
                console.log("g2data ", g2data);
                var G2dataSet = g2data.map(function (items, nRowIndex) {
                    G2Bal += parseFloat(items.Balance);
                    var rmos = parseFloat(items.Balance) - parseFloat(items.TotalAdjAmt);
                    return [
                        items.ID,
                        items.DocPrefix,
                        items.FAID,
                        items.DocValue,
                        (nRowIndex + 1),
                        items.DocPrefix == "15" ? '<a href="javascript:void(0)" style="cursor: pointer;" class="clsInvoiceCollection">' + items.DocID + '</a>' : items.DocID,
                        items.Tran_Date,
                        items.DocRef,
                        items.TransName,
                        '<label name="G2NetAmount" lbltag="' + items.NetAmt + '" title="' + items.NetAmt + '" class="lblsettag" id="dgv2NetAmount' + nRowIndex + '">' + parseFloat(items.NetAmt).toFixed(DecVal) + '</label>',
                        '<label name="G2OS" lbltag="' + items.Balance + '" title="' + items.Balance + '" class="lblsettag lblFooterBal" id="dgv2OS' + nRowIndex + '" refadjid="dgv2CollAmt' + nRowIndex + '">' + parseFloat(items.Balance).toFixed(DecVal) + '</label>',
                        '<input type="number" txttag="0" title="0" name="AdjCollAmtFooter"  class="txtsettag AdjCollAmtFooter gdInput"  id="dgv2CollAmt' + nRowIndex + '"  min="0" max="' + items.Balance + '" oninput="maxCheckGrid2(this)" />',// oninput="maxCheckGrid2(this)"
                        '<input type="number" txttag="0" title="0" name="AdjAmt"  class="txtsettag AdjFooter gdInput"  id="dgv2AdjAmt' + nRowIndex + '"/>',
                        '<input type="number" txttag="0" title="0" name="AdjDiscPern"  class="txtsettag AdjDiscPern gdInput"  id="dgv2DiscPern' + nRowIndex + '"/></br><input type="number" txttag="0" title="0" name="AdjDiscAmt"  class="txtsettag AdjDiscAmt gdInput"  id="dgv2DiscAmt' + nRowIndex + '"/>',
                        '<select name="FullyAdj" id="dgvFulladj' + nRowIndex + '" class="gdInput cmbFullyAdj"><option value="0">No</option><option value="1">Yes</option></select>' +
                        '<br/><label style="padding-top:10px" name="WriteoffAmt" lbltag="0" title="0" class="lblsettag dgv2WriteoffAmt" id="dgv2WriteoffAmt' + nRowIndex + '">' + parseFloat(0).toFixed(DecVal) + '</label>',
                        '<label name="G2TotalAdjAmount" lbltag="0" title="0" class="lblsettag dgv2lblTotAdjAmt" id="dgv2TotalAdjAmount' + nRowIndex + '">' + parseFloat(0).toFixed(DecVal) + '</label>',
                        '<label name="G2Balance" lbltag="' + items.Balance + '" title="' + items.Balance + '" class="lblsettag" id="dgv2Bal' + nRowIndex + '">' + parseFloat(items.Balance).toFixed(DecVal) + '</label>',
                    ];
                });
                $('#tblGridtwoData').DataTable({
                    scrollY: "250px",
                    scrollX: true,
                    scrollCollapse: true,
                    paging: false,
                    destroy: true,
                    data: G2dataSet,
                    fixedColumns: false,
                    searching: false,
                    ordering: false,
                    sorting: true,
                    info: false,
                    columns: [
                        { title: "ID", visible: false, className: "dt-body-left" },
                        { title: "DocPrefix", visible: false, className: "dt-body-left" },
                        { title: "FAID", visible: false, className: "dt-body-left" },
                        { title: "InvDocVal", visible: false, className: "dt-body-left" },
                        { title: "#", className: "dt-body-left", width: "3%" },
                        { title: "Doc ID", className: "dt-body-left", width: "30%" },
                        { title: "Date", className: "dt-body-right", width: "7%" },
                        { title: "Ref No", className: "dt-body-right", width: "6%" },
                        { title: "Doc Type", className: "dt-body-left", width: "6%" },
                        { title: "Doc Value", className: "dt-body-right", width: "7%" },
                        { title: "Outstandings", className: "dt-body-right", width: "7%" },
                        { title: "Coll Amt", className: "dt-body-right", width: "6%" },
                        { title: "Adj Amt(+/-)", className: "dt-body-right", width: "6%" },
                        { title: "Disc %/₹", className: "dt-body-right", width: "6%" },
                        { title: "Full Adj", className: "dt-body-right", width: "6%" },
                        { title: "Total Amt Adj", className: "dt-body-right", width: "6%" },
                        { title: "Balance", className: "dt-body-right", width: "6%" },
                    ]
                });
                TableGridtwoData = $('#tblGridtwoData').DataTable();
                //$.each(data, function (i, items) {
                //    if (items.TypeID == "1") {
                //        TableGrid1Data.row.add([
                //            items.ID,
                //            items.DocPrefix,
                //            items.FAID,
                //            items.DocValue,
                //            G1So,
                //            items.DocID,
                //            items.Tran_Date,
                //            items.DocRef,
                //            items.TransName,
                //            '<label name="G1NetAmount" lbltag="' + items.NetAmt + '" title="' + items.NetAmt + '" class="lblsettag" id="dgv1NetAmount' + i + '">' + parseFloat(items.NetAmt).toFixed(DecVal) + '</label>',
                //            '<label name="G1Balance" lbltag="' + items.Balance + '" title="' + items.Balance + '" class="lblsettag lblHeaderBal" id="dgv1Balance' + i + '" refadjid="dgv1AdjAmt' + i + '">' + parseFloat(items.Balance).toFixed(DecVal) + '</label>',
                //            '<input type="number" txttag="0" title="0" name="AdjCollAmtHeader"  class="txtsettag AdjCollAmtHeader gdInput"  id="dgv1AdjAmt' + i + '"  min="0" max="' + items.Balance +'" oninput="maxCheckGrid1(this)"/>'
                //        ]).draw(false);
                //        G1Bal += parseFloat(items.Balance);
                //        G1So++;
                //    }
                //    else {
                //        TableGridtwoData.row.add([
                //            items.ID,
                //            items.DocPrefix,
                //            items.FAID,
                //            items.DocValue,
                //            G2So,
                //            items.DocPrefix == "15" ? '<a href="javascript:void(0)" style="cursor: pointer;" class="clsInvoiceCollection">' + items.DocID + '</a>' : items.DocID,
                //            items.Tran_Date,
                //            items.DocRef,
                //            items.TransName,
                //            '<label name="G2NetAmount" lbltag="' + items.NetAmt + '" title="' + items.NetAmt + '" class="lblsettag" id="dgv2NetAmount' + i + '">' + parseFloat(items.NetAmt).toFixed(DecVal) + '</label>',
                //            '<label name="G2OS" lbltag="' + items.Balance + '" title="' + items.Balance + '" class="lblsettag lblFooterBal" id="dgv2OS' + i + '" refadjid="dgv2CollAmt' + i + '">' + parseFloat(items.Balance).toFixed(DecVal) + '</label>',
                //            '<input type="number" txttag="0" title="0" name="AdjCollAmtFooter"  class="txtsettag AdjCollAmtFooter gdInput"  id="dgv2CollAmt' + i + '"  min="0" max="' + items.Balance + '"/>',// 
                //            '<input type="number" txttag="0" title="0" name="AdjAmt"  class="txtsettag AdjFooter gdInput"  id="dgv2AdjAmt' + i + '"/>',
                //            '<input type="number" txttag="0" title="0" name="AdjDiscPern"  class="txtsettag AdjDiscPern gdInput"  id="dgv2DiscPern' + i + '"/></br><input type="number" txttag="0" title="0" name="AdjDiscAmt"  class="txtsettag AdjDiscAmt gdInput"  id="dgv2DiscAmt' + i + '"/>',
                //            '<select name="FullyAdj" id="dgvFulladj'+i+'" class="gdInput"><option value="0">No</option><option value="1">Yes</option></select>',
                //            '<label name="G2TotalAdjAmount" lbltag="0" title="0" class="lblsettag" id="dgv2TotalAdjAmount' + i + '">' + parseFloat(0).toFixed(DecVal) + '</label>',
                //            '<label name="G2Balance" lbltag="' + items.Balance + '" title="' + items.Balance + '" class="lblsettag" id="dgv2Bal' + i + '">' + parseFloat(items.Balance).toFixed(DecVal) + '</label>',
                //        ]).draw(false);
                //        G2Bal += parseFloat(items.Balance);
                //        G2So++;
                //    }
                //});
                //lblG1TotalBalance,lblG1AdjAmt
                var G1Count = TableGrid1Data.rows().count();
                var G2Count = TableGridtwoData.rows().count();
                //$("#lblAdvDocCount").text("(" + G1Count + ")"); $("#lblOSDocCount").text("(" + G2Count + ")");

                if (nDocPrefix == 19) {
                    $("#lblrdoAdv").html("Payable" + "(<b style='color:red'>" + G1Count + "</b>)");
                    $("#lblrdoOS").html("Receivable" + "(<b style='color:red'>" + G2Count + "</b>)");
                } else {
                    $("#lblrdoAdv").html("Receivable" + "(<b style='color:red'>" + G1Count + "</b>)");
                    $("#lblrdoOS").html("Payable" + "(<b style='color:red'>" + G2Count + "</b>)");
                }

                updateLabelColumn("lblG1TotalBalance", G1Bal);
                updateLabelColumn("lblG2TotalOS", G2Bal);
                updateLabelColumn("lblG2Balance", G2Bal);
                //showErrorSnackbar("adv : " + $("#lblAdvDocCount").text());
            }
        });
    }
    function maxCheckGrid1(object) {
        if (parseFloat(object.value) > parseFloat(object.max))
        {
            showErrorSnackbar("Amount Mismatched");
            updateInputColumn(object.id, 0);
        }
        else if (parseFloat(object.value) < 0)
        {
            showErrorSnackbar("Amount Should be greater than Zero");
            updateInputColumn(object.id, 0);
        }
        calculateGrid1Value();
    }
    function maxCheckGrid2(object) {
        var dTotAdjAmt = parseFloat(document.getElementById("txtTotAdjustmentAmount").getAttribute("txttag"));
        //if (parseFloat(dTotAdjAmt) > 0) {
        //    showErrorSnackbar("Amount Mismatched. Adjustment Amount should be greater than zero");
        //    updateInputColumn(object.id, 0);
        //}
        //else
            if (parseFloat(object.value) > parseFloat(object.max)) {
            showErrorSnackbar("Amount Mismatched");
            updateInputColumn(object.id, 0);
        }
        else if (parseFloat(object.value) < 0) {
            showErrorSnackbar("Amount Shold be greater than Zero");
            updateInputColumn(object.id, 0);
        }
        //calculateGrid2Value();
    }

    function GetDocViewData(nMode, strID = null) {
        $.ajax({
            url: Aurl + "collectionpayment/get",
            type: 'get',
            contentType: 'json',
            data: { Mode: nMode, DocPrefix: nDocPrefix, CodeName: "", ID: strID, BranchID: $("#cmbBranch").val(), Date: $("#dtpDate").val() },
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                TableGrid1Data.draw().clear(); TableGrid1Data.draw().clear();
                TableGridtwoData.draw().clear(); TableGridtwoData.draw().clear();
                $.each(data, function (i, items) {

                    $("#txtID").val(items.ID),
                        $("#dtpDate").val(items.DocDate),
                        $("#cmbBranch").val(items.BranchID),
                        $("#lblDocID").val(items.DocID),
                        $("#txtCustomerID").val(items.CustomerID),
                        $("#cmbBeat").val(items.BeatID),
                        $("#cmbSalesman").val(items.SalesmanID),
                        $("#txtRefNo").val(items.RefNo),
                        $("#cmbPaymode").val(items.PaymentModeID),
                        $("#txtStatus").val(items.Status),
                        $("#txtRemarks").val(items.Remarks),
                        $("#txtNarration").val(items.Narration),
                        $("#txtNEFT").val(items.NEFTNo),
                        $("#cmbFromAccount").val(items.BankAccID),
                        $("#cmbChequeNo ").val(items.ChequeID),
                        $("#dtpChequeDate").val(items.ChequeDate),
                        $("#txtIFSC").val(items.IFSC),
                        $("cmbBankName").val(items.BankID),
                        $("#txtBranchName").val(items.Branch);

                        updateInputColumn("txtAmount", items.CollAmt);
                        updateInputColumn("txtVisaPern", items.VisaPern);
                        updateInputColumn("txtVisaAmt", items.VisaAmt);
                    if (items.PaymentModeID == 5) {
                        $("#trVisa").show();
                    } else {
                        $("#trVisa").hide();
                    }
                    var rdo1 = $("#rdoMainTableData").is(":checked");
                    if (rdo1) {
                        $("#txtID").val(items.ID);
                    } else {
                        $("#txtDraftID").val(items.ID);
                    }
                    $("#cmbCreditTerm").val(items.PaymentTermID),$("#cmbPaymode").val(items.PaymentModeID),
                    $("#txtCustomerID").val(items.CustomerID);

                    $("#dtpDate").val(items.DocDate), $("#cmbBranch").val(items.BranchID);

                    $.each(items.lstvPartyDtl, function (i, itemsParty) {
                        $("#txtSearch").val(itemsParty.Name),
                            $("#lblName").text(itemsParty.Code),
                            $("#cmbRating").text(itemsParty.Ratings),
                            $("#lblMob1").text(itemsParty.Mob1),
                            $("#lblGSTIN").text(itemsParty.GSTIN),
                            $("#txtBAdd1").val(itemsParty.Billadd1),
                            $("#txtBAdd2").val(itemsParty.Billadd2),
                            $("#txtBAdd3").val(itemsParty.Billadd3),
                            $("#txtSAdd1").val(itemsParty.Shipadd1),
                            $("#txtSAdd2").val(itemsParty.shipadd2),
                            $("#txtSAdd3").val(itemsParty.Shipadd3),
                            $("#txtPincode").val(itemsParty.Pincode);
                    });
                    var G1So = 1, G2So = 1, G1Bal = 0, G2Bal = 0;
                    var disbfields = nTransMode == 4 || nTransMode == 5 ? "disabled" : "";
                    var g1data = items.lstCollPayDtl.filter(d => d.TypeID == "1");
                    var g2data = items.lstCollPayDtl.filter(d => d.TypeID == "2");
                    //start
                    var G1dataSet = g1data.map(function (Docsitems, nRowIndex) {
                        G1Bal += parseFloat(Docsitems.Balance);
                        return [
                            Docsitems.ID,
                            Docsitems.DocPrefix,
                            Docsitems.FAID,
                            Docsitems.DocValue,
                            (nRowIndex + 1),
                            Docsitems.DocID,
                            Docsitems.Tran_Date,
                            Docsitems.DocRef,
                            Docsitems.TransName,
                            '<label name="G1NetAmount" lbltag="' + Docsitems.NetAmt + '" title="' + Docsitems.NetAmt + '" class="lblsettag" id="dgv1NetAmount' + nRowIndex + '">' + parseFloat(Docsitems.NetAmt).toFixed(DecVal) + '</label>',
                            '<label name="G1Balance" lbltag="' + Docsitems.Balance + '" title="' + Docsitems.Balance + '" class="lblsettag lblHeaderBal" id="dgv1Balance' + nRowIndex + '" refadjid="dgv1AdjAmt' + nRowIndex + '">' + parseFloat(Docsitems.Balance).toFixed(DecVal) + '</label>',
                            '<input type="number" ' + disbfields + ' txttag="' + Docsitems.TotalAdjAmt + '" value="' + parseFloat(Docsitems.TotalAdjAmt).toFixed(DecVal) + '" title="' + Docsitems.TotalAdjAmt + '" name="AdjCollAmtHeader"  class="txtsettag AdjCollAmtHeader gdInput"  id="dgv1AdjAmt' + nRowIndex + '"  min="0" max="' + Docsitems.TotalAdjAmt + '" oninput="maxCheckGrid1(this)"/>'
                        ];
                    });
                    $('#tblGridoneData').DataTable({
                        scrollY: "250px",
                        scrollX: true,
                        scrollCollapse: true,
                        paging: false,
                        destroy: true,
                        data: G1dataSet,
                        fixedColumns: false,
                        searching: false,
                        ordering: false,
                        sorting: true,
                        info: false,
                        columns: [
                            { title: "ID", visible: false, className: "dt-body-left" },
                            { title: "DocPrefix", visible: false, className: "dt-body-left" },
                            { title: "FAID", visible: false, className: "dt-body-left" },
                            { title: "InvDocVal", visible: false, className: "dt-body-left" },
                            { title: "#", className: "dt-body-left", width: "3%" },
                            { title: "Doc ID", className: "dt-body-left", width: "30%" },
                            { title: "Date", className: "dt-body-right", width: "7%" },
                            { title: "Ref No", className: "dt-body-right", width: "6%" },
                            { title: "Doc Type", className: "dt-body-left", width: "6%" },
                            { title: "Doc Value", className: "dt-body-right", width: "7%" },
                            { title: "Outstandings", className: "dt-body-right", width: "7%" },
                            { title: "Adj Amt", className: "dt-body-right", width: "6%" },
                        ]
                    });
                    TableGrid1Data = $('#tblGridoneData').DataTable();
                    //end
                    //g2start
                    console.log("g2 ", g2data);
                    var G2dataSet = g2data.map(function (Docsitems, nRowIndex) {
                        G2Bal += parseFloat(Docsitems.Balance);
                        var rmos = parseFloat(Docsitems.Balance) - parseFloat(Docsitems.TotalAdjAmt);
                        return [
                            Docsitems.ID,
                            Docsitems.DocPrefix,
                            Docsitems.FAID,
                            Docsitems.DocValue,
                            (nRowIndex + 1),
                            //Docsitems.DocID,
                            items.DocPrefix == "15" ? '<a href="javascript:void(0)" style="cursor: pointer;" class="clsInvoiceCollection">' + Docsitems.DocID + '</a>' : Docsitems.DocID,
                            Docsitems.Tran_Date,
                            Docsitems.DocRef,
                            Docsitems.TransName,
                            '<label name="G2NetAmount" lbltag="' + Docsitems.NetAmt + '" title="' + Docsitems.NetAmt + '" class="lblsettag" id="dgv2NetAmount' + nRowIndex +  '">' + parseFloat(Docsitems.NetAmt).toFixed(DecVal) + '</label>',
                            '<label name="G2OS" lbltag="' + Docsitems.Balance + '" title="' + Docsitems.Balance + '" class="lblsettag lblFooterBal" id="dgv2Balance' + nRowIndex +  '" refadjid="dgv2CollAmt' + nRowIndex +  '">' + parseFloat(Docsitems.Balance).toFixed(DecVal) + '</label>',
                            '<input type="number" ' + disbfields + ' txttag="' + Docsitems.CollAmt + '" title="' + Docsitems.CollAmt + '" value="' + parseFloat(Docsitems.CollAmt).toFixed(DecVal) + '" name="AdjCollAmtFooter"  class="txtsettag AdjCollAmtFooter gdInput"  id="dgv2CollAmt' + nRowIndex +  '"  min="0" max="' + Docsitems.TotalAdjAmt + '"/>',// oninput="maxCheckGrid2(this)"
                            '<input type="number" ' + disbfields + ' txttag="' + Docsitems.AdjAmt + '" title="' + Docsitems.AdjAmt + '" value="' + parseFloat(Docsitems.AdjAmt).toFixed(DecVal) + '" name="AdjAmt"  class="txtsettag AdjFooter gdInput"  id="dgv2AdjAmt' + nRowIndex +  '"/>',
                            '<input type="number" ' + disbfields + ' txttag="' + Docsitems.DiscPern + '" title="' + Docsitems.DiscPern + '" value="' + parseFloat(Docsitems.DiscPern).toFixed(DecVal) + '" name="AdjDiscPern"  class="txtsettag AdjDiscPern gdInput"  id="dgv2DiscPern' + nRowIndex +  '"/></br><input type="number" ' + disbfields + ' txttag="' + Docsitems.DiscAmt + '" title="' + Docsitems.DiscAmt + '" value="' + parseFloat(Docsitems.DiscAmt) + '" name="AdjDiscAmt"  class="txtsettag AdjDiscAmt gdInput"  id="dgv2DiscAmt' + nRowIndex +  '"/>',
                            '<select name="FullyAdj" ' + disbfields + ' id="dgvFulladj' + nRowIndex + '" class="gdInput cmbFullyAdj"><option value="0">No</option><option value="1">Yes</option></select>' +
                            '<br/><label name="WriteoffAmt"  style="padding-top:10px" lbltag="0" title="0" class="lblsettag dgv2WriteoffAmt" id="dgv2WriteoffAmt' + nRowIndex + '">' + parseFloat(0).toFixed(DecVal) + '</label>',
                            '<label name="G2TotalAdjAmount" lbltag="' + Docsitems.TotalAdjAmt + '" title="' + Docsitems.TotalAdjAmt + '" class="lblsettag dgv2lblTotAdjAmt" id="dgv2TotalAdjAmount' + nRowIndex +  '">' + parseFloat(Docsitems.TotalAdjAmt).toFixed(DecVal) + '</label>',
                            '<label name="G2Balance" lbltag="' + rmos + '" title="' + rmos + '" class="lblsettag" id="dgv2Bal' + nRowIndex +  '">' + parseFloat(rmos).toFixed(DecVal) + '</label>',
                        ];
                    });
                    $('#tblGridtwoData').DataTable({
                        scrollY: "250px",
                        scrollX: true,
                        scrollCollapse: true,
                        paging: false,
                        destroy: true,
                        data: G2dataSet,
                        fixedColumns: false,
                        searching: false,
                        ordering: false,
                        sorting: true,
                        info: false,
                        columns: [
                            { title: "ID", visible: false, className: "dt-body-left" },
                            { title: "DocPrefix", visible: false, className: "dt-body-left" },
                            { title: "FAID", visible: false, className: "dt-body-left" },
                            { title: "InvDocVal", visible: false, className: "dt-body-left" },
                            { title: "#", className: "dt-body-left", width: "3%" },
                            { title: "Doc ID", className: "dt-body-left", width: "30%" },
                            { title: "Date", className: "dt-body-right", width: "7%" },
                            { title: "Ref No", className: "dt-body-right", width: "6%" },
                            { title: "Doc Type", className: "dt-body-left", width: "6%" },
                            { title: "Doc Value", className: "dt-body-right", width: "7%" },
                            { title: "Outstandings", className: "dt-body-right", width: "7%" },
                            { title: "Coll Amt", className: "dt-body-right", width: "6%" },
                            { title: "Adj Amt(+/-)", className: "dt-body-right", width: "6%" },
                            { title: "Disc %/₹", className: "dt-body-right", width: "6%" },
                            { title: "Full Adj", className: "dt-body-right", width: "6%" },
                            { title: "Total Amt Adj", className: "dt-body-right", width: "6%" },
                            { title: "Balance", className: "dt-body-right", width: "6%" },
                        ]
                    });
                    TableGridtwoData = $('#tblGridtwoData').DataTable();
                    //g2end
                    //$.each(items.lstCollPayDtl, function (i, Docsitems) {
                    //    if (Docsitems.TypeID == "1") {
                    //        TableGrid1Data.row.add([
                    //            Docsitems.ID,
                    //            Docsitems.DocPrefix,
                    //            Docsitems.FAID,
                    //            Docsitems.DocValue,
                    //            G1So,
                    //            Docsitems.DocID,
                    //            Docsitems.Tran_Date,
                    //            Docsitems.DocRef,
                    //            Docsitems.TransName,
                    //            '<label name="G1NetAmount" lbltag="' + Docsitems.NetAmt + '" title="' + Docsitems.NetAmt + '" class="lblsettag" id="dgv1NetAmount' + i + '">' + parseFloat(Docsitems.NetAmt).toFixed(DecVal) + '</label>',
                    //            '<label name="G1Balance" lbltag="' + Docsitems.Balance + '" title="' + Docsitems.Balance + '" class="lblsettag lblHeaderBal" id="dgv1Balance' + i + '" refadjid="dgv1AdjAmt' + i + '">' + parseFloat(Docsitems.Balance).toFixed(DecVal) + '</label>',
                    //            '<input type="number" ' + disbfields + ' txttag="' + Docsitems.TotalAdjAmt + '" value="' + parseFloat(Docsitems.TotalAdjAmt).toFixed(DecVal) + '" title="' + Docsitems.TotalAdjAmt + '" name="AdjCollAmtHeader"  class="txtsettag AdjCollAmtHeader gdInput"  id="dgv1AdjAmt' + i + '"  min="0" max="' + Docsitems.TotalAdjAmt + '" oninput="maxCheckGrid1(this)"/>'
                    //        ]).draw(false);
                    //        G1Bal += parseFloat(Docsitems.Balance);
                    //        G1So++;
                    //    }
                    //    else {
                    //        var rmos = parseFloat(Docsitems.Balance) - parseFloat(Docsitems.TotalAdjAmt);
                    //        TableGridtwoData.row.add([
                    //            Docsitems.ID,
                    //            Docsitems.DocPrefix,
                    //            Docsitems.FAID,
                    //            Docsitems.DocValue,
                    //            G2So,
                    //            //Docsitems.DocID,
                    //            items.DocPrefix == "15" ? '<a href="javascript:void(0)" style="cursor: pointer;" class="clsInvoiceCollection">' + Docsitems.DocID + '</a>' : Docsitems.DocID,
                    //            Docsitems.Tran_Date,
                    //            Docsitems.DocRef,
                    //            Docsitems.TransName,
                    //            '<label name="G2NetAmount" lbltag="' + Docsitems.NetAmt + '" title="' + Docsitems.NetAmt + '" class="lblsettag" id="dgv2NetAmount' + i + '">' + parseFloat(Docsitems.NetAmt).toFixed(DecVal) + '</label>',
                    //            '<label name="G2OS" lbltag="' + Docsitems.Balance + '" title="' + Docsitems.Balance + '" class="lblsettag lblFooterBal" id="dgv2Balance' + i + '" refadjid="dgv2CollAmt' + i + '">' + parseFloat(Docsitems.Balance).toFixed(DecVal) + '</label>',
                    //            '<input type="number" ' + disbfields + ' txttag="' + Docsitems.CollAmt + '" title="' + Docsitems.CollAmt + '" value="' + parseFloat(Docsitems.CollAmt).toFixed(DecVal) + '" name="AdjCollAmtFooter"  class="txtsettag AdjCollAmtFooter gdInput"  id="dgv2CollAmt' + i + '"  min="0" max="' + Docsitems.TotalAdjAmt + '"/>',// oninput="maxCheckGrid2(this)"
                    //            '<input type="number" ' + disbfields + ' txttag="' + Docsitems.AdjAmt + '" title="' + Docsitems.AdjAmt + '" value="' + parseFloat(Docsitems.AdjAmt).toFixed(DecVal) +'" name="AdjAmt"  class="txtsettag AdjFooter gdInput"  id="dgv2AdjAmt' + i + '"/>',
                    //            '<input type="number" ' + disbfields + ' txttag="' + Docsitems.DiscPern + '" title="' + Docsitems.DiscPern + '" value="' + parseFloat(Docsitems.DiscPern).toFixed(DecVal) + '" name="AdjDiscPern"  class="txtsettag AdjDiscPern gdInput"  id="dgv2DiscPern' + i + '"/></br><input type="number" ' + disbfields +' txttag="' + Docsitems.DiscAmt + '" title="' + Docsitems.DiscAmt + '" value="' + parseFloat(Docsitems.DiscAmt) +'" name="AdjDiscAmt"  class="txtsettag AdjDiscAmt gdInput"  id="dgv2DiscAmt' + i + '"/>',
                    //            '<select name="FullyAdj" ' + disbfields +' id="dgvFulladj' + i + '" class="gdInput"><option value="0">No</option><option value="1">Yes</option></select>',
                    //            '<label name="G2TotalAdjAmount" lbltag="' + Docsitems.TotalAdjAmt + '" title="' + Docsitems.TotalAdjAmt + '" class="lblsettag" id="dgv2TotalAdjAmount' + i + '">' + parseFloat(Docsitems.TotalAdjAmt).toFixed(DecVal) + '</label>',
                    //            '<label name="G2Balance" lbltag="' + rmos + '" title="' + rmos +'" class="lblsettag" id="dgv2Bal' + i + '">' + parseFloat(rmos).toFixed(DecVal) + '</label>',
                    //        ]).draw(false);
                    //        G2Bal += parseFloat(Docsitems.Balance);
                    //        G2So++;
                    //    }
                    //});
                    //lblG1TotalBalance,lblG1AdjAmt
                    var G1Count = TableGrid1Data.rows().count();
                    var G2Count = TableGridtwoData.rows().count();
                    //$("#lblAdvDocCount").text("(" + G1Count + ")"); $("#lblOSDocCount").text("(" + G2Count + ")");

                    if (nDocPrefix == 19) {
                        $("#lblrdoAdv").html("Payable" + "(<b style='color:red'>" + G1Count + "</b>)");
                        $("#lblrdoOS").html("Receivable" + "(<b style='color:red'>" + G2Count + "</b>)");
                    } else {
                        $("#lblrdoAdv").html("Receivable" + "(<b style='color:red'>" + G1Count + "</b>)");
                        $("#lblrdoOS").html("Payable" + "(<b style='color:red'>" + G2Count + "</b>)");
                    }
                    updateLabelColumn("lblG1TotalBalance", G1Bal);
                    updateLabelColumn("lblG2TotalOS", G2Bal);
                    setTimeout(() => {
                        calculateGrid1Value();
                        //calculateGrid2Value();
                    }, 300);
                    SumG2FooterLabels();
                });
            }
        });
    }
    $('#btnFilter').click(function (e) {
        GetFilterData(1);
    });
    var Showall = '@Session["Showallstatus"]';
    $("#chkShowAll").prop("checked", Showall == '1');
    function GetFilterData(ClickType = 0) {//arrVendorName,divErrFTo,divErrFFrom,divErrFParty        
        var IsValid = true;
        $(".clrdivs").html("");
        if ($("#txtFilterParty").val() != "") {
            const exists = arrVendorName.indexOf($("#txtFilterParty").val().trim()) !== -1;
            if (!exists) {
                IsValid = false;
                $("#divErrFParty").html("Select Party Name from list");
            }
        }
        if ($("#dtpFFrom").val() == "") {
            IsValid = false;
            $("#divErrFFrom").html("From date should not be empty");
        }
        if ($("#dtpFTo").val() == "") {
            IsValid = false;
            $("#divErrFTo").html("To date should not be empty");
        }
        if ($("#dtpFFrom").val() > $("#dtpFTo").val()) {
            IsValid = false;
            $("#divErrFFrom").html("From date should be lessthan To Date");
        }
        if (IsValid) {
            var strBranch = 0, strParty = $("#txtFilterParty").val(), dFrom = $("#dtpFFrom").val(),
                dTo = $("#dtpFTo").val(), chkshow = $("#chkShowAll").is(":checked") ? "1" : "0";
            $.ajax({
                url: Aurl + "collectionpayment/getfilterdata",
                type: 'get',
                contentType: 'json',
                data: { Mode: 1, TransID: nDocPrefix, Party: strParty, FromDate: dFrom, ToDate: dTo, Showall: chkshow },
                xhrFields: {
                    withCredentials: true
                },
                success: function (data) {
                    Table.draw().clear(); Table.draw().clear();
                    var CollPYjsData = eval(data);
                    var searchValue = '';
                    if ($.fn.DataTable.isDataTable('#tblMasterData')) {
                        searchValue = $('#tblMasterData').DataTable().search(); // get current search term
                    }
                    $('#tblMasterData').DataTable({pageLength: ItemsperPage,lengthMenu: [[10, 20, 50, 100, -1], [10, 20, 50, 100, "All"]],
                        scrollY: "450px",
                        scrollX: true,
                        scrollCollapse: true,
                        paging: true,
                        destroy: true,
                        data: CollPYjsData,
                        fixedColumns: false,
                        searching: true,
                        ordering: true,
                        sorting: false,
                        columns: [
                            { "data": "ID", "autoWidth": true, "visible": false, className: "dt-body-left" },//0
                            { "data": "StatusID", "autoWidth": true, "visible": false, className: "dt-body-left" },//0
                            { "data": "DocId", "autoWidth": true, className: "dt-body-left" },
                            { "data": "DocDate", "autoWidth": true, className: "dt-body-left" },//2
                            { "data": "RefNo", "autoWidth": true, className: "dt-body-left" },//3
                            { "data": "PartyName", "autoWidth": true, className: "dt-body-left" },//4
                            { "data": "PaymentModeID", "autoWidth": true, className: "dt-body-left" },//5
                            { "data": "CollAmt", "autoWidth": true, className: "dt-body-right" },//8
                            { "data": "Balance", "autoWidth": true, className: "dt-body-right" },//9
                            { "data": "Status", "autoWidth": true, className: "dt-body-left" },//10
                            {
                                className: "dt-body-left",
                                "mRender": function (data, type, value) {
                                    var _action = '<label title="' + value.CDate + '">' + value.CBy + '</label>';
                                    return _action;
                                }
                            },
                            {
                                className: "dt-body-center", orderable: false,
                                "mRender": function (data, type, value) {
                                    var _action = '<a href="javascript:void(0)" style="cursor: pointer;"><span class="glyphicon glyphicon-eye-open clsView" style="font-size:16px" title="View"></span></a>';
                                    return _action;
                                }, "visible": $("#txtViewID").val() == 0 ? false : true
                            },
                            {
                                className: "dt-body-center",
                                orderable: false,
                                render: function () {
                                    return `
            <button class="btn btn-default btn-xs action-btn">&#8942;</button>
        `;
                                }
                            }
                  //              render: function (data, type, row) {

                  //                  var status = row.Status;
                  //                  var edit = '', cancel = '', view = '', variant = '', Print = '', Preview = '', PDF = '';
                  //                  if ($("#txtViewID").val() == 1) {
                  //                      var Print = '<a class="dropdown-item clsprint" href="javascript:void(0)">🖨 Print</a>';
                  //                      var Preview = '<a class="dropdown-item clspreview" href="javascript:void(0)#">🖨 Preview</a>';
                  //                      var PDF = '<a class="dropdown-item clspdf" href="javascript:void(0)">📕 PDF</a>';
                  //                  }
                  //                  if (status !== 'Amended' && status !== 'Cancelled') {
                  //                      if ($("#txtModifyID").val() != 0)
                  //                          edit = '<a class="dropdown-item clsEdit" href="javascript:void(0)">✏️ Edit</a>';
                  //                      if ($("#txtCancelID").val() != 0)
                  //                          cancel = '<a class="dropdown-item clsCancel" href="javascript:void(0)">❌ Cancel</a>';
                  //                  }                                   
                  //                  return `
                  //<div class="dropdown">
                  //    <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown">
                  //        &#8942;
                  //    </button>
                  //    <ul class="dropdown-menu  action-dropdown" style="right:0;left:auto;">
                  //        ${edit ? `<li>${edit}</li>` : ''}
                  //        ${cancel ? `<li>${cancel}</li>` : ''}
                  //        ${variant ? `<li>${variant}</li>` : ''}
                  //        ${Print ? `<li>${Print}</li>` : ''}
                  //        ${Preview ? `<li>${Preview}</li>` : ''}
                  //        ${PDF ? `<li>${PDF}</li>` : ''}
                  //    </ul>
                  //</div>`;
                  //              }
                  //          }                            
                        ],
                        initComplete: function () {
                            // Re-apply search value after table is fully initialized
                            this.api().search(searchValue).draw();
                        }
                    });
                    Table = $('#tblMasterData').DataTable();
                    if (!Table.data().any()) {
                        if (ClickType == 1)
                            showErrorSnackbar("No records found");
                    }
                        //$.each(data, function (i, items) {
                        //    Table.row.add([
                        //        items.ID,
                        //        items.DocId,
                        //        items.DocDate,
                        //        items.RefNo,
                        //        items.PartyName,
                        //        items.PaymentModeID,
                        //        items.CollAmt,
                        //        items.Balance,
                        //        items.Status,
                        //        items.StatusID == '2' || items.Status == '4' ? '' : '<a href="javascript:void(0) style="cursor: pointer;"><span class="glyphicon glyphicon-pencil clsEdit" style="font-size:16px" title="Edit"></span></a>',
                        //        items.Status == '2' || items.Status == '4' ? '' : '<a href="javascript:void(0) style="cursor: pointer;"><span class="glyphicon glyphicon-remove-circle clsCancel" style="font-size:16px" title="Cancel"></span></a>',
                        //        '<a href="javascript:void(0) style="cursor: pointer;"><span class="glyphicon glyphicon-eye-open clsView" style="font-size:16px" title="View"></span></a>',
                        //    ]).draw(false);
                        //});

                }
            });
        }
    }
   

    function getActionsByRole(role, row) {
        let actions = [];

        if (role.canEdit && row.Status !== 'Cancelled' && row.Status !== 'Amended')
            actions.push({ cls: "clsEdit", label: "✏️ Edit" });

        if (role.canCancel && row.Status !== 'Cancelled')
            actions.push({ cls: "clsCancel", label: "❌ Cancel" });

        if (role.canVariant)
            actions.push({ cls: "clsVariant", label: "📄 Variant" });

        if (role.canPrint)
            actions.push({ cls: "clsprint", label: "<i class='fa-solid fa-print'></i> Print" });

        if (role.canPreview)
            actions.push({ cls: "clspreview", label: "<i class='fa-solid fa-print'></i> Preview" });

        if (role.canPDF)
            actions.push({ cls: "clspdf", label: "<i class='fa-regular fa-file-pdf' style='color:brown'></i> PDF" });

            actions.push({ cls: "clsemail", label: "<i class='fa-solid fa-envelope' style='color:brown'></i> Mail" });

            actions.push({ cls: "clswhatsapp", label: "<i class='fa-brands fa-whatsapp' style='color:green'></i> Whatsapp" });

        return actions;
    }

    

    $("#rdoMainTableData,#rdoPOTableData,#rdoDraftTableData").click(function () {
        //GetData(6);
        GetFilterData(1);
    });
    $('#tblGridtwoData tbody').on('click', '.clsInvoiceCollection', function (e) {
        $(".clrdivs").html("");
        rowdata = TableGridtwoData.row($(this).parents('tr')).data();
        var ID = rowdata[0];//[0];
        InvoiceCollectionModalPopup(ID)
    });
    $('#tblMasterData tbody').on('click', '.clsView', function (e) {
        $(".clrdivs").html("");
        rowdata = Table.row($(this).parents('tr')).data();
        var selrow = Table.row($(this).parents('tr')).index();
        var ID = rowdata.ID;//[0];
        nTransMode = 5;
        $("#txtID").val(ID);
        GetDocViewData(3, ID);
        $(".FormclrField,.FormclrcmbField").prop("disabled", true);
        $("#btnSave,#btnClear,#btnDraft").prop("disabled", true);
        $("#btnPreview,#btnPDF,#btnPrint").prop("disabled", false);
        $("#btnPreview,#btnPDF,#btnPrint").show();
        $("#btnSave,#btnClear,#btnDraft").hide();
        $("#dvMain").show();
        $("#dvDocuments").hide();
        $("#btnEmail,#btnWhatsapp").show();
        $("#MainHeading").text("View " + $("#txtFormName").val());
    });
    $(document).on('click', '.clsEdit', function (e) {//'#tblMasterData tbody'
        $(".clrdivs").html("");
        rowdata = window.__SelectedRowData;//Table.row($(this).parents('tr')).data();
        //var selrow = Table.row($(this).parents('tr')).index();
        var ID = rowdata.ID;//[0];
        var sts = rowdata.Status;//[8];
        if (sts != "Cancelled") {
        $("#txtID").val(ID);
            nTransMode = 2;

            //alert("Bill Table : " + rdo1 + ", Draft : " + rdo2);
            GetDocViewData(3, ID);
            nTransMode = 2;
            $(".FormclrField,.FormclrcmbField").prop("disabled", false);
            $("#btnPreview,#btnPDF,#btnClear,#btnPrint").prop("disabled", true);
            $("#btnPreview,#btnPDF,#btnPrint,#btnClear,#btnDraft").hide();
            $("#btnSave").show();
            $("#btnSave,#btnClose").prop("disabled", false);
            $("#dvMain").show();
            $("#dvDocuments").hide();
            $("#btnEmail,#btnWhatsapp").hide();
            $("#MainHeading").text("Modify " + $("#txtFormName").val());
        }
        else {
            showErrorSnackbar("Cannot Modify.This document already cancelled");
        }
    });
   

    $(document).on('click', '.clsCancel', function (e) {
        $(".clrdivs").html("");
        var rdo1 = $("#rdoMainTableData").is(":checked");
        rowdata = window.__SelectedRowData;// Table.row($(this).parents('tr')).data();
        //var selrow = Table.row($(this).parents('tr')).index();
        var ID = rowdata.ID;//[0];
        var sts = rowdata.Status;//[8];
        if (sts != "Cancelled") {
            $("#txtID").val(ID);
            $("#MainHeading").text("Cancel " + $("#txtFormName").val());
            nTransMode = 4;
            GetDocViewData(3, ID);
            $(".FormclrField,.FormclrcmbField").prop("disabled", true);
            $("#btnPreview,#btnPDF,#btnClear,#btnDraft,#btnPrint").prop("disabled", true);
            $("#btnSave").prop("disabled", false);
            $("#btnPreview,#btnPDF,#btnPrint,#btnClear,#btnDraft").hide();
            $("#btnSave").show();
            $("#dvMain").show();
            $("#dvDocuments").hide();
            $("#btnEmail,#btnWhatsapp").hide();
        }
        else {
            showErrorSnackbar("This document already cancelled");
        }
    });

    $(document).on('click', '.clspreview', function (e) {//'#tblMasterData tbody'
        rowdata = window.__SelectedRowData;//Table.row($(this).parents('tr')).data();
        //var selrow = Table.row($(this).parents('tr')).index();
        var ID = rowdata.ID;//[0];
        var sts = rowdata.StatusID;//[9];
        $("#txtID").val(ID);
        $("#txtStatus").val(sts);
        $("#btnPreview").click();
    });
    $(document).on('click', '.clspdf', function (e) {//'#tblMasterData tbody'
        rowdata = window.__SelectedRowData;//Table.row($(this).parents('tr')).data();
        //var selrow = Table.row($(this).parents('tr')).index();
        var ID = rowdata.ID;//[0];
        var sts = rowdata.StatusID;//[9];
        $("#txtID").val(ID);
        $("#txtStatus").val(sts);
        $("#btnPDF").click();
    });
    $(document).on('click', '.clsemail', function (e) {//'#tblMasterData tbody'
        rowdata = window.__SelectedRowData;//Table.row($(this).parents('tr')).data();
        //var selrow = Table.row($(this).parents('tr')).index();
        var ID = rowdata.ID;//[0];
        var sts = rowdata.CurrentStatus;//[9];
        $("#txtID").val(ID);
        $("#txtStatus").val(sts);
        $("#btnEmail").click();
    });
    $(document).on('click', '.clswhatsapp', function (e) {//'#tblMasterData tbody'
        rowdata = window.__SelectedRowData;//Table.row($(this).parents('tr')).data();
        //var selrow = Table.row($(this).parents('tr')).index();
        var ID = rowdata.ID;//[0];
        var sts = rowdata.CurrentStatus;//[9];
        $("#txtID").val(ID);
        $("#txtStatus").val(sts);
        $("#btniframeWhatsapp").click();
    });
    $(document).on('click', '.clsprint', function (e) {//'#tblMasterData tbody'
        rowdata = window.__SelectedRowData;//Table.row($(this).parents('tr')).data();
        //var selrow = Table.row($(this).parents('tr')).index();
        var ID = rowdata.ID;//[0];
        var sts = rowdata.StatusID;//[9];
        $("#txtID").val(ID);
        $("#txtStatus").val(sts);
        $("#btnPrint").click();
    });
    $("#btnClear").click(function () {
        //ClearForm();
        if (cfFocus != 3) { ClearConfirmDialogMsg("Do you want to clear?"); } else { ClearForm(); }
    });
    $("#txtClosingBalance,#txtTotAdjustmentAmount,#txtRemainingAmount,#txtAdjustedAmount,#txtBalance").prop("disabled", true);
    function ClearForm() {
        ProductRID = 0;
        $(".FormclrField").val("");
        $(".FormclrcmbField").val(0);
        $("#lblBalance").text("0.00");
        $(".clrdivs").html("");
        $(".lblPT").text("0.00");
        // ceil - always Up value, floor - always down value
        $("#txtRoundOff").val("0.00"); $("#lblRoundNet").text("0.00");
        $("#lblPTCount").text("0");
        $("#lblName,#lblProdCodeAS").text(""), $("#cmbRating").text(""), $("#lblMob1").text(""), $("#lblGSTIN").text("");
        $("#btnEmail,#btnWhatsapp").hide();
        Table.draw().clear();
        TableGrid1Data.draw().clear(); TableGrid1Data.draw().clear();
        TableGridtwoData.draw().clear(); TableGridtwoData.draw().clear();
        GetData(1);
        //GetData(6);
        SetTagZero();
        setDate("dtpDate", 0);
        $("#txtNoofCopies").val("1");
        SetFilterDate();
        $("#cmbBranch").val(DefBranch);
        $("#cmbFromAccount").val(DefBankAcc);
        setTimeout(function () {
            GetFilterData();
            //GetData(2, DefBranch, $("#dtpDate").val());
        }, 500);
        nIsDraft = 0;
        DocsArray = [];
        TempProd = [];
        if (nTransMode != 1) {
            $("#dvMain").hide();
            $("#dvDocuments").show();
        }
        if (nDocPrefix == 19) {
            $("#lblrdoAdv").text("Payable");
            $("#lblrdoOS").text("Receivable");
        } else {
            $("#lblrdoAdv").text("Receivable");
            $("#lblrdoOS").text("Payable");
        }
        $("#trVisa").hide();
        $(".FormclrField,.FormclrcmbField,#btnSave,#btnClear,#btnDraft,#btnClose").prop("disabled", false);
        $("#btnPreview,#btnPDF,#btnPrint").prop("disabled", true);
        $("#btnPreview,#btnPDF,#btnPrint").hide();
        $("#btnSave,#btnClear,#btnDraft").show();
        $("#txtClosingBalance,#txtTotAdjustmentAmount,#txtRemainingAmount,#txtAdjustedAmount,#txtBalance").prop("disabled", true);
        $("#MainHeading").text($("#txtFormName").val());
        $("#txtSearch").focus();
    }
    function displayResult(item) {
        $('.alert').show().html('You selected <strong>' + item.value + '</strong>: <strong>' + item.text + '</strong>');
    }
    function SetAutlistforFields() {
        ////Search
        //var txtName1 = $('#txtSearch');
        //autocomplete = txtName1.typeahead({ scrollBar: true, onSelect: displayResult });
        //autocomplete.data('typeahead').source = null;
        //autocomplete.data('typeahead').source = arrVendor;
        //txtName1 = $('#txtFilterParty');
        //autocomplete = txtName1.typeahead({ scrollBar: true, onSelect: displayResult });
        //autocomplete.data('typeahead').source = null;
        //autocomplete.data('typeahead').source = arrVendor;
        $("#txtSearch").autocomplete({
            minLength: 0, autoFocus: true,
            source: arrVendor,
            //focus: function (event, ui) {
            //    $("#txtSearch").val(ui.item.name);
            //    return false;
            //},
            select: function (event, ui) {
                $("#txtSearch").val(ui.item.name);
                GetData(2, ui.item.code);
                //$("#txtRemarks").val(ui.item.id);
                return false;
            },
        }).autocomplete("instance")._renderItem = function (ul, item) {
            return $("<li class='each'>")
                .append("<div class='acItem'><span class='name'>" +
                    item.label + "</span></div>")
                .appendTo(ul);
        };
        $("#txtFilterParty").autocomplete({
            minLength: 0, autoFocus: true,
            source: arrVendor,
            //focus: function (event, ui) {
            //    $("#txtFilterParty").val(ui.item.name);
            //    return false;
            //},
            select: function (event, ui) {
                $("#txtFilterParty").val(ui.item.name);
                //$("#txtRemarks").val(ui.item.id);
                return false;
            },
        }).autocomplete("instance")._renderItem = function (ul, item) {
            return $("<li class='each'>")
                .append("<div class='acItem'><span class='name'>" +
                    item.label + "</span></div>")
                .appendTo(ul);
        };

        //setTimeout(function () {
        //    $("#txtFilterParty,#txtSearch").val("");
        //    $('input#txtFilterParty').autocomplete("search");
        //    $('input#txtSearch').autocomplete("search");
        //    var esc = $.Event("keydown", { keyCode: 27 });
        //    $("#txtFilterParty,#txtSearch").trigger(esc);
        //}, 100);
    }
    $("#btnPaymentAccept").click(function () {
        nIsDraft = 0;
        PaymentAccept = true;
        if (PaymodeValidation()) {
            //SaveData();
            if (cfFocus != 3) {
                ConfirmDialogMsg("Do you want to save data?");
            } else {
                SaveData();

            }
        }

    });
    function PaymodeValidation() {
        $(".clrdivs").html("");
        var IsValid = true;
        var PMID = $("#cmbPaymode").val();
        if (nDocPrefix == 19) {//COLLECTION
            if (PMID == "2" || PMID == "3" || PMID == "4" || PMID == "5") // CHEQUE & DD
            {
                //txtNEFT,divErrNEFT
                if ($("#txtNEFT").val() == "") {
                    IsValid = false;
                    $("#divErrNEFT").html("Cheque/Ref No should not be empty");
                    showErrorSnackbar("Cheque/Ref No should not be empty");
                }
            }
            if (PMID == "2") {
                if ($("#dtpChequeDate").val() == "") {
                    IsValid = false;
                    $("#divErrChequeDate").html("Cheque Date should not be empty");
                    showErrorSnackbar("Cheque Date should not be empty");
                }
            }
        }
        else {//PAYMENT
            if (PMID == "2") // CHEQUE & DD
            {
                if ($("#cmbChequeNo").val() == 0) {
                    IsValid = false;
                    $("#divErrChequeNo").html("Select Cheque No");
                    showErrorSnackbar("Select Cheque No");
                }
                if ($("#dtpChequeDate").val() == "") {
                    IsValid = false;
                    $("#divErrChequeDate").html("Cheque Date should not be empty");
                    showErrorSnackbar("Cheque Date should not be empty");
                }
            }
            if (PMID == "4" || PMID == "5")
            {
                //txtNEFT,divErrNEFT
                if ($("#txtNEFT").val() == "") {
                    IsValid = false;
                    $("#divErrNEFT").html("Cheque/Ref No should not be empty");
                    showErrorSnackbar("Cheque/Ref No should not be empty");
                }
            }
        }
        return IsValid;
    }
    $("#btnSave").click(function () {
        //SaveData()
        nIsDraft = 0;
        PaymentAccept = false;
        if (cfFocus != 3) {
            if (SaveValidation()) {
                ConfirmDialogMsg("Do you want to save data?");
            }
        } else {
            if (SaveValidation()) {
                SaveData();
            }
        }
    });
    var PaymentAccept = false;
    function SaveValidation() {
        var IsValid = true;
        $(".clrdivs").html("");
        if ($("#txtSearch").val() == "") {
            IsValid = false;
            $("#divErrSearch").html("Party should not be empty");
            showErrorSnackbar("Party should not be empty");
        }
        else {
            const exists = arrVendorName.indexOf($("#txtSearch").val().trim()) !== -1;
            if (!exists) {
                IsValid = false;
                $("#divErrSearch").html("Select Party Name from list");
                showErrorSnackbar("Select Party Name from list");
            }
        }
        //if ($("#cmbBranch").val() == 0) {
        //    IsValid = false;
        //    $("#divErrBranch").html("Select Branch");
        //    showErrorSnackbar("Select Branch");
        //}

        if ($("#dtpDate").val() == "") {
            IsValid = false;
            $("#divErrDate").html("Date should not be empty");
            showErrorSnackbar("Date should not be empty");
        }

        if ($("#cmbPaymode").val() == 0 || $("#cmbPaymode").val() == "" || $("#cmbPaymode").val() == null) {
            IsValid = false;
            $("#divErrPaymode").html("Select Payment mode");
            showErrorSnackbar("Select Payment mode");
        }
        else {
            if (nTransMode == "1" || nTransMode == "2") {
                if ($("#cmbPaymode").val() != 9) {
                    var colamt = document.getElementById("txtAmount").getAttribute("txttag")
                    if (parseFloat(colamt) <= 0) {
                        IsValid = false;
                        $("#divErrAmount").html("Amount should be greater than Zero");
                        showErrorSnackbar("Amount should be greater than Zero");
                    }
                    else {
                        if (($("#cmbPaymode").val() != 9 && $("#cmbPaymode").val() != 1) && !PaymentAccept) {
                            PaymodeConfig();
                            IsValid = false;
                            modalPayment.style.display = "block";
                        }
                    }
                }
            }
        }
        var RemAmt = parseFloat(document.getElementById("txtRemainingAmount").getAttribute("txttag"));
        if (RemAmt < 0) {
            IsValid = false;            
            $("#divErrRemainingAmount").html("Remaining Amount should be Zero or greater than Zero");
            showErrorSnackbar("Remaining Amount should be Zero or greater than Zero");
        }
        if (IsValid) {
            var adjverified = true;
            var collamt = parseFloat(document.getElementById("txtAmount").getAttribute("txttag"));
            var G2AdjAmt = parseFloat(document.getElementById("lblG2TotAdjAmt").getAttribute("lbltag"));
            var G1AdjAmt = parseFloat(document.getElementById("lblG1AdjAmt").getAttribute("lbltag"));

                if (G1AdjAmt > G2AdjAmt) {
                    adjverified = false;
                    var Advgridtext = $("#lblrdoAdv").text();
                    var Osgridtext =$("#lblrdoOS").text();
                    showErrorSnackbar(Osgridtext + " Adjusted Amount  should be greater than or equal to " + Advgridtext + " Adusted Amount ");
                }
            if (adjverified) {
               
                if (RemAmt > 0) {
                    //AdvanceConfirmDialogMsg("Advance Amount Available (" + RemAmt + "). Do you want to proceed");
                    var AdvAll = confirm("Advance Amount Available (" + parseFloat(RemAmt).toFixed(DecVal) + "). Do you want to proceed?");
                    if (!AdvAll) {
                        IsValid = false;
                    }
                }
            }
            else {
                IsValid = false;
            }
        }
        if (IsValid) {
            var collamt = parseFloat(document.getElementById("txtAmount").getAttribute("txttag"));
            if ($("#cmbPaymode").val() == 9) {
                if (collamt > 0) {
                    $("#divErrAmount").html("Collection Amount should be zero");
                    showErrorSnackbar("Collection Amount should be zero");
                    IsValid = false;
                }
            }
        }
        return IsValid;
    }
    $("#btnDraft").click(function () {
        //addProdinArray();
        nIsDraft = 1;
        if (cfFocus != 3) {
            ConfirmDialogMsg("Do you want to save data?");
        } else {
            SaveData();
        }
    });
    //tblGridtwoData, tblGridoneData
    var DocsArray = [];
    function AddDocstoSave() {
        var G1Count = TableGrid1Data.rows().count();
        var G2Count = TableGridtwoData.rows().count();
        DocsArray = [];
        var strTypeID = "", strDocID = "",strDocPrefix = "", strTran_Date = "", strDocRef = "", strTransName = "", strNetAmt = "", strBalance = "", strID = "", strFAID = "",
            strDocPrefix = "", strDocValue = "", strUDFDocId = "", strCollAmt = 0, strAdjAmtMP = 0,
            strDiscPern = 0, strDiscAmt = 0, strFullAdjYN = 0, strTotAdjAmt = 0, strTotWriteoff = "";
        if (G1Count > 0) {
            $("#tblGridoneData tbody tr").each(function () {
                rowdata = TableGrid1Data.row($(this)).data();
                strID = rowdata[0];
                strDocPrefix = rowdata[1];
                strFAID = rowdata[2];
                strDocValue = rowdata[3];
                strDocID = rowdata[5];
                strTran_Date = rowdata[6];
                strDocRef = rowdata[7];
                strTransName = rowdata[8];
                $(this).find("label").each(function (index) {
                    const fieldName = $(this).attr("name");
                    const fieldID = $(this).attr("id");
                    if (fieldName == "G1NetAmount") {
                        strNetAmt = $(this).attr("lbltag");
                    }
                    if (fieldName == "G1Balance") {
                        strBalance = $(this).attr("lbltag");
                    }
                });
                $(this).find("input").each(function (index) {
                    const fieldName = $(this).attr("name");
                    const fieldID = $(this).attr("id");
                    if (fieldName == "AdjCollAmtHeader") {
                        strCollAmt = parseFloat($(this).attr("txttag"));
                    }
                });
                if (strCollAmt > 0) {
                    var lst = {
                        "TypeID": 1,
                        "DocID": strDocID,
                        "Tran_Date": strTran_Date,
                        "DocRef": strDocRef,
                        "TransName": strTransName,
                        "NetAmt": strNetAmt,
                        "Balance": strBalance,
                        "CollAmt": strCollAmt,
                        "ID": strID,
                        "FAID": strFAID,
                        "DocPrefix": strDocPrefix,
                        "DocValue": strDocValue,
                        "UDFDocId": strUDFDocId,
                        "AdjAmt": 0,
                        "DiscPern": 0,
                        "DiscAmt": 0,
                        "FullAdjYN": 0,
                        "TotalAdjAmt": strCollAmt,
                        "WriteOffAmt": 0
                    };
                    DocsArray.push(lst);
                }
            });
        }
        if (G2Count > 0) {
            $("#tblGridtwoData tbody tr").each(function () {
                rowdata = TableGridtwoData.row($(this)).data();
                strID = rowdata[0];
                strDocPrefix = rowdata[1];
                strFAID = rowdata[2];
                strDocValue = rowdata[3];
                strDocID = rowdata[5];
                strTran_Date = rowdata[6];
                strDocRef = rowdata[7];
                strTransName = rowdata[8];

                $(this).find("label").each(function (index) {
                    const fieldName = $(this).attr("name");
                    const fieldID = $(this).attr("id");
                    if (fieldName == "G2NetAmount") {
                        strNetAmt = $(this).attr("lbltag");
                    }
                    if (fieldName == "G2OS") {
                        strBalance = $(this).attr("lbltag");
                    }
                    if (fieldName == "G2TotalAdjAmount") {
                        strTotAdjAmt = $(this).attr("lbltag");
                    }
                    if (fieldName == "WriteoffAmt") {
                        strTotWriteoff = $(this).attr('lbltag');
                    }
                });
                $(this).find("input").each(function (index) {
                    const fieldName = $(this).attr("name");
                    const fieldID = $(this).attr("id");
                    if (fieldName == "AdjCollAmtFooter") {
                        strCollAmt = parseFloat($(this).attr("txttag"));
                    }
                    if (fieldName == "AdjAmt") {
                        strAdjAmtMP = parseFloat($(this).attr("txttag"));
                    }
                    if (fieldName == "AdjDiscPern") {
                        strDiscPern = parseFloat($(this).attr("txttag"));
                    }
                    if (fieldName == "AdjDiscAmt") {
                        strDiscAmt = parseFloat($(this).attr("txttag"));
                    }
                });
                $(this).find("select").each(function (index) {
                    const fieldName = $(this).attr("name");
                    const fieldID = $(this).attr("id");
                    if (fieldName == "FullyAdj") {
                        strFullAdjYN = $(this).val();
                    }
                });
                if (strCollAmt > 0) {
                    var lst = {
                        "TypeID": 2,
                        "DocID": strDocID,
                        "Tran_Date": strTran_Date,
                        "DocRef": strDocRef,
                        "TransName": strTransName,
                        "NetAmt": strNetAmt,
                        "Balance": strBalance,
                        "CollAmt": strCollAmt,
                        "ID": strID,
                        "FAID": strFAID,
                        "DocPrefix": strDocPrefix,
                        "DocValue": strDocValue,
                        "UDFDocId": strUDFDocId,
                        "AdjAmt": strAdjAmtMP,
                        "DiscPern": strDiscPern,
                        "DiscAmt": strDiscAmt,
                        "FullAdjYN": strFullAdjYN,
                        "TotalAdjAmt": strTotAdjAmt,
                        "WriteOffAmt": strTotWriteoff
                    };
                    DocsArray.push(lst);
                }
            });
        }
    }

    function SaveData() {
        $("#btnSave").prop("disabled", true);
        //alert("Validation success");
        AddDocstoSave();
        var listTrans = {
            "IsDraft": nIsDraft,
            "ID": $("#txtID").val(),
            "DocDate": $("#dtpDate").val(),
            "TransMode": nTransMode,
            "TransID": nDocPrefix,
            "BranchID": $("#cmbBranch").val(),
            "DocID": $("#lblDocID").val(),
            //"DocValue": $("#txtID").val(),
            "CustomerID": $("#txtCustomerID").val(),
            "BeatID": $("#cmbBeat").val(),
            "SalesmanID": $("#cmbSalesman").val(),
            "RefNo": $("#txtRefNo").val(),
            "PaymentModeID": $("#cmbPaymode").val(),
            "CollAmt": document.getElementById("txtAmount").getAttribute("txttag"),//$("#txtFright").val(),
            "AdvanceAmount": parseFloat(document.getElementById("txtRemainingAmount").getAttribute("txttag")),
            "Status": nTransMode == 1 || nTransMode == 3 ? 1 : nTransMode == 2 ? 3 : $("#txtStatus").val(),
            "CurrentStatus": $("#txtStatus").val(),
            "UDFId": 0,
            "UserID": UID,
            "Remarks": $("#txtRemarks").val(),
            "Narration": $("#txtNarration").val(),
            "VisaPern": document.getElementById("txtVisaPern").getAttribute("txttag"),
            "VisaAmt": document.getElementById("txtVisaAmt").getAttribute("txttag"),
            "NEFTNo": $("#txtNEFT").val(),
            "BankAccID": $("#cmbFromAccount").val(),
            "BankAccNo": $("#cmbFromAccount").val() > 0 ? $("#cmbFromAccount option:selected").text() : "",
            "ChequeID": $("#cmbChequeNo ").val(),
            "ChequeNo": $("#cmbChequeNo ").val() > 0 ? $("#cmbChequeNo option:selected").text() : "",
            "ChequeDate": $("#dtpChequeDate").val(),
            "IFSC": $("#txtIFSC").val(),
            "BankID": $("cmbBankName").val(),
            "BankName": $("#cmbBankName ").val() > 0 ? $("#cmbBankName option:selected").text() : "",
            "Branch": $("#txtBranchName").val(),
            "lstCollPayDtl": DocsArray
        }
        $.ajax({
            url: Aurl + "collectionpayment/save",
            type: 'POST',
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify(listTrans),
            cache: false,
            processData: false,
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                $("#btnSave").prop("disabled", false);
                $.each(data, function (i, items) {
                    if (items.MsgID == 0) {
                        //alert(items.Message);
                        showSuccessSnackbar(items.Message);
                        modalPayment.style.display = "none";
                        //ClearForm();
                        if (nTransMode != 4) {
                            if (allowprint == 1) {
                                PrintDocument(items.ID, PrintTransID, PrintConfigID);
                            } else if (allowprint == 3 || allowprint == 4) {
                                PrintConfirmDialogMsg(items.ID, PrintTransID, PrintConfigID, "Do you want to print ?");
                            }
                            if (SendAutoMail == 1) {
                                EmailDocument(items.ID, PrintTransID, PrintConfigID);
                            }
                        }
                        ClearForm();
                    }
                    else {
                        //$("#dvErrorName").html(items.Message);
                        //alert(items.Message);
                        showErrorSnackbar(items.Message);
                    }
                });
            }
            , error: function (data) {
                $("#btnSave").prop("disabled", false);
                if (data.status == "401") {
                    var msg = data.responseJSON.Message;
                    ////showErrorSnackbar(msg + " Logout and Login again.");
                }
            }
        });
    }

    var AllowAdvance = false;
    function AdvanceConfirmDialogMsg(message) {
        AllowAdvance = false;
        $(".ui-dialog-titlebar-close").hide();
        $('<div></div>').appendTo('body')
            .html('<div><h6>' + message + '</h6></div>')
            .dialog({
                modal: true,
                closeOnEscape: true,
                title: 'Confirm Popup',
                zIndex: 100,
                autoOpen: true,
                width: '300px',
                resizable: true,
                close: false,
                open: function () {
                    $(this).closest(".ui-dialog")
                        .find(".ui-dialog-titlebar-close")
                        .removeClass("ui-dialog-titlebar-close")
                        .html("x");
                },
                buttons: [
                    {
                        text: "Yes",
                        class: "btn btn-success clsclrYes",
                        click: function () {
                            $(this).dialog("close");
                            AllowAdvance = true;
                        },
                    },
                    {
                        text: "No",
                        class: "btn btn-danger clsclrNo",
                        click: function () {
                            $(this).dialog("close");
                            AllowAdvance = false;
                        }
                    }
                ],
            });
        if (cfFocus == 1) {
            $(".clsclrYes").focus();
        }
        else {
            $(".clsclrNo").focus();
        }
        return AllowAdvance;
    };

    //$('input, select ,button, textarea').on('keydown', function (e) {
    //    if (e.key === "Enter") {
    //        if (e.target.localName != "button") {
    //            e.preventDefault(); // Prevent default behavior
    //            var nextinp = $('input,select,button, textarea').eq($('input,select,button, textarea').index(this) + 1);
    //            if (nextinp.length) {
    //                if (nextinp[0].disabled) {
    //                    nextinp = $('input,select,button, textarea').eq($('input,select,button, textarea').index(this) + 2);
    //                }
    //                nextinp.focus();
    //                nextinp.select();
    //            }
    //        }
    //    }
    //    if (e.shiftKey && e.which == 13) {
    //        e.preventDefault();
    //        var $canfocus = $(':focusable');
    //        var index = $canfocus.index(this) - 1;
    //        if (index >= $canfocus.length) index = 0;
    //        $canfocus.eq(index).focus();
    //    }
    //});
    if ($("#txtID").val() > 0 && $("#txtTransType").val() == 2) {
        nTransMode = 5;
        var ID = $("#txtID").val();
        GetDocViewData(3, ID);
        $(".FormclrField,.FormclrcmbField").prop("disabled", true);
        $("#btnSave,#btnClear,#btnDraft").prop("disabled", true);
        $("#dvMain").show();
        $("#dvDocuments").hide();
        $("#btnEmail,#btnWhatsapp").show();
        $("#MainHeading").text("View " + $("#txtFormName").val());
    }
</script>