@model ShineWeb.Models.SingleMasterModel
@{
    ViewBag.Title = "Product Analytics Report";

}
<link href="~/Content/bootstrap.min.css" rel="stylesheet" />
<link href="~/Content/navbar.css" rel="stylesheet" />
<link href="~/Content/buttonTop.css" rel="stylesheet" />
@*<link href="~/Content/jquery-ui.css" rel="stylesheet" />*@
<link href="~/Content/dataTables.dataTables.2.2.2.css" rel="stylesheet" />

<script src="~/Scripts/bootstrap.min.js"></script>
<script src="~/Scripts/jquery-1.10.2.min.js"></script>
<script src="~/Scripts/jquery-3.7.1.js"></script>
<script src="~/Scripts/jquery-ui.js"></script>
<script src="~/Scripts/datatable.js"></script>
<script src="~/Scripts/dataTables.2.2.2.js"></script>
<script src="~/Scripts/js/refreshtoken.js"></script>

@*<link href="https://cdn.syncfusion.com/ej2/27.1.48/ej2-base/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/27.1.48/ej2-grids/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/27.1.48/ej2-buttons/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/27.1.48/ej2-popups/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/27.1.48/ej2-richtexteditor/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/27.1.48/ej2-navigations/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/27.1.48/ej2-dropdowns/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/27.1.48/ej2-lists/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/27.1.48/ej2-inputs/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/27.1.48/ej2-calendars/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/27.1.48/ej2-notifications/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/27.1.48/ej2-splitbuttons/styles/bootstrap5.css" rel="stylesheet">

    <script src="https://cdn.syncfusion.com/ej2/27.1.48/dist/ej2.min.js" type="text/javascript"></script>
    <script src="https://cdn.syncfusion.com/ej2/syncfusion-helper.js" type="text/javascript"></script>*@
<link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-base/styles/bootstrap5.css" rel="stylesheet">
<link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-grids/styles/bootstrap5.css" rel="stylesheet">
<link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-buttons/styles/bootstrap5.css" rel="stylesheet">
<link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-popups/styles/bootstrap5.css" rel="stylesheet">
<link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-richtexteditor/styles/bootstrap5.css" rel="stylesheet">
<link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-navigations/styles/bootstrap5.css" rel="stylesheet">
<link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-dropdowns/styles/bootstrap5.css" rel="stylesheet">
<link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-lists/styles/bootstrap5.css" rel="stylesheet">
<link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-inputs/styles/bootstrap5.css" rel="stylesheet">
<link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-calendars/styles/bootstrap5.css" rel="stylesheet">
<link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-notifications/styles/bootstrap5.css" rel="stylesheet">
<link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-splitbuttons/styles/bootstrap5.css" rel="stylesheet">
<script src="https://cdn.syncfusion.com/ej2/31.2.2/dist/ej2.min.js" type="text/javascript"></script>
<script src="https://cdn.syncfusion.com/ej2/syncfusion-helper.js" type="text/javascript"></script>
<style>
    td {
        font-size: 12px;
    }


    input[type=number] {
        text-align: right;
    }

        input[type=number]::placeholder {
            text-align: left;
        }
    /* Chrome, Safari, Edge, Opera */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* Firefox */
    input[type=number] {
        -moz-appearance: textfield;
    }
    /* The Modal (background) */
    .modalReportColumnSettings {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 10; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }

    /* Modal Content/Box */
    @@media only screen and (min-width: 600px) {
        .modalReportColumnSettings-content {
            background-color: #ffffff;
            margin: 3% auto; /* 15% from the top and centered */
            padding: 10px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            height: 80%;
            top: 5%;
            overflow: auto;
        }
    }

    @@media only screen and (max-width: 600px) {
        .modalReportColumnSettings-content {
            background-color: #ffffff;
            margin: 10% auto; /* 15% from the top and centered */
            padding: 25px;
            border: 1px solid #888;
            width: 95%; /* Could be more or less, depending on screen size */
            height: 90%;
            top: 20%;
            overflow: auto;
        }
    }

    .modal-dialog {
        width: 80%
    }
    /* The Close Button */
    .closemodalReportColumnSettings {
        color: #aaa;
        float: right;
        font-size: 10px;
        font-weight: bold;
    }

        .closemodalReportColumnSettings:hover,
        .closemodalReportColumnSettings:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

    .form-label {
        position: relative;
        display: block;
        clear: both;
        max-width: 500px;
        margin: 0 auto;
    }

    .labelup {
        -webkit-transform: translateY(50%);
        -moz-transform: translateY(-50%);
        -ms-transform: translateY(-50%);
        -o-transform: translateY(-50%);
        transform: translateY(50%);
        -webkit-transition: all 0.2s ease-in-out;
        -moz-transition: all 0.2s ease-in-out;
        transition: all 0.2s ease-in-out;
        position: absolute;
        top: -40%;
        left: 1em;
        background: #fffefe;
        color: #2b2828;
        font-size: 0.90em;
        cursor: text;
        pointer-events: none;
        font-family: sans-serif;
    }

    tr {
        cursor: pointer
    }
</style>
<style>
    .star-rating {
        direction: rtl;
        display: inline-flex;
        font-size: 3rem;
    }

        .star-rating input {
            display: none;
        }

        .star-rating label {
            color: #ccc;
            cursor: pointer;
            padding: 0 5px;
        }

        .star-rating input:checked ~ label {
            color: gold;
        }
</style>
<style>
    * {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
    }

    .container {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }

    .left-section {
        flex: 1;
        min-width: 200px;
    }

    .right-section {
        flex: 2;
        min-width: 300px;
        display: flex;
        flex-direction: column;
        gap: 0px;
    }

    .party-box {
        background-color: #e6f1fb;
        padding: 2px;
        min-height: 550px;
        border: 1px solid #ccc;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    }

    .party-info-box {
        background-color: #fffde8;
        padding: 10px;
        min-height: 100px;
        border: 1px solid #ccc;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    }

    .documents-box {
        background-color: #ffffff;
        padding: 2px;
        min-height: 400px;
        border: 1px solid #ccc;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    }

    @@media (max-width: 768px) {
        .container {
            flex-direction: column;
        }

        .left-section,
        .right-section {
            flex: 1 0 100%;
        }
    }

    @@media (min-width: 1200px) {
        .container {
            max-width: 100% !important;
            gap: 1px !important;
        }
    }

    .main {
        padding-left: 0px !important;
        padding-top: 40px !important;
        padding-bottom: 30px !important;
        width: 100% !important;
        margin-left: 0px !important;
    }
</style>
<style>
    .star-rating {
        direction: rtl;
        display: inline-flex;
        font-size: 3rem;
    }

        .star-rating input {
            display: none;
        }

        .star-rating label {
            color: #ccc;
            cursor: pointer;
            padding: 0 5px;
        }

        .star-rating input:checked ~ label {
            color: gold;
        }
</style>
<body>

    <div class="toastBox"></div>
    <div class="container">
        <div class="left-section">
            <div class="party-box">
                <strong></strong>
                <div id="Grid"></div>
            </div>

        </div>
        <div class="right-section">
            <div class="party-info-box">
                <table width="100%" border="0" cellspacing="0" cellpadding="5">
                    <tr>
                        <td colspan="2" width="100%">
                            <h5><span class="glyphicon glyphicon-info-sign" title="Party Info" id="ProductInfo"></span> &ensp; <label id="lblProductName"></label></h5>
                        </td>
                        <td rowspan="2" width="30%" align="left">
                            <table>
                                <tr>
                                    <td align="right">
                                        <label style="opacity:0.6;">&ensp;Free Stock Qty :</label>
                                    </td>
                                    <td>
                                        &ensp;<label id="lblFreeStockQty" style="font-size:medium">0.00</label>
                                    </td>
                                </tr>
                                <tr>
                                    <td align="right">
                                        <label style="opacity:0.6;">&ensp;Dmg Stock Qty :</label>
                                    </td>
                                    <td>
                                        &ensp;<label id="lblDmgStockQty" style="font-size:medium">0.00</label>
                                    </td>
                                </tr>
                                <tr>
                                    <td align="right"><label style="opacity:0.6;">&ensp;Dmg Stock Value :</label></td>
                                    <td>&ensp;<label id="lblDmgStockValue" style="font-size:medium">0.00</label></td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td align="left" width="35%">
                            <table>
                                <tr>
                                    <td align="right">
                                        <label style="opacity:0.6;">&ensp;Purchase Price(Excl) :</label>
                                    </td>
                                    <td>
                                        <input hidden id="txtInvID" />
                                        &ensp; <label id="lblPurchasePrice" style="font-size:medium">0.00</label>
                                    </td>
                                </tr>
                                <tr>
                                    <td align="right"><label style="opacity:0.6;">&ensp;Sales Price(Excl):</label></td>
                                    <td>&ensp; <label id="lblSalesPrice" style="font-size: medium">0.00</label></td>
                                </tr>
                            </table>
                        </td>
                        <td align="left" width="35%">
                            <table>
                                <tr>
                                    <td align="right">
                                        <label style="opacity:0.6;">&ensp;Stock Qty :</label>
                                    </td>
                                    <td>
                                        &ensp;<label id="lblStockQty" style="font-size:medium">0.00</label>
                                    </td>
                                </tr>
                                <tr>
                                    <td align="right"><label style="opacity:0.6;">&ensp;Stock Value :</label></td>
                                    <td>&ensp;<label id="lblStockValue" style="font-size:medium">0.00</label></td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>

                @*<table width="100%">
                        <tr>
                            <td colspan="2" width="100%">
                                <h5><span class="glyphicon glyphicon-info-sign" title="Party Info" id="ProductInfo"></span> &ensp; <label id="lblProductName"></label></h5>
                            </td>
                        </tr>
                        <tr>
                            <td align="left" width="50%">
                                <label style="opacity:0.6;">&ensp;Purchase Price(Excl) :</label>&ensp;<label id="lblPurchasePrice" style="font-size:medium">0.00</label><br />
                                <label style="opacity:0.6;">&ensp;Sales Price(Excl):</label>&ensp;<label id="lblSalesPrice" style="font-size: medium">0.00</label>
                            </td>
                            <td align="right" width="50%">
                                <label style="opacity:0.6;">&ensp;Stock Qty :</label>&ensp;<label id="lblStockQty" style="font-size:medium">0.00</label><br />
                                <label style="opacity:0.6;">&ensp;Stock Value :</label>&ensp;<label id="lblStockValue" style="font-size:medium">0.00</label>
                            </td>
                        </tr>
                    </table>*@

            </div>
            <div class="documents-box">
                <strong></strong>
                <div id="DocumentGrid"></div>
            </div>
        </div>
    </div>
    <div class="modalReportColumnSettings" id="mymodalReportColumnSettings">
        <div class="modal-dialog" style="width:auto;">
            <div class="modalReportColumnSettings-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <button type="button" class="closemodalReportColumnSettings">&times;</button>
                    <h5 class="modal-title" style="color:black" id="lblReportPopupheading"><b>Product Analtical Report</b></h5>
                </div>
                <div class="modal-body">
                    <div id="dvAssign" style="width:100%;padding-bottom:7px">
                        <table class="table table-bordered row-border order-column" id="tblReportSettings" style="width:100%">
                            <thead>
                                <tr>
                                    <th style="width:0%">ReportID</th>
                                    <th style="width:0%">TableID</th>
                                    <th style="width:0%">ColumnID</th>
                                    <th style="width:25%">Column Name</th>
                                    <th style="width:30%">Display Column Name</th>
                                    <th style="width:9%">Width</th>
                                    <th style="width:12%">Alignment</th>
                                    <th style="width:12%">Visible</th>
                                    <th style="width:12%">Display Index</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
                <!-- Modal footer -->
                <div class="modal-footer" style="background-color:skyblue">
                    <div style="padding-top:0px" align="right">
                        @*<button tabindex="4" type="button" class="btn btn-danger" id="btnPinfoClear"><span class="glyphicon glyphicon-refresh"> Clear</span></button>*@
                        <button type="button" class="btn btn-success" id="btnSubmitmodalReportColumnSettings"><span class="glyphicon glyphicon-floppy-disk"> Accept</span></button>
                        <button type="button" class="btn btn-warning" id="btnClosemodalReportColumnSettings"><span class="glyphicon glyphicon-remove"> Close</span></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript">
    var DecVal = '@Session["DecimalValues"]';
    var Aurl = '@Session["APIurl"]';
    var companyName = '@Session["companyname"]';
    var SelectTableID = 1;
    var tblReportSettings = $('#tblReportSettings').DataTable({
        "bFilter": false,
        "bSearchable": false,
        "bInfo": false,
        "bPaginate": false,
        "ordering": false,
        scrollY: "250px",
        "columnDefs": [{ "targets": [0, 1, 2], "visible": false, searchable: false }],
    });
    var modalReportColumnsetting = document.getElementById("mymodalReportColumnSettings");
    var spanRepCSClode = document.getElementsByClassName("closemodalReportColumnSettings")[0];
    spanRepCSClode.onclick = function () {
        modalReportColumnsetting.style.display = "none";
    }
    $('#btnClosemodalReportColumnSettings').click(function (e) {
        modalReportColumnsetting.style.display = "none";
    });
    //$("#btnTable1Settings").click(function () {
    //    modalReportColumnsetting.style.display = "block";
    //    ColumnSettings(1, 1001, 1);
    //});
    var grid;
    var Documetsgrid;
    var columnsettings = [], documentcolumnsettings = [];
    ColumnDetails(2, 1002, 1);
    ColumnDetails(2, 1002, 2);
    function ColumnDetails(nMode, nReportID, nTableID) {
        $.ajax({
            url: Aurl + "reportcolumnsettings/getRepColumnSettings",
            type: 'get',
            contentType: 'json',
            data: { Mode: nMode, ReportID: nReportID, TableID: nTableID },
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                var jsData = eval(data);
                if (nTableID == 1) {
                    columnsettings = jsData;
                } else if (nTableID == 2) {
                    documentcolumnsettings = jsData;
                }
            }
        });
    }
    function ColumnSettings(nMode, nReportID, nTableID) {
        $.ajax({
            url: Aurl + "reportcolumnsettings/getRepColumnSettings",
            type: 'get',
            contentType: 'json',
            data: { Mode: nMode, ReportID: nReportID, TableID: nTableID },
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                var jsData = eval(data);
                $('#tblReportSettings').DataTable({
                    scrollY: "450px",
                    scrollX: true,
                    scrollCollapse: true,
                    paging: false,
                    destroy: true,
                    data: jsData,
                    fixedColumns: false,
                    searching: false,
                    ordering: false,
                    sorting: false,
                    columns: [
                        //ReportID	TableID	ColumnID	ColumnName	DisplayColumnName	Width	Visible	Alignment	DisplayIndex	IsHiddenColumn
                        { "data": "ReportID", "autoWidth": true, "visible": false, className: "dt-body-left" },//0
                        { "data": "TableID", "autoWidth": true, "visible": false, className: "dt-body-left" },//1
                        { "data": "ColumnID", "autoWidth": true, "visible": false, className: "dt-body-left" },//2
                        { "data": "ColumnName", "autoWidth": true, className: "dt-body-left" },//3
                        {
                            className: "dt-body-left",
                            "mRender": function (data, type, value, meta) {
                                var rowIndex = meta.row;
                                return '<input type="text" value="' + value.DisplayColumnName + '" name ="DisplayColumnName" class="form-control" id="txtDisplayColumnName' + rowIndex + '"/>';
                            }
                        },
                        {
                            className: "dt-body-left",
                            "mRender": function (data, type, value, meta) {
                                var rowIndex = meta.row;
                                return '<input type="number" value="' + value.Width + '" name ="Width" class="form-control" id="txtWidth' + rowIndex + '" min="1" oninput="javascript: if (this.value < this.min) { this.value = 0 }"/>';
                            }
                        },
                        {
                            className: "dt-body-left",
                            "mRender": function (data, type, value, meta) {
                                var rowIndex = meta.row;
                                var isLeftSelect = value.Alignment == '1' ? 'selected' : '';
                                var isRightSelect = value.Alignment == '2' ? 'selected' : '';
                                var isCenterSelect = value.Alignment == '3' ? 'selected' : '';
                                var field = "<select name='Alignment' class='form-control' id='cmbAlignment" + rowIndex + "'><option value= '1'" + isLeftSelect + ">Left</option><option value= '3'" + isCenterSelect + ">Center</option><option value= '2'" + isRightSelect + ">Right</option></select>";
                                return field;
                            }
                        },
                        {
                            className: "dt-body-left",
                            "mRender": function (data, type, value, meta) {
                                var rowIndex = meta.row;
                                var isFalseSelect = value.Visible == '0' ? 'selected' : '';
                                var isTrueSelect = value.Visible == '1' ? 'selected' : '';
                                var field = "<select name='Visible' class='form-control' id='cmbVisible" + rowIndex + "'><option value= '0' " + isFalseSelect + ">False</option><option value= '1'" + isTrueSelect + ">True</option></select>";
                                return field;
                            }
                        },
                        {
                            className: "dt-body-left",
                            "mRender": function (data, type, value, meta) {
                                var rowIndex = meta.row;
                                return '<input type="number" value="' + value.DisplayIndex + '" name ="DisplayIndex" class="form-control" id="txtDisplayIndex' + rowIndex + '" min="0" oninput="javascript: if (this.value < this.min) { this.value = 0 }"/>';
                            }
                        },
                    ],
                });
                tblReportSettings = $('#tblReportSettings').DataTable();
            }
        });
    }
    var ColumnSettingData = [];
    $("#btnSubmitmodalReportColumnSettings").click(function () {
        ColumnSettingData = [];
        $("#tblReportSettings tbody tr").each(function () {
            var allValues = {};
            rowdata = tblReportSettings.row($(this)).data();

            var aDisplayName = "", aWidth = "", aDisplayIndex = "", aAlign = "", aVisible = "";
            $(this).find("input").each(function (index) {
                const fieldName = $(this).attr("name");
                const fieldID = $(this).attr("id");
                if (fieldName == "DisplayColumnName") {
                    aDisplayName = $(this).val();
                }
                if (fieldName == "Width") {
                    aWidth = $(this).val();
                }
                if (fieldName == "DisplayIndex") {
                    aDisplayIndex = $(this).val();
                }
            });
            $(this).find("select").each(function (index) {
                const fieldName = $(this).attr("name");
                const fieldID = $(this).attr("id");
                if (fieldName == "Alignment") {
                    aAlign = $(this).val();
                }
                if (fieldName == "Visible") {
                    aVisible = $(this).val();
                }
            });
            var coldata = {
                "ReportID": rowdata.ReportID,
                "TableID": rowdata.TableID,
                "ColumnID": rowdata.ColumnID,
                "ColumnName": rowdata.ColumnName,
                "DisplayColumnName": aDisplayName,
                "Width": aWidth,
                "Visible": aVisible,
                "Alignment": aAlign,
                "DisplayIndex": aDisplayIndex,
            };
            ColumnSettingData.push(coldata);
        });
        $.ajax({
            url: Aurl + "reportcolumnsettings/SaveRepColumnSettings",
            type: 'POST',
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify(ColumnSettingData),
            cache: false,
            processData: false,
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                $.each(data, function (i, items) {
                    if (items.MsgID == 0) {
                        showSuccessSnackbar(items.Message);
                        //ClearForm();
                        modalReportColumnsetting.style.display = "none";
                        ColumnDetails(2, 1002, SelectTableID);
                        setTimeout(() => {
                            if (SelectTableID == 1) {
                                grid.columns = columnsettings; // your original column settings array
                                grid.refreshColumns();
                            } else {
                                Documetsgrid.columns = documentcolumnsettings; // your original column settings array
                                Documetsgrid.refreshColumns();
                            }
                        }, 500);
                    }
                    else {
                        showErrorSnackbar(items.Message);
                        //alert(items.Message);
                    }
                });
            },
            error: function (data) {
                if (data.status == "401") {
                    var msg = data.responseJSON.Message;
                    ////showErrorSnackbar(msg + " Logout and Login again.");
                }
            }
        });
        //console.log("Column Setting Data ", ColumnSettingData);
    });
    function ClearForm()
    {
        $("#lblLastTransDate").text("--");
        $("#lblRatingName,#lblAccValue").text("");
        $("#lblYearlySales,#lblMonthlySales,#lblYearlyReturn,#lblMonthlyReturn").text("0.00");
        $("input[name=rating]").prop("checked", false);
    }
    $("#ProductInfo").click(function () {
        if (ProductInfo.length > 0) {
            var Partydata = `
            <table id="partyDetailsVertical" border="1" cellspacing="0" cellpadding="8" style="width:100%; border-collapse: collapse;">
    <tbody>
        <tr>
            <th style="text-align:left;background-color:#eeeeee;">Code</th>
            <td>`+ ProductInfo[0].Code+`</td>
        </tr>
        <tr>
            <th style="text-align:left;background-color:#eeeeee;">Name</th>
            <td>`+ ProductInfo[0].Name +`</td>
        </tr>
        <tr>
    <th style="text-align:left;background-color:#eeeeee;">HSN</th>
    <td>`+ ProductInfo[0].HSNCode +`</td>
</tr>
        <tr>
            <th style="text-align:left;background-color:#eeeeee;">Manufacturer</th>
            <td>`+ ProductInfo[0].Manuf +`</td>
        </tr>
        <tr>
            <th style="text-align:left;background-color:#eeeeee;">Brand</th>
            <td>`+ ProductInfo[0].Brand +`</td>
        </tr>
        <tr>
            <th style="text-align:left;background-color:#eeeeee;">Category</th>
            <td>`+ ProductInfo[0].Category +`</td>
        </tr>
        <tr>
            <th style="text-align:left;background-color:#eeeeee;">Tax</th>
            <td>`+ ProductInfo[0].TaxName +`</td>
        </tr>
        <tr>
    <th style="text-align:left;background-color:#eeeeee;">ECP</th>
    <td>`+ ProductInfo[0].ECP +`</td>
</tr>
                <tr>
            <th style="text-align:left;background-color:#eeeeee;">MRP</th>
            <td>`+ ProductInfo[0].MRP + `</td>
        </tr>
        <tr>
    <th style="text-align:left;background-color:#eeeeee;">SPL Price</th>
    <td>`+ ProductInfo[0].SPLPrice +`</td>
</tr>
    </tbody>
</table>`
            InfoDialogMsg(Partydata, 'Product Info');
        } else {
            showErrorSnackbar("Select Product");
        }
    });
    $("#ProductInfo").hide();
    GetProduct();
    function GetProduct() {
        $.ajax({
            url: Aurl + "productanalticalreport/getproduct",
            type: 'get',
            contentType: 'json',
            data: {  },
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                bindDataTable(eval(data))
            }
        });
    }
    var ProductInfo = [];
    function GetProductDocuments(nProdID) {
        $("#lblStockValue,#lblPurchasePrice,#lblSalesPrice,#lblStockQty,#lblDmgStockQty,#lblDmgStockValue,#lblFreeStockQty").text("");
        $.ajax({
            url: Aurl + "productanalticalreport/getdocuments",
            type: 'get',
            contentType: 'json',
            data: { ProductID: nProdID },
            xhrFields: {
                withCredentials: true
            },
            async: false,
            success: function (data) {
                if (data)//.length > 0
                {
                    var PartyDocuments = eval(data.Documents);
                    ProductInfo = eval(data.ProductInfo);
                    $("#lblStockQty").text(ProductInfo[0].ActualQty);
                    $("#lblPurchasePrice").text(ProductInfo[0].PurchasePrice);
                    $("#lblSalesPrice").text(ProductInfo[0].SalesPrice);
                    $("#lblStockValue").text(ProductInfo[0].ActualValue);
                    $("#lblDmgStockQty").text(ProductInfo[0].ActualDmgQty);
                    $("#lblDmgStockValue").text(ProductInfo[0].ActualDmgValue);
                    $("#lblFreeStockQty").text(ProductInfo[0].ActualFreeQty);

                    bindDocumentDataTable(PartyDocuments)
                } else {
                    showErrorSnackbar("No records found");
                }
            }
        });
    }
    var DocGridSearchValue = "";
    ej.grids.Grid.Inject(ej.grids.Page, ej.grids.ExcelExport, ej.grids.Toolbar, ej.grids.Aggregate, ej.grids.Group, ej.grids.Sort, ej.grids.Filter, ej.grids.ColumnMenu, ej.grids.ColumnChooser);
    function bindDataTable(data) {
        if (data.length === 0) {
            return; // No data to display
        }
        //ej.grids.Grid.Inject(ej.grids.Page, ej.grids.ExcelExport, ej.grids.Toolbar, ej.grids.Aggregate, ej.grids.Group, ej.grids.Sort, ej.grids.Filter, ej.grids.ColumnMenu, ej.grids.ColumnChooser);

        //var columnsettings1 = [
        //    { field: 'ID', visible: false, showInColumnChooser: false },
        //    { field: 'Code', headerText: 'Code', width: "30", textAlign: 'left', visible: false },
        //    { field: 'Name', headerText: 'Name', width: "50", textAlign: 'left', format: 'text' },
        //    {
        //        field: 'ActualQty', headerText: 'AQty', width: "30", textAlign: 'Right',
        //    }];
       
        grid = new ej.grids.Grid({
            dataSource: data,
            allowPaging: false,
            //pageSettings: { pageSize: 25 },
            allowSorting: true,
            allowFiltering: true,
            allowResizing: true,
            filterSettings: { type: 'Excel' },
            toolbar: ["ExcelExport", 'Search', {tooltipText: 'Customize Columns', id: 'customizeBtn', prefixIcon: 'e-icons e-settings' }],
            allowExcelExport: true,
            height: 500,
            enableColumnVirtualization: true,
            allowReordering: true,
            showColumnChooser: true, // ✅ Must be true
            showColumnMenu: true,
            rowSelected: onRowSelected,
            columns: columnsettings,
            toolbarClick: function (args) {
                if (args.item.id === 'customizeBtn') {
                    SelectTableID = 1;
                    modalReportColumnsetting.style.display = "block";
                    ColumnSettings(1, 1002, SelectTableID);
                }
                if (args.item.id === 'Grid_excelexport') {
                    var fname = "Product Analtical Report";
                    //var companyName = $("#txtCompanyName").val() || "GKBS";
                    var cdt = new Date();
                    cdt = cdt.getFullYear().toString() +
                        (cdt.getMonth() + 1).toString().padStart(2, '0') +
                        cdt.getDate().toString().padStart(2, '0') +
                        cdt.getHours().toString().padStart(2, '0') +
                        cdt.getMinutes().toString().padStart(2, '0') +
                        cdt.getSeconds().toString().padStart(2, '0') +
                        cdt.getMilliseconds().toString();

                    // 🧮 Detect and total numeric columns
                    var searchbarvalue = $("#Grid_searchbar").val();
                    var gridData;
                    if (searchbarvalue == "") {
                        gridData = grid.dataSource;
                    } else {
                        gridData = grid.getFilteredRecords();
                    }
                    const columns = Object.keys(gridData[0] || {});

                    const footerRow = { cells: [] };
                    const footerCellStyle = {
                        bold: true,
                        backColor: "#FFFF99", // light yellow
                        hAlign: "Right"
                    };
                    //footerRow.cells.push({
                    //    value: "Total",
                    //    style: footerCellStyle,
                    //    hAlign: "Left"
                    //});
                    Excelfilter = [];
                    var Col2Data = "", Col2Data = "";
                    columns.forEach(col => {
                        const isNumeric = gridData.every(row => !isNaN(parseFloat(row[col])) && isFinite(row[col]));
                        if (isNumeric) {
                            const total = gridData.reduce((sum, row) => sum + (parseFloat(row[col]) || 0), 0);
                            footerRow.cells.push({
                                value: total.toFixed(2),
                                style: footerCellStyle
                            });
                        } else {
                            footerRow.cells.push({
                                value: "",
                                style: footerCellStyle
                            });
                        }
                    });

                    // 🧾 Header Rows: Company, Report Name, Params
                    const paramRows = [
                        {
                            cells: [
                                { value: "Company Name", style: { bold: true, fontSize: 14, backColor: "#ADD8E6" } },
                                { value: companyName, style: { bold: true, backColor: "#ADD8E6" } }
                            ]
                        },
                        {
                            cells: [
                                { value: "Report Name", style: { bold: true, fontSize: 12, backColor: "#ADD8E6" } },
                                { value: fname, style: { bold: true, backColor: "#ADD8E6" } }
                            ]
                        }
                    ];

                    // 🖼 Optional logo
                    var logoBase6413 = $("#txtcomplogo").val();
                    //alert(logoBase64)
                    const exportProperties = {
                        fileName: fname + "_" + cdt + ".xlsx",
                        enableFilter: true,
                        header: {
                            headerRows: 3,
                            rows: [
                                {

                                    cells: [{
                                        //image: {
                                        //    base64: logoBase6413,
                                        //    height: 50,
                                        //    width: 100
                                        //},
                                        colSpan: 1,
                                    }]
                                },
                                ...paramRows
                            ]
                        },
                        //footer: {
                        //    footerRows: 1,
                        //    rows: [footerRow]
                        //},
                        columns: grid.columns.map(col => {
                            return {
                                ...col,
                                width: undefined // let Excel auto fit
                            };
                        })
                    };
                    grid.excelExport(exportProperties);
                }
            },
            resizeStop: function (args) {
                const field = args.column.field;
                const fieldIndex = args.column.index;
                const newWidth = args.column.width;
                //showErrorSnackbar("Column resized: " + field + " → New width: " + newWidth);
                // You can store or use the new width as needed
            },
            columnVisibilityChanged: function (args) {
                console.log("Column visibility changed:");
                console.log("Field:", args.column.field);
                console.log("Now Visible:", args.visible);
            },
        });

        grid.appendTo('#Grid');

        function onRowSelected(args) {
            var rowData = args.data;
            //showErrorSnackbar("Doc ID " + rowData["Doc ID"])//.
            //console.log("Selected Row Data:", rowData);
            $("#DocumentGrid").html("");
            $("#ProductInfo").show();
            if (Documetsgrid) {
                DocGridSearchValue = Documetsgrid.searchSettings.key || '';
                //showInfoSnackbar("lastSearchText : " + lastSearchText);
            }
            GetProductDocuments(rowData["ID"]);
            $("#lblProductName").text(rowData["Name"]);
        }
    }
    var DocGridSearchValue = '';
    var isRebinding = false;
    function bindDocumentDataTable(data) {
        if (data.length === 0) {
            return; // No data to display
        }

        //var columnsettings = [
        //    { field: 'TransID', visible: false, showInColumnChooser: false },
        //    { field: 'Transaction', headerText: 'Transaction', width: "40", textAlign: 'left'},
        //    { field: 'Doc ID', headerText: 'Doc ID', width: "30", textAlign: 'left' },
        //    { field: 'Doc Date', headerText: 'Doc Date', width: "30", textAlign: 'left' },
        //    { field: 'Party', headerText: 'Party Name', width: "60", textAlign: 'left' },
        //    { field: 'Qty', headerText: 'Qty', width: "30", textAlign: 'Right' },
        //    { field: 'Value', headerText: 'Value', width: "30", textAlign: 'Right' }]
        isRebinding = true;
        Documetsgrid = new ej.grids.Grid({
            dataSource: data,
            allowPaging: false,
            //pageSettings: { pageSize: 25 },
            allowSorting: true,
            allowFiltering: true,
            allowResizing: true,
            filterSettings: { type: 'Excel' },
            toolbar: ["ExcelExport", 'Search', { text: 'Settings', tooltipText: 'Customize Columns', id: 'customizeBtn', prefixIcon: 'e-icons e-settings' }],// "Print",
            allowExcelExport: true,
            height: 350,
            enableColumnVirtualization: true,
            allowReordering: true,
            showColumnChooser: true, // ✅ Must be true
            showColumnMenu: true,
            //rowSelected: onRowSelected,
            columns: documentcolumnsettings,
            toolbarClick: function (args) {
                if (args.item.id === 'customizeBtn') {
                    SelectTableID = 2;
                    modalReportColumnsetting.style.display = "block";
                    ColumnSettings(1, 1002, SelectTableID);
                }
                if (args.item.id === 'DocumentGrid_excelexport') {
                    var fname = "Product Analtical Report";
                    //var companyName = $("#txtCompanyName").val() || "GKBS";
                    var cdt = new Date();
                    cdt = cdt.getFullYear().toString() +
                        (cdt.getMonth() + 1).toString().padStart(2, '0') +
                        cdt.getDate().toString().padStart(2, '0') +
                        cdt.getHours().toString().padStart(2, '0') +
                        cdt.getMinutes().toString().padStart(2, '0') +
                        cdt.getSeconds().toString().padStart(2, '0') +
                        cdt.getMilliseconds().toString();

                    // 🧮 Detect and total numeric columns
                    var searchbarvalue = $("#DocumentGrid_searchbar").val();
                    var gridData;
                    if (searchbarvalue == "") {
                        gridData = Documetsgrid.dataSource;
                    } else {
                        gridData = Documetsgrid.getFilteredRecords();
                    }
                    const columns = Object.keys(gridData[0] || {});

                    const footerRow = { cells: [] };
                    const footerCellStyle = {
                        bold: true,
                        backColor: "#FFFF99", // light yellow
                        hAlign: "Right"
                    };
                    //footerRow.cells.push({
                    //    value: "Total",
                    //    style: footerCellStyle,
                    //    hAlign: "Left"
                    //});
                    Excelfilter = [];
                    var Col2Data = "", Col2Data = "";

                    columns.forEach(col => {
                        const isNumeric = gridData.every(row => !isNaN(parseFloat(row[col])) && isFinite(row[col]));
                        if (isNumeric) {
                            const total = gridData.reduce((sum, row) => sum + (parseFloat(row[col]) || 0), 0);
                            footerRow.cells.push({
                                value: total.toFixed(2),
                                style: footerCellStyle
                            });
                        } else {
                            footerRow.cells.push({
                                value: "",
                                style: footerCellStyle
                            });
                        }
                    });

                    // 🧾 Header Rows: Company, Report Name, Params
                    const paramRows = [
                        {
                            cells: [
                                { value: "Company Name", style: { bold: true, fontSize: 14, backColor: "#ADD8E6" } },
                                { value: companyName, style: { bold: true, backColor: "#ADD8E6" } }
                            ]
                        },
                        {
                            cells: [
                                { value: "Report Name", style: { bold: true, fontSize: 12, backColor: "#ADD8E6" } },
                                { value: fname, style: { bold: true, backColor: "#ADD8E6" } }
                            ]
                        }
                    ];

                    // 🖼 Optional logo
                    var logoBase6413 = $("#txtcomplogo").val();
                    //alert(logoBase64)
                    const exportProperties = {
                        fileName: fname + "_" + cdt + ".xlsx",
                        enableFilter: true,
                        header: {
                            headerRows: 3,
                            rows: [
                                {

                                    cells: [{
                                        //image: {
                                        //    base64: logoBase6413,
                                        //    height: 50,
                                        //    width: 100
                                        //},
                                        colSpan: 2,
                                    }]
                                },
                                ...paramRows
                            ]
                        },
                        //footer: {
                        //    footerRows: 1,
                        //    rows: [footerRow]
                        //},
                        columns: Documetsgrid.columns.map(col => {
                            return {
                                ...col,
                                width: undefined // let Excel auto fit
                            };
                        })
                    };
                    Documetsgrid.excelExport(exportProperties);
                }
            },
            resizeStop: function (args) {
                const field = args.column.field;
                const fieldIndex = args.column.index;
                const newWidth = args.column.width;
                //showErrorSnackbar("Column resized: " + field + " → New width: " + newWidth);
                // You can store or use the new width as needed
            },
            columnVisibilityChanged: function (args) {
                console.log("Column visibility changed:");
                console.log("Field:", args.column.field);
                console.log("Now Visible:", args.visible);
            },
            /* 🔥 CAPTURE SEARCH VALUE HERE */
            actionBegin: function (args) {
                if (args.requestType === 'searching' && !isRebinding) {
                    DocGridSearchValue = args.searchString || '';
                }
            },

            /* 🔥 REAPPLY SEARCH ONLY AFTER REBIND */
            dataBound: function () {
                if (isRebinding && DocGridSearchValue) {
                    Documetsgrid.search(DocGridSearchValue);
                    isRebinding = false;
                }
            }
        });

        Documetsgrid.appendTo('#DocumentGrid');

        function onRowSelected(args) {
            var rowData = args.data;
            //showErrorSnackbar("Doc ID " + rowData["Doc ID"])//.
            console.log("Selected Row Data:", rowData);
        }
    }
    var ProductInfo = [];
    if ($("#txtID").val() > 0 && $("#txtTransType").val() > 0) {
        var TypeID = $("#txtTransType").val();
        var PartyID = $("#txtID").val();
        $("#rdoCustomer").prop("checked", TypeID == 1);
        $("#rdoVendor").prop("checked", TypeID == 2);
        $("#tdPartycell,#txtSearch").prop("disabled", true);
        GetData(PartyID);
    }
    function animateCounterNumber(id, start, end, duration) {
        if (end != "" && end != null) {
            const obj = document.getElementById(id);
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));

            const timer = setInterval(() => {
                current += increment;
                obj.textContent = current;
                if (current === end) {
                    clearInterval(timer);
                }
            }, stepTime);
        }
    }
</script>
