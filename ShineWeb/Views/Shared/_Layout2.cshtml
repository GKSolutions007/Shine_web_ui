<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title> @ViewBag.Title</title>
    <link rel="SHORTCUT ICON" href="~/images/G_large_Transparent.png" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,100,300,500" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" rel="stylesheet">
    <link href="~/Content/bootstrap.min.css" rel="stylesheet" />
    <link href="~/Content/font-awesome.min.css" rel="stylesheet" />
    <link href="~/Content/Snackbar.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="~/Content/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="~/Scripts/Validation.js"></script>

    <link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-base/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-grids/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-buttons/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-popups/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-richtexteditor/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-navigations/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-dropdowns/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-lists/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-inputs/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-calendars/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-notifications/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/31.2.2/ej2-splitbuttons/styles/bootstrap5.css" rel="stylesheet">
    <script src="https://cdn.syncfusion.com/ej2/31.2.2/dist/ej2.min.js" type="text/javascript"></script>
    <script src="https://cdn.syncfusion.com/ej2/syncfusion-helper.js" type="text/javascript"></script>
    @*<link href="~/Content/Site.css" rel="stylesheet" />
        <link href="~/Content/navbar.css" rel="stylesheet" />*@
    <style>
        #tblMasterData_wrapper .dt-scroll-body {
            min-height: 200px !important;
            /*            max-height: 450px;*/
            overflow-y: auto;
        }

        table.dataTable tfoot th, table.dataTable tfoot td {
            text-align: right !important;
        }

        table.dataTable thead th, table.dataTable thead td {
            text-align: left !important;
        }

        .albgclr {
            background-color: #f3f2f2 !important;
            color: black;
            border-radius: 4px;
            font-weight: bold;
        }

        .loader,
        .loader:after {
            border-radius: 50%;
            width: 10em;
            height: 10em;
        }

        .loader {
            margin: 60px auto;
            font-size: 10px;
            position: center;
            text-indent: -9999em;
            border-top: 1.1em solid rgba(255, 255, 255, 0.2);
            border-right: 1.1em solid rgba(255, 255, 255, 0.2);
            border-bottom: 1.1em solid rgba(255, 255, 255, 0.2);
            border-left: 1.1em solid #ffffff;
            -webkit-transform: translateZ(0);
            -ms-transform: translateZ(0);
            transform: translateZ(0);
            -webkit-animation: load8 1.1s infinite linear;
            animation: load8 2.1s infinite linear;
        }

        @@-webkit-keyframes load8 {
            0% {
                -webkit-transform: rotate(0deg);
                transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }

        @@keyframes load8 {
            0% {
                -webkit-transform: rotate(0deg);
                transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }

        #loadingDiv {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 150%;
            opacity: 90%;
            background-color: #C7E1BA;
        }

        .LoaderMsg {
            font-size: 20px;
            text-align: center;
        }

        .dropdown-menu li {
            position: relative;
            color: white;
            padding-bottom: 5px;
        }

        .dropdown-menu .dropdown-submenu {
            display: none;
            position: absolute;
            left: 100%;
            top: -10px;
            width: 200px;
            padding-top: 10px;
            padding-bottom: 5px;
            color: darkblue;
        }

        .dropdown-menu .dropdown-submenu-left {
            right: 100%;
            left: auto;
        }

        .dropdown-menu > li:hover > .dropdown-submenu {
            display: block;
            background-color: white;
            border-radius: 5px;
        }
        /* Fixed sidenav, full height */
        .sidenav {
            height: 100%;
            width: 15%;
            position: fixed;
            z-index: 1;
            top: 0;
            left: 0;
            background-color: black;
            overflow-x: hidden;
            padding-top: 50px;
            color: white;
            z-index: 1000; /* make this high */
        }

            /* Style the sidenav links and the dropdown button */
            .sidenav li, .dropdown-btn {
                padding: 1px 1px 6px 16px;
                text-decoration: none;
                font-size: 14px;
                color: white;
                display: block;
                border: none;
                background: none;
                width: 100%;
                text-align: left;
                cursor: pointer;
                outline: none;
                font-weight: bold;
                font-family: 'Times New Roman';
                z-index: 9999;
            }

                /* On mouse-over */
                .sidenav a:hover, .dropdown-btn:hover {
                    color: #f1f1f1;
                }

        /* Main content */
        /*.main {
            top: 0px;
            margin-left: 15%;*/ /* Same as the width of the sidenav */
        /*padding: 0px 1px;
        }*/
        .main {
            padding-left: 10px !important;
            padding-top: 40px !important;
            padding-bottom: 30px !important;
            width: 100% !important;
            /*            margin-left: 10px !important;*/
            z-index: 9999 !important;
        }
        /* Add an active class to the active dropdown button */
        .active {
            /*background-color: brown;*/
            color: white;
        }

        /* Dropdown container (hidden by default). Optional: add a lighter background color and some left padding to change the design of the dropdown content */
        .dropdown-container {
            display: none;
            background-color: #262626;
            padding-left: 5px;
            color: white;
        }

        /* Optional: Style the caret down icon */
        .mendwn {
            float: right;
            padding-right: 8px;
            position: fixed;
        }

        /* Some media queries for responsiveness */
        @@media screen and (max-height: 450px) {
            .sidenav {
                padding-top: 10px;
            }

                .sidenav li {
                    font-size: 12px;
                }
        }

        linkforecolor {
            color: white;
        }

        .dvsearchmnu:hover {
            background-color: antiquewhite
        }

        .list-container {
            margin-top: 10px;
            overflow: auto;
        }

        .list-item {
            padding: 8px;
            border: 1px solid #ddd;
            margin: 5px 0;
            cursor: pointer;
        }

        .highlight1 {
            background-color: yellow;
        }

        .selected {
            background-color: lightblue;
        }

        .modalQuickSearch {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 10; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        /* Modal Content/Box */
        @@media only screen and (min-width: 600px) {
            .modalQuickSearch-content {
                background-color: #ffffff;
                margin: 3% auto; /* 15% from the top and centered */
                padding: 1px;
                border: 1px solid #888;
                width: 70%; /* Could be more or less, depending on screen size */
                height: auto;
                min-height: 200px;
                max-height: 500px;
                top: 1%;
                overflow: auto;
            }
        }

        @@media only screen and (max-width: 600px) {
            .modalQuickSearch-content {
                background-color: #ffffff;
                margin: 10% auto; /* 15% from the top and centered */
                padding: 25px;
                border: 1px solid #888;
                width: 95%; /* Could be more or less, depending on screen size */
                height: 80%;
                top: 20%;
                overflow: auto;
            }
        }
        /* The Close Button */
        .closemodalQuickSearch {
            color: #aaa;
            float: right;
            font-size: 10px;
            font-weight: bold;
        }

            .closemodalQuickSearch:hover,
            .closemodalQuickSearch:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            }

        .modalPrintAppPassword {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 10000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        /* Modal Content/Box */
        @@media only screen and (min-width: 600px) {
            .modalPrintAppPassword-content {
                background-color: #ffffff;
                margin: 3% auto; /* 15% from the top and centered */
                padding: 5px;
                border: 1px solid #888;
                width: 30%; /* Could be more or less, depending on screen size */
                height: auto;
                top: 1%;
                overflow: auto;
            }
        }

        @@media only screen and (max-width: 600px) {
            .modalPrintAppPassword-content {
                background-color: #ffffff;
                margin: 10% auto; /* 15% from the top and centered */
                padding: 5px;
                border: 1px solid #888;
                width: 95%; /* Could be more or less, depending on screen size */
                height: 80%;
                top: 20%;
                overflow: auto;
            }
        }
        /* The Close Button */
        .closemodalmodalPrintAppPassword {
            color: #aaa;
            float: right;
            font-size: 10px;
            font-weight: bold;
        }

            .closemodalmodalPrintAppPassword:hover,
            .closemodalmodalPrintAppPassword:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            }

        /* The Modal (background) */
        .modalBatchiframe {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 10000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        /* Modal Content/Box */
        @@media only screen and (min-width: 600px) {
            .modalBatchiframe-content {
                background-color: #ffffff;
                margin: 3% auto; /* 15% from the top and centered */
                padding: 10px;
                border: 1px solid #888;
                width: 85%; /* Could be more or less, depending on screen size */
                height: 70%;
                top: 5%;
                overflow: auto;
            }
        }

        @@media only screen and (max-width: 600px) {
            .modalBatchiframe-content {
                background-color: #ffffff;
                margin: 10% auto; /* 15% from the top and centered */
                padding: 25px;
                border: 1px solid #888;
                width: 95%; /* Could be more or less, depending on screen size */
                height: 80%;
                top: 20%;
                overflow: auto;
            }
        }
        /* The Close Button */
        .closefgiframe {
            color: #aaa;
            float: right;
            font-size: 10px;
            font-weight: bold;
        }

            .closefgiframe:hover,
            .closefgiframe:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            }

        .each {
            border-bottom: 1px solid #555 !important;
            padding: 3px 0 !important;
        }

        .acItem .name {
            font-size: 11px !important;
            font-family: Arial, Helvetica, sans-serif !important;
            color: var(--acitemname, black);
        }

        .acItem .desc {
            font-size: 11px !important;
            font-family: Arial, Helvetica, sans-serif !important;
            font-weight: bold !important;
            color: var(--acitemdesc, black);
        }

        .ui-autocomplete {
            max-height: 245px !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
        }

        .ui-menu-item-wrapper.ui-state-active {
            /*background-color: red;*/
            background-color: var(--dynamic-bg, orangered);
            font-size: 12px !important;
            color: black !important;
            border-radius: 4px !important;
            font-weight: bold !important;
            /*#f3f2f2*/
        }

        .modalInvoiceCollection {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 10000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        /* Modal Content/Box */
        @@media only screen and (min-width: 600px) {
            .modalInvoiceCollection-content {
                background-color: #ffffff;
                margin: 3% auto; /* 15% from the top and centered */
                padding: 5px;
                border: 1px solid #888;
                width: 60%; /* Could be more or less, depending on screen size */
                height: auto;
                top: 1%;
                overflow: auto;
            }
        }

        @@media only screen and (max-width: 600px) {
            .modalInvoiceCollection-content {
                background-color: #ffffff;
                margin: 10% auto; /* 15% from the top and centered */
                padding: 5px;
                border: 1px solid #888;
                width: 95%; /* Could be more or less, depending on screen size */
                height: 80%;
                top: 20%;
                overflow: auto;
            }
        }
        /* The Close Button */
        .closeInvoiceCollectionModal {
            color: #aaa;
            float: right;
            font-size: 10px;
            font-weight: bold;
        }

            .closeInvoiceCollectionModal:hover,
            .closeInvoiceCollectionModal:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            }
    </style>
    <style>
        .modaliframePreview {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 10;
            top: 0%;
            right: 0;
            bottom: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
        }

        /* Modal Content/Box */
        @@media only screen and (min-width: 600px) {
            .modaliframePreview-content {
                background-color: #ffffff;
                margin: auto; /* 15% from the top and centered */
                padding: 1px;
                border: 1px solid #888;
                width: 70%; /* Could be more or less, depending on screen size */
                height: 100%;
                bottom: 0;
                right: 0;
                overflow: auto;
            }
        }

        @@media only screen and (max-width: 600px) {
            .modaliframePreview-content {
                background-color: #ffffff;
                margin: 10% auto; /* 15% from the top and centered */
                padding: 25px;
                border: 1px solid #888;
                width: 95%; /* Could be more or less, depending on screen size */
                height: 80%;
                top: 20%;
                overflow: auto;
            }
        }
        /* The Close Button */
        .closefgmodaliframePreview {
            color: #aaa;
            float: right;
            font-size: 10px;
            font-weight: bold;
        }

            .closefgmodaliframePreview:hover,
            .closefgmodaliframePreview:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            }

        iframe#iframepreview {
            width: 100%;
            height: 450px;
            border: none;
            background: white;
            display: block;
        }
    </style>
    <style>
        .dropdown-container ul {
            list-style: gujarati; /* remove default bullets */
            margin: 0;
            padding: 0 0 0 20px; /* left padding for line space */
            position: relative;
        }

            .dropdown-container ul::before {
                content: "";
                position: absolute;
                top: 0;
                bottom: 0;
                left: 10px; /* line position */
                width: 2px;
                background: #ccc; /* line color */
            }

            .dropdown-container ul li:hover {
                background: skyblue; /* line color */
                color: brown;
            }

            .dropdown-container ul li {
                position: relative;
                padding: 3px 0 0px 15px; /* spacing for text */
            }

                .dropdown-container ul li::before {
                    content: "";
                    position: absolute;
                    top: 15px; /* aligns with text */
                    left: -10px; /* same as ul::before left */
                    width: 18px;
                    height: 2px;
                    background: #ccc; /* horizontal connector */
                }

                .dropdown-container ul li:last-child::after {
                    content: "";
                    position: absolute;
                    left: -10px;
                    bottom: 0;
                    width: 2px;
                    height: calc(100% - 20px);
                    background: white; /* hides extra vertical line after last item */
                }

        .modalDocFilter {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 10; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        /* Modal Content/Box */
        @@media only screen and (min-width: 600px) {
            .modalDocFilter-content {
                background-color: #ffffff;
                margin: 3% auto; /* 15% from the top and centered */
                padding: 1px;
                border: 1px solid #888;
                width: 70%; /* Could be more or less, depending on screen size */
                height: auto;
                min-height: 200px;
                max-height: 500px;
                top: 1%;
                overflow: auto;
            }
        }

        @@media only screen and (max-width: 600px) {
            .modalDocFilter-content {
                background-color: #ffffff;
                margin: 10% auto; /* 15% from the top and centered */
                padding: 25px;
                border: 1px solid #888;
                width: 95%; /* Could be more or less, depending on screen size */
                height: 80%;
                top: 20%;
                overflow: auto;
            }
        }
        /* The Close Button */
        .closemodalDocFilter {
            color: #aaa;
            float: right;
            font-size: 10px;
            font-weight: bold;
        }

            .closemodalDocFilter:hover,
            .closemodalDocFilter:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            }

        @@media screen and (min-width: 768px) {
            .modalDocFilter
            .modal-dialog {
                right: auto;
                left: 1% !important;
                width: 100%;
                padding-top: 30px;
                padding-bottom: 30px;
                margin: 2px auto;
            }
        }

        .row {
            margin-right: 0px !important;
        }
    </style>
    <style>
        /* Floating popup */
        .action-popup {
            position: absolute;
            display: none;
            background: white;
            border: 1px solid #ccc;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            z-index: 99999;
            min-width: 120px;
            border-radius: 8px;
            padding: 0;
            opacity: 0;
            transform: scale(0.85);
            transition: 0.15s ease-out;
        }

            /* Slide + Zoom animation class */
            .action-popup.show {
                opacity: 1;
                transform: scale(1) translateY(0px);
            }

        /* Header (draggable area) */
        .popup-header {
            background: #007bff;
            padding: 8px 12px;
            color: white;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            display: none;
        }

        .close-popup {
            cursor: pointer;
            font-size: 18px;
        }

        /* Menu items */
        .action-popup ul {
            list-style: none;
            margin: 0;
            padding: 5px 0;
        }

        .action-popup li a {
            display: block;
            padding: 5px 12px;
            cursor: pointer;
            text-decoration: none;
            color: black;
            transition: background 0.2s;
        }

            .action-popup li a:hover {
                background: #f2f2f2;
            }

        .action-btn {
            border: 5px !important;
        }
    </style>
</head>
<body>
    <div class="modaliframePreview" id="myiframePreview">
        <div class="modal-dialog" style="width:100%;">
            <div class="modaliframePreview-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <button type="button" class="closefgmodaliframePreview">&times;</button>
                    <table>
                        <tr>
                            <td style="padding-right:30px;">
                                <h5 class="modal-title" style="color:black" id="lblPopupheading"><b>Preview</b></h5>
                            </td>
                            <td>
                                <button type="button" class="btn clrforpdf" id="btniframePDF"><span class="glyphicon glyphicon-envelope"> PDF</span></button>
                                <button type="button" class="btn clrforpreview" id="btniframePrint"><span class="glyphicon glyphicon-print"> Print</span></button>
                                <button type="button" class="btn btn-warning" id="btnclosefgmodaliframePreview"><span class="glyphicon glyphicon-remove"> Close</span></button>
                            </td>
                        </tr>
                    </table>
                </div>
                <!-- Modal body -->
                <div class="modal-body">

                    <iframe id="iframepreview" src=""
                            style="width:100%;height:450px;background-color: white"></iframe>
                </div>
            </div>
        </div>
    </div>
    <script>
        var modaliframePreview = document.getElementById("myiframePreview");
        var spanmodaliframePreview = document.getElementsByClassName("closefgmodaliframePreview")[0];
        spanmodaliframePreview.onclick = function () {
            modaliframePreview.style.display = "none";
        }
        $('#btnclosefgmodaliframePreview').click(function (e) {
            modaliframePreview.style.display = "none";
        });
    </script>
    <input type="hidden" id="hdnConfirmFocus" value="@Session["ConfirmFocus"]" />
    <input type="hidden" id="hdnClearConfirmFocus" value="@Session["ClearConfirmFocus"]" />
    <input type="hidden" id="hdnCloseConfirmFocus" value="@Session["CloseConfirmpopup"]" />
    <input type="hidden" id="hdnApiurl" value="@Session["APIurl"]" />

    @{

        string LayoutName = Convert.ToString(Session["NavBarVisible"]);
        string User = Convert.ToString(Session["LoginUser"]);
        string UIDs = Convert.ToString(Session["LoginUserID"]);
        System.Data.DataTable dtParent = (System.Data.DataTable)Session["dtParent"];
        System.Data.DataTable dtPermission = (System.Data.DataTable)Session["dtPermission"];
        System.Data.DataTable dtCompany = (System.Data.DataTable)Session["dtCompany"];
        string CompCode = dtCompany.Rows[0][1].ToString();
        string CompName = dtCompany.Rows[0][2].ToString();
        string apiurl = Convert.ToString(Session["APIurl"]) + "backupfile";
        if (LayoutName == "LogOn")
        {
            <header id="LoginPage" class="navbar navbar-bright navbar-fixed-top" role="banner">
                <div class="container">
                    <div class="navbar-header">
                        <a href="~/LogOn/Index" class="navbar-brand">Login Page</a>
                    </div>
                </div>
            </header>
        }
        else if (LayoutName == "UserPermission")
        {

            <div class="sidenav">

                <img src="~/Images/search-icon.png" id="icQS" onclick="focussearch();" data-toggle="modal" data-target="#myModal" style="padding-left:10px;width:35px;height:25px;position:fixed;right:0;top:0;z-index:10" title="Quick Search" />
                <div style="top: 0; position: fixed; width: 100%;height:45px;" class="dvmainmenuheader">
                    <!--<a href="~/Home" id="acompname" style="color:lightgreen;font-size:large"><img src="~/Images/G_large_Transparent.png" style="width:45px;height:35px" />-->@*<b> Shine Web</b>*@<!--</a>-->
                    <table class="table">
                        <tr>
                            <td style="width:2%" id="tdSideMenuIcon">
                                <div id="sidedivcollapsed" style="color: black;font-size:20px">
                                    <i title="Collapse Menus" class="fa fa-arrow-alt-circle-left"></i>
                                </div>
                                <div id="sidedivexpand" style="color: black;font-size: 20px">
                                    <i title="Expand Menus" class="fa fa-arrow-alt-circle-right"></i>
                                </div>
                            </td>
                            <td style="width:25%">
                                <a href="~/Home" id="acompname" style="color:lightgreen;font-size:large"><img src="~/Images/G_large_Transparent.png" style="width:45px;height:35px" />@*<b> Shine Web</b>*@</a>
                                <label style="color:brown;font-size:16px;font-weight:800">@CompName</label>
                            </td>

                            <td>
                                <marquee style="color:red;font-size:12px;">@User</marquee>
                            </td>
                        </tr>
                    </table>

                </div>
                <div class="sideallmenus">
                    @for (int iRow = 0; iRow < dtParent.Rows.Count; iRow++)
                    {
                        int nParentID = Convert.ToInt32(dtParent.Rows[iRow]["MenuId"]);
                        int nTreeID = Convert.ToInt32(dtParent.Rows[iRow]["MenuTree"]);
                        string IsMenus = Convert.ToString(dtParent.Rows[iRow]["IsMenu"]);
                        string strManuName = Convert.ToString(dtParent.Rows[iRow]["MenuName"]);
                        string MainMenuEnc = Convert.ToString(dtParent.Rows[iRow]["EncMenuName"]);
                        string ZeEnc = "jJOtHsRVwYECOhoiBc69dA==";
                        System.Data.DataRow[] dr = dtPermission.Select("MenuParentId=" + nParentID.ToString());
                        //System.Data.DataRow[] dr = dtPermission.Select("MenuTree=" + nParentID.ToString());
                        if (dr.Count() > 0 && strManuName != "Web")
                        {

                            if (strManuName == "Reports")
                            {
                                @Html.ActionLink("Reports", "index", "Reports", new { name = MainMenuEnc, strFormID = ZeEnc }, new { @class = "dropdown-btn linkforecolor", @style = "font-weight:bold;color:white;padding-left:15px;padding-bottom:50px", @title = User, @target = "_black" })
                                continue;
                            }
                            else
                            {
                                if (IsMenus == "1")
                                {
                                    <button class="dropdown-btn" style="font-size:16px;">@strManuName<i class="glyphicon glyphicon-chevron-down mendwn"></i></button>
                                }
                            }
                            @*<button class="dropdown-btn" style="font-size:16px;">@strManuName<i class="glyphicon glyphicon-chevron-down mendwn"></i></button>*@
                            <div class="dropdown-container">
                                <ul class="linkforecolor">
                                    @{
                                        for (int j = 0; j < dr.Length; j++)
                                        {
                                            int nChildParentID = Convert.ToInt32(dr[j]["MenuId"].ToString());
                                            string displayName = dr[j]["MenuName"].ToString();
                                            string controllerName = dr[j]["LocationName"].ToString();
                                            IsMenus = dr[j]["IsMenu"].ToString();
                                            string FID = dr[j]["FormID"].ToString();
                                            string EncDispName = dr[j]["EncMenuName"].ToString();
                                            string EncFID = dr[j]["EncFormID"].ToString();
                                            string EncTypeID = "jJOtHsRVwYECOhoiBc69dA==";
                                            string EncTranID = "jJOtHsRVwYECOhoiBc69dA==";
                                            if (displayName == "Product")
                                            {

                                            }
                                            if (IsMenus == "1" && strManuName != "Reports")
                                            {
                                                <li>@Html.ActionLink(displayName, "Index", controllerName, new { name = EncDispName, strFormID = EncFID, TypeID = EncTypeID, TranID = EncTranID }, new { @style = "font-weight:bold;", @class = "linkforecolor" })</li>
                                            }
                                            if (strManuName == "Tools" && (j + 1) == dr.Length)
                                            {
                                                <li>
                                                    <a href="javascript:void(0)" id="hrefbakup" class="linkforecolor">Backup</a>
                                                </li>
                                            }
                                        }
                                        if (strManuName.ToUpper() == "TOOLS" && (UIDs.ToString() == "1"))
                                        {
                                            <li>@Html.ActionLink("Device Approval", "Index", "SystemApproval", null, new { @class = "dropdown", @style = "font-weight:bold;" })</li>
                                        }
                                    }
                                </ul>
                            </div>
                        }
                    }
                    @*<div style="padding-left:15px">
                            @Html.ActionLink("LogOut - " + User, "LogOff", "Login", null, new { @class = "dropdown linkforecolor", @style = "font-weight:bold", @title = User, @id = "algot" })

                        </div>*@
                    <div class="dvmainmenuheader" id="sidenavfooter" style="bottom: 0; position: fixed; width: 15%;padding:15px;font-size:16px; ">
                        @*@Html.ActionLink("Customize Print", "Index", "CustomizePrinting", null, new { @class = "dropdown linkforecolor", @style = "font-weight:bold" })*@
                        @Html.ActionLink("LogOut - " + User, "LogOff", "Login", null, new { @class = "dropdown linkforecolor", @style = "font-weight:bold", @title = User, @id = "algot" })
                    </div>
                </div>
            </div>

        }
    }

    <link href="~/Content/SlidePopup.css" rel="stylesheet" />
    <div class="container">
        <!-- The Modal -->
        <div class="modalQuickSearch" id="myModal">
            <div class="modal-dialog">
                <div class="modalQuickSearch-content">

                    <!-- Modal Header -->
                    <div class="modal-header" style="background-color:lightgoldenrodyellow">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Quick Search</h4>
                    </div>

                    <!-- Modal body -->
                    <div class="modal-body">
                        <!-- onkeyup="filterFunction()"-->
                        <input type="text" placeholder="Search.." id="myInput" class="form-control" autocomplete="off">
                        <div class="list-container" id="listContainer" style="padding-top:3px;">

                            @{
                                if (Session["dtPermission"] != null)
                                {
                                    System.Data.DataRow[] drrr = dtPermission.Select("MenuChildLevel = 2", "MenuName");
                                    if (drrr.Count() > 0)
                                    {
                                        for (int i = 0; i < drrr.Length; i++)
                                        {
                                            string EncName = Url.Encode(drrr[i]["EncMenuName"].ToString());//Url.Encode(ShineWeb.BuisnessLayer.clsEncryptDecrypt.Encrypt(drrr[i]["MenuName"].ToString()));
                                            string EncFID = Url.Encode(drrr[i]["EncFormID"].ToString());//Url.Encode(ShineWeb.BuisnessLayer.clsEncryptDecrypt.Encrypt(drrr[i]["FormID"].ToString()));
                                            string EncTypeID = Url.Encode("jJOtHsRVwYECOhoiBc69dA==");//Url.Encode(ShineWeb.BuisnessLayer.clsEncryptDecrypt.Encrypt("0"));
                                            string EncTranID = Url.Encode("jJOtHsRVwYECOhoiBc69dA==");//Url.Encode(ShineWeb.BuisnessLayer.clsEncryptDecrypt.Encrypt("0"));
                                            if (drrr[i]["IsMenu"].ToString() == "1")
                                            {
                                                string reflink = drrr[i]["LocationName"].ToString() + "?name=" + EncName + "&strFormID=" + EncFID + "&TypeID=" + EncTypeID + "&TranID=" + EncTranID;

                                                <div class="list-item">
                                                    <a href="@reflink" target="_blank"> @drrr[i]["MenuName"].ToString() </a>
                                                </div>

                                            }
                                        }
                                    }
                                }
                            }

                        </div>
                        @*</div>*@
                    </div>

                    <!-- Modal footer -->
                    <div class="modal-footer" style="background-color:skyblue">
                        <button type="button" class="btn btn-danger" data-dismiss="modal" id="btnCloseQS">Close</button>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <div class="modalPrintAppPassword" id="myPrintAppPasswordModal">
        <div class="modal-dialog" style="width:auto;">
            <div class="modalPrintAppPassword-content">
                <!-- Modal Header -->
                <div class="modal-header" style="background-color:lightgoldenrodyellow">
                    <button type="button" class="closeprintapppwd" hidden>&times;</button>
                    <h4 class="modal-title">Print Confirmation</h4>
                </div>

                <!-- Modal body -->
                <div class="modal-body">
                    <input id="txtCommonPrintPrevieworPDF" hidden class="clrComPrintData" />
                    <input id="txtCommonPrintTransID" hidden class="clrComPrintData" /><input id="txtCommonPrintTranTypeID" hidden class="clrComPrintData" />
                    <input id="txtCommonPrintConfigID" hidden class="clrComPrintData" />
                    <input type="password" required placeholder="Enter Password" id="txtPrintAppPassword" class="form-control" autocomplete="off">
                </div>
                <!-- Modal footer -->
                <div class="modal-footer" style="background-color:skyblue">
                    <button type="button" class="btn btn-success" data-dismiss="modal" id="btnSubmitprintAppPwd">Submit</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal" id="btncloseprintapppwd">Close</button>
                </div>

            </div>
        </div>
    </div>
    <div class="modalInvoiceCollection" id="myInvoiceCollectionModal">
        <div class="modal-dialog" style="width:auto;">
            <div class="modalInvoiceCollection-content">
                <!-- Modal Header -->
                <div class="modal-header" style="background-color:lightgoldenrodyellow">
                    <button type="button" class="closeInvoiceCollectionModal">&times;</button>
                    <h4 class="modal-title">Invoice Collection</h4>
                </div>

                <!-- Modal body -->
                <div class="modal-body">

                    <table class="table table-bordered row-border order-column" id="tblInvoiceCollectionData" style="width:100%">
                        <thead>
                            <tr>
                                <th style="text-align:center;font-size: 12px;width:2%;" class="trclrforcolheader">#</th>
                                <th style="text-align:center;font-size: 12px;width:10%;" class="trclrforcolheader">Doc ID</th>
                                <th style="text-align:center;font-size: 12px;width:10%;" class="trclrforcolheader">Doc Date</th>
                                <th style="text-align:center;font-size: 12px;width:15%;" class="trclrforcolheader">Amount</th>
                                <th style="text-align:center;font-size: 12px;width:10%;" class="trclrforcolheader">Ageing</th>
                                <th style="text-align:center;font-size: 12px;width:10%;" class="trclrforcolheader">Payment Mode</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3" style="text-align:left !important">
                                    <label>Assigned Invoice : </label><label id="lblInvCollAssignInvoice">0</label>
                                </th>
                                <th>
                                    <label id="lblInvCollAssignInvoiceTotal">0</label>
                                </th>
                                <th colspan="2">
                                    <label>OS : </label><label id="lblInvCollAssignInvoiceOS">0</label>
                                </th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <!-- Modal footer -->
                <div class="modal-footer" style="background-color:skyblue">
                    <button type="button" class="btn btn-danger" data-dismiss="modal" id="btncloseInvoiceCollectionModal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modalBatchiframe" id="myModalfgiframe">
        <div class="modal-dialog" style="width:auto;">
            <div class="modalBatchiframe-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <button type="button" class="closefgiframe">&times;</button>
                    <h5 class="modal-title" style="color:white" id="lbliframeheading"><b></b></h5>
                    @*<hr />*@
                </div>
                <!-- Modal body -->
                <div class="modal-body">
                    <iframe src="" id="ifrSMG" style="width:100%;height:450px;"></iframe>
                </div>
            </div>
        </div>
    </div>

    <div class="modalDocFilter" id="myDocFilterModal">
        <div class="modal-dialog" style="width:auto;">
            <div class="modalDocFilter-content">
                <!-- Modal Header -->
                <div class="modal-header" style="background-color:lightgoldenrodyellow;padding:3px">
                    <button type="button" class="closemodalDocFilter">&times;</button>
                    <h4 class="modal-title">Document Filter</h4>
                </div>

                <!-- Modal body -->
                <div class="modal-body">
                    <input hidden id="txtcommonfilterapplyfieldid" />
                    <input hidden id="txtcommonfilterapplytransid" />
                    <table width="100%">
                        <tr class="bgclrfortr">
                            <td style="border:none;" hidden>
                                <div>
                                    <span class="form-label">
                                        <input type="text" class="form-control" id="txtCommonDocFilterPartyName" placeholder="Party Name">
                                        <label class="labelup">Party Name</label>
                                    </span>
                                    <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrCommonDocFilterPartyName" class="clrdivs"></div>
                                </div>
                            </td>
                            <td style="border:none;">
                                <div>
                                    <span class="form-label">
                                        <input type="text" class="form-control" id="txtCommonDocFilterRange" placeholder="Range">
                                        <label class="labelup">Range</label>
                                    </span>
                                    <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrCommonDocFilterRange" class="clrdivs"></div>
                                </div>
                            </td>
                            <td>
                                <span class="form-label">
                                    <input class="form-control FormfilterclrField" type="date" id="dtpCommonDocFilterFrom" placeholder="" oninput="javascript: if (this.value > this.max) { this.value = this.max; }">
                                    <label class="labelup"> From</label>
                                </span>
                                <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrCommonDocFilterFrom" class="clrdivs"></div>
                            </td>

                            <td>
                                <span class="form-label">
                                    <input class="form-control FormfilterclrField" type="date" id="dtpCommonDocFilterTo" placeholder="" oninput="javascript: if (this.value > this.max) { this.value = this.max; }">
                                    <label class="labelup"> To</label>
                                </span>
                                <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrCommonDocFilterFTo" class="clrdivs"></div>
                            </td>
                            <td>
                                <span class="form-label">
                                    <select class="form-control" id="dtpCommonDocFilterType">
                                        <option value="1">All</option>
                                        <option value="2">E-Invoice Only</option>
                                        <option value="3">Non E-Invoice Only</option>
                                    </select>
                                    <label class="labelup"> Filter Type</label>
                                </span>
                                <div style="color: red; padding-top: 5px; padding-left: 5px;" id="divErrCommonDocFilterType" class="clrdivs"></div>
                            </td>
                            <td style="padding-left:10px;">
                                <button id="btnCommonDocumentFilter" class="btn btn-primary"><span class="glyphicon glyphicon-filter" style="color: white"></span>&#x2009;Filter</button>
                            </td>
                        </tr>

                    </table>
                    <div style="height:320px">
                        <div id="DocumetFiltersGrid"></div>
                    </div>
                </div>
                <!-- Modal footer -->
                <div class="modal-footer" style="background-color: skyblue; padding: 3px">
                    <button type="button" class="btn btn-success" data-dismiss="modal" id="btnAcceptDocFilterModal">Accept</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal" id="btncloseDocFilterModal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        var ItemsperPage = parseInt('@Session["ItemsperPage"]', 10) || 10;
        var RetainDate = parseInt('@Session["RetainDate"]');

    </script>

    <div style="padding-left: 15px; padding-top: 40px;padding-bottom: 30px;width:100%" class="main">
        <div id="actionPopup" class="action-popup">
            <div class="popup-header">
                <span>Actions</span>
                <span class="close-popup">×</span>
            </div>
            <ul></ul>
        </div>
        @RenderBody()
    </div>
    <script src="~/Scripts/bootstrap.min.js"></script>
    @* @Scripts.Render("~/bundles/jquery")
        @Scripts.Render("~/bundles/bootstrap")*@
</body>
</html>
@*<script src="~/Scripts/jquery-3.7.1.min.js"></script>*@
<script type="text/javascript">
    let userRole = {
        canEdit: $("#txtModifyID").val() == 1,
        canVariant: $("#txtVariantID").val() == 1,
        canCancel: $("#txtCancelID").val() == 1,
        canPrint: $("#txtViewID").val() == 1,
        canPreview: $("#txtViewID").val() == 1,
        canPDF: $("#txtViewID").val() == 1
    };
    // Centralized helper to build a safe absolute PDF URL
    function buildPdfUrl(baseUrl, pathOrFile) {
        try {
            let base = (baseUrl || '').toString().trim();
            let segment = (pathOrFile || '').toString().trim();

            // Prefer API base if provided via Session["APIurl"], else fallback to current origin
            if (!base) {
                base = window.location.origin + '/';
            }
            // Ensure base ends with single slash
            base = base.replace(/\/?$/, '/');

            // If segment is already an absolute URL, return as-is
            if (/^https?:\/\//i.test(segment)) {
                return segment;
            }
            // Normalize common known segments and encode only filename when present
            // Handle routes like "PDF" or "Group PDF"
            // Split by '/' and encode only parts that can have spaces (not keywords like 'pdf')
            const parts = segment.split('/').filter(p => p.length > 0);
            const encodedParts = parts.map((p, idx) => {
                // Keep typical route tokens lower-cased without encoding
                const token = p.trim();
                if (/^(pdf|grouppdf|group-pdf)$/i.test(token)) return token.replace(/\s+/g, '').toLowerCase();
                // encode other parts (e.g., filenames with spaces)
                return encodeURIComponent(token);
            });
            let url = base + encodedParts.join('/');
            // Collapse duplicate slashes (but keep protocol //)
            url = url.replace(/(?<!:)\/\/+/, '/');
            return url;
        } catch (e) {
            return pathOrFile;
        }
    }

    // Centralized PDF embed/print function used by all views
    function printEmbedDocument(testlink) {
        try {
            var apiBase = '@Session["APIurl"]';
            var url = buildPdfUrl(apiBase, testlink);

            // If server expects /pdf/<file>, and testlink is just filename, add prefix
            if (!/\/pdf\//i.test(url) && /\.pdf(\?|$)/i.test(url) === false) {
                // assume filename without extension may come; do not append .pdf blindly
                url = buildPdfUrl(apiBase, 'pdf/' + testlink);
            }

            // Use existing modal iframe in layout for preview/print
            var modal = document.getElementById('myiframePreview');
            var iframe = document.getElementById('iframepreview');
            if (!iframe) {
                // Fallback new tab if iframe is not present
                var w = window.open(url, '_blank');
                if (w) { w.focus(); }
                return;
            }
            iframe.src = url;
            if (modal) {
                modal.style.display = 'block';
            }

            // Optional: attempt to trigger print after load if route is for direct print usage
            iframe.onload = function () {
                try {
                    if (iframe.contentWindow) {
                        // Do not auto-print always; only if caller intends. Keeping preview default.
                        // iframe.contentWindow.focus();
                        // iframe.contentWindow.print();
                    }
                } catch (e) { /* cross-origin may block */ }
            };
        } catch (err) {
            // As a last resort, try opening original link
            var w2 = window.open(testlink, '_blank');
            if (w2) { w2.focus(); }
        }
    }

    var Aurl = '@Session["APIurl"]';
    var TableInvoiceCollection = $('#tblInvoiceCollectionData').DataTable({
        paging: false,
        searching: true,
        info: false,
        ordering: false,
        scrollY: "250px",
        scrollX: true,
        scrollCollapse: true,
        "columnDefs": [{ "targets": [0,4], "class": "text-center" }],
    });

    var modalInvColl = document.getElementById("myInvoiceCollectionModal");
    var span = document.getElementsByClassName("closeInvoiceCollectionModal")[0];
    span.onclick = function () {
        modalInvColl.style.display = "none";
    }
    $('#btncloseInvoiceCollectionModal').click(function (e) {
        modalInvColl.style.display = "none";
    });
    $("#sidedivcollapsed").hide();
    $("#sidenavfooter").hide();
    $(".sidenav,#sidenavfooter").css("width", "0%");// !important;
    $(".main,.footerAction").css("width", "99%");
    $(".main").css("margin-left", "0");

    $(".sidenav").mouseleave(function () {//
        console.log("Mouse leave trigger");
        $(".sidenav,#sidenavfooter").css("width", "0%");
        $(".main,.footerAction").css("width", "99%");
        $(".main").css("margin-left", "0");
        $("#sidenavfooter").hide();
        $("#sidedivexpand").show();
        $("#sidedivcollapsed").hide();
    });
    $("#sidedivexpand,.sideallmenus,#tdSideMenuIcon,#sidenav").mouseenter(function () {
        console.log("Mouse enter triiger");
        $(".sidenav,#sidenavfooter").css("width", "15%");
        $(".main,.footerAction").css("width", "85%");
        $(".main").css("margin-left", "15%");
        $("#sidenavfooter").show();
        $("#sidedivexpand").hide();
        $("#sidedivcollapsed").show();
    });

    function focussearch() {
        //document.getElementById("myInput").focus();
        document.getElementById("myModal").style.display = "block"
        //$('#myModal').modal('toggle');
        $("#myInput").focus();
    }
    myFunction();
    function myFunction() {
        document.getElementById("listContainer").classList.toggle("show");
    }
    //const searchInput = document.getElementById('myInput');
    //const optionsList = document.getElementById('myDropdown');

    var dropdown = document.getElementsByClassName("dropdown-btn");
    for (i = 0; i < dropdown.length; i++)
    {
        dropdown[i].addEventListener("click", function () {
            //this.classList.toggle("active");

            var sibs = $(this).siblings(".dropdown-btn");
            var sibscount = sibs.length;
            console.log(sibscount);
            var incr = 1;
            $(this).siblings(".dropdown-btn").each(function () {
                var dd = this.nextElementSibling;
                if (sibscount > incr)
                    dd.style.display = "none";
                incr++;
            });
            var dropdownContent = this.nextElementSibling;
            var lastdropdownContent = this.previousElementSibling;

            if (dropdownContent.style.display === "block") {
                dropdownContent.style.display = "none";
            }
            else {
                dropdownContent.style.display = "block";
            }
        });
    }
    //const buttons = document.querySelectorAll(".dropdown-btn");
    //buttons.forEach((button) => {
    //    button.addEventListener("click", function () {
    //        // Remove 'active' class from all buttons
    //        buttons.forEach((btn) => btn.classList.remove("active"));

    //        // Add 'active' class to the clicked button
    //        this.classList.add("active");
    //    });
    //});
    function filterFunction() {
        console.clear();
        var input, filter, ul, li, a, i;
        input = document.getElementById("myInput");
        filter = input.value.toUpperCase();
        div = document.getElementById("myDropdown");
        a = div.getElementsByTagName("a");
        var firstelement, ElementTaken = false;
        for (i = 0; i < a.length; i++) {
            txtValue = a[i].textContent || a[i].innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                a[i].style.display = "";

                if (!ElementTaken)
                    firstelement = a[i];
                ElementTaken = true;
                //a[0].style.color = 'green';
                console.log("1");
            }
            else
            {
                console.log("2");
                a[i].style.display = "none";

            }
        }
        //$(firstelement).addClass('first-row');
        //$(firstelement).select();
    }
    let currentIndex = -1;
    let filteredItems = [];

    document.getElementById("myInput").addEventListener("keyup", function (event) {
        if (event.key !== "ArrowDown" && event.key !== "ArrowUp" && event.key !== "Enter" && event.key !== "Escape") {
            searchDivs();
        }
        handleKeyNavigation(event);
    });

    function searchDivs() {
        let input = document.getElementById("myInput").value.toLowerCase();
        let items = document.querySelectorAll(".list-item");
        filteredItems = [];

        items.forEach(item => {
            item.classList.remove("highlight1", "selected");
            if (item.textContent.toLowerCase().includes(input)) {
                item.style.display = "block";
                filteredItems.push(item);
            } else {
                item.style.display = "none";
            }
        });

        // Reset selection
        currentIndex = filteredItems.length > 0 ? 0 : -1;
        if (filteredItems.length > 0) {
            filteredItems[0].classList.add("selected");
        }
    }

    function handleKeyNavigation(event) {
        if (filteredItems.length === 0) return;

        if (event.key === "ArrowDown") {
            if (currentIndex < filteredItems.length - 1) {
                filteredItems[currentIndex].classList.remove("selected");
                currentIndex++;
                filteredItems[currentIndex].classList.add("selected");
            }
        } else if (event.key === "ArrowUp") {
            if (currentIndex > 0) {
                filteredItems[currentIndex].classList.remove("selected");
                currentIndex--;
                filteredItems[currentIndex].classList.add("selected");
            }
        } else if (event.key === "Enter") {
            if (currentIndex !== -1) {
                let link = filteredItems[currentIndex].querySelector("a");
                if (link) {
                    //window.location.href = link.href; // Redirect to the selected link
                    window.open(link.href, '_blank');

                }
            }
        }
        else if (event.key === "Escape") {
            document.getElementById("myModal").style.display = "none";
        }
    }
    var modalQS = document.getElementById("myModal");
    var spanQS = document.getElementsByClassName("close")[0];
    spanQS.onclick = function () {
        //modalQS.style.display = "none";
        document.getElementById("myModal").style.display = "none";
    }
    $('#btnCloseQS').click(function (e) {
        //modalQS.style.display = "none";
        document.getElementById("myModal").style.display = "none";
    });
    var modalPrintAppPassword = document.getElementById("myPrintAppPasswordModal");
    var spanClosemodalPrintAppPassword = document.getElementsByClassName("closeprintapppwd")[0];
    spanClosemodalPrintAppPassword.onclick = function () {
        modalPrintAppPassword.style.display = "none";
    }
    $('#btncloseprintapppwd').click(function (e) {
        $("#txtPrintAppPassword").val("");
        modalPrintAppPassword.style.display = "none";
    });
    var modaliframe = document.getElementById("myModalfgiframe");
    var spaniframe = document.getElementsByClassName("closefgiframe")[0];
    spaniframe.onclick = function () {
        modaliframe.style.display = "none";
    }
    var modalFilterModal = document.getElementById("myDocFilterModal");
    var spanCloseDocFilterModal = document.getElementsByClassName("closemodalDocFilter")[0];
    spanCloseDocFilterModal.onclick = function () {
        modalFilterModal.style.display = "none";
    }
    $('#btncloseDocFilterModal').click(function (e) {
        modalFilterModal.style.display = "none";
    });
   // modalFilterModal.style.display = "block";
    $('#btnSubmitprintAppPwd').click(function (e) {
        if ($("#txtPrintAppPassword").val() == "") {
            showErrorSnackbar("Password should not be empty");
            $("#txtPrintAppPassword").focus();
        } else {
            $.ajax({
                url: Aurl + "verifyapppassword/verify",
                type: 'get',
                contentType: 'json',
                data: { ID: 8, Pwd: $("#txtPrintAppPassword").val() },
                xhrFields: {
                    withCredentials: true
                },
                success: function (data) {
                    $.each(data, function (i, items) {
                        if (items.MsgID == 0) {
                            var PrintorPdf = $("#txtCommonPrintPrevieworPDF").val();
                            var ID = $("#txtCommonPrintTransID").val();
                            var TranType = $("#txtCommonPrintTranTypeID").val();
                            var ConfigID = $("#txtCommonPrintConfigID").val();
                            if (PrintorPdf == 1) {
                                PrintDocument(ID, TranType, ConfigID);
                            }
                            else {
                                PDFDocument(ID, TranType, ConfigID);
                            }
                            $("#txtPrintAppPassword").val("");
                            modalPrintAppPassword.style.display = "none";
                        }
                        else {
                            showErrorSnackbar(items.Message)
                        }
                    });
                }
            });
        }
    });
    document.addEventListener("keydown", function (event) {
        if (event.key === "F3") {
            document.getElementById("myModal").style.display = "block"
            //$('#myModal').modal('toggle');
            focussearch();
            event.preventDefault();
        }

    });
    $('input, select').on('keydown', function (e) {
        //if (e.key === "Enter") {
        //    console.log("Enter 2");
        //    e.preventDefault(); // Prevent default behavior
        //    let $next = $(this).nextAll('input, select').first(); // Find the next input or select
        //    if ($next.length) {
        //        $next.focus(); // Focus the next element
        //    }
        //}
    });
    //$(document).on('keydown', ':focusable', function (e) {
    //    if (e.which == 13) {
    //        if (e.target.localName != "button") {
    //            e.preventDefault();
    //            //var $canfocus = $(':focusable');
    //            //var btn = $canfocus.button;
    //            //var index = $canfocus.index(this) + 1;
    //            //var tabindex = e.target.tabIndex;
    //            ////index = tabindex;
    //            //if (index >= $canfocus.length) index = 0;
    //            //$canfocus.eq(index).focus();

    //            let active = document.activeElement;
    //            let target = $('[tabindex="' + (active.tabIndex + 1) + '"]');
    //            if (target.length > 0) {
    //                if (target[0].disabled) {
    //                    target = $('[tabindex="' + (active.tabIndex + 2) + '"]');
    //                    if (target[0].disabled) {
    //                        target = $('[tabindex="' + (active.tabIndex + 3) + '"]');
    //                    }
    //                }
    //                target.focus();
    //            }
    //        }
    //    }
    //    if (e.shiftKey && e.which == 13) {
    //        e.preventDefault();
    //        var $canfocus = $(':focusable');
    //        var index = $canfocus.index(this) - 1;
    //        if (index >= $canfocus.length) index = 0;
    //        $canfocus.eq(index).focus();
    //    }
    //});

    function InvoiceCollectionModalPopup(InvID) {
        TableInvoiceCollection.draw().clear(); TableInvoiceCollection.draw().clear();
        $("#lblInvCollAssignInvoice,#lblInvCollAssignInvoiceTotal,#lblInvCollAssignInvoiceOS").text("0");
        $.ajax({
            url: Aurl + "invoice/invoicecollectiondata",
            type: 'get',
            contentType: 'json',
            data: { InvoiceID: InvID },
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                if (data.length > 0) {
                    modalInvColl.style.display = "block";
                    var Tot = 0, InvoiceAmt = 0;
                    $.each(eval(data), function (i, items) {
                        TableInvoiceCollection.row.add([
                            (i + 1),
                            items.DocID,
                            items.ColDate,
                            items.ColAmt,
                            items.Ageing,
                            items.PaymentMode
                        ]).draw(false);
                        Tot += parseFloat(items.ColAmt);
                        $("lblInvCollAssignInvoice").text(items.AssignedInvoices);
                        InvoiceAmt = items.InvoiceAmt;
                    });
                    var os = parseFloat(InvoiceAmt) - Tot;
                    $("#lblInvCollAssignInvoiceTotal").text(parseFloat(Tot).toFixed(DecVal));
                    $("#lblInvCollAssignInvoiceOS").text(parseFloat(os).toFixed(DecVal));
                } else {
                    modalInvColl.style.display = "none";
                    showErrorSnackbar("Not yet collected");
                }
            }
        });
    }

    GetColorData(1, '@Session["ThemeID"]');

    GetFilterComboData();
    function GetFilterComboData() {
        var FDT = '@Session["FilterDateType"]';
        $.ajax({
            url: Aurl + "getfilterdates/get",
            type: 'get',
            contentType: 'json',
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                $('#cmbFilterDatetype').find("option").remove();
                $.each(eval(data), function (i, items) {
                    $('#cmbFilterDatetype').append($('<option/>', {
                        value: items.ID,
                        text: items.Code,
                        title: items.Name
                    }));
                });
                $('#cmbFilterDatetype').val(FDT);
                SetFilterDate();
            }
        });
    }
    $("#hrefbakup").click(function () {
        $('body').append('<div style="" id="loadingDiv"><div class="loader"></div><div class="LoaderMsg">Backup database processing... Please wait</div></div>');
        $(".sidenav,#sidenavfooter").css("width", "0%");
        $(".main,.footerAction").css("width", "99%");
        $(".main").css("margin-left", "0");
        $("#sidenavfooter").hide();
        $("#sidedivexpand").show();
        $("#sidedivcollapsed").hide();
        $.ajax({
            url: Aurl + "backupfile",
            type: 'get',
            contentType: 'json',
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                $("#loadingDiv").remove();
                console.log("data", data);
                $.each(data, function (i, items) {
                    if (items.MsgID == "0") {
                        showSuccessSnackbar(items.Message);
                    }
                    else {
                        showErrorSnackbar(items.Message);
                    }
                });
            },
            error: function (data) {
                $("#loadingDiv").remove();
                showErrorSnackbar("Backup failed");
            },
        });
    });
    $('input, select ,button, textarea').on('keydown', function (e) {
        if (e.key === "Enter") {
            if (e.target.localName != "button") {
                e.preventDefault(); // Prevent default behavior
                var nextinp = $('input:not([type=hidden]):not([readonly]):not([disabled]),select:not([disabled]),button, textarea').eq($('input:not([type=hidden]):not([readonly]):not([disabled]),select,button, textarea').index(this) + 1);
                //console.log(nextinp);
                var hasclass = $(this).hasClass('ui-autocomplete-input');
                if (hasclass)// Enter from Autocomplete field
                {
                    var lencls = $('.ui-menu-item').length;
                    var vbl = $('.ui-menu-item').is(":visible");
                    //console.log("Visble : ", vbl, " ui-menu-item Count : " + lencls);
                    if (!vbl)
                    {
                        if (nextinp.length) {
                            var strType = nextinp[0].localName;
                            if (strType != "button") {
                                nextinp.focus();
                                nextinp.select();
                            }
                            else {
                                const isSaveDisabled = $("#btnSave").is(":disabled");
                                const isClearDisabled = $("#btnClear").is(":disabled");
                                if (!isSaveDisabled) {
                                    $("#btnSave").focus();
                                    $("#btnSave").select();
                                } else {
                                    $("#btnClose").focus();
                                    $("#btnClose").select();
                                }
                            }
                        }
                    }
                }
                else
                {
                    if (nextinp.length) {
                        var strType = nextinp[0].localName;
                        if (strType != "button") {
                            nextinp.focus();
                            nextinp.select();
                        }
                        else {
                            const isSaveDisabled = $("#btnSave").is(":disabled");
                            if (!isSaveDisabled) {
                                $("#btnSave").focus();
                                $("#btnSave").select();
                            } else {
                                $("#btnClose").focus();
                                $("#btnClose").select();
                            }
                        }
                    }
                }
            }
        }
        else if (e.key === 'ArrowLeft' && e.target.id === "btnSave") {
            $("#btnClear").focus();
            $("#btnClear").select();
        } else if (e.key === 'ArrowRight' && e.target.id === "btnSave") {
            $("#btnClose").focus();
            $("#btnClose").select();
        } else if (e.key === 'ArrowRight' && e.target.id === "btnClear") {
            $("#btnSave").focus();
            $("#btnSave").select();
        } else if (e.key === 'ArrowLeft' && e.target.id === "btnClose") {
            $("#btnSave").focus();
            $("#btnSave").select();
        }
        if (e.shiftKey && e.which == 13) {
            e.preventDefault();
            var $canfocus = $(':focusable');
            var index = $canfocus.index(this) - 1;
            if (index >= $canfocus.length) index = 0;
            $canfocus.eq(index).focus();
        }
    });
    if ($('#tblProductData').length) {
        $('#tblProductData tbody').sortable({
            items: 'tr',
            cursor: 'move',
            opacity: 0.6,
            helper: function(e, ui) {
                // Preserve the width of cells in the helper
                ui.children().each(function() {
                    $(this).width($(this).width());
                });
                return ui;
            },
            update: function (event, ui) {
                // Sortable has changed the DOM order
                // Strategy: Save edited values, rebuild DataTable, then restore values to new DOM
                
                // Step 1: Save DOM nodes with their edited values
                var savedRowData = [];
                $('#tblProductData tbody tr').each(function() {
                    var $oldRow = $(this);
                    var dtRowData = ProductTable.row(this).data();
                    
                    // Capture all current input values from the DOM
                    var editedValues = {
                        dtData: dtRowData,
                        inputs: {},
                        selects: {},
                        labels: {}
                    };
                    
                    $oldRow.find('input').each(function() {
                        var id = $(this).attr('id');
                        if (id) {
                            editedValues.inputs[id] = {
                                value: $(this).val(),
                                txttag: $(this).attr('txttag')
                            };
                        }
                    });
                    
                    $oldRow.find('select').each(function() {
                        var id = $(this).attr('id');
                        if (id) {
                            editedValues.selects[id] = $(this).val();
                        }
                    });
                    
                    $oldRow.find('label').each(function() {
                        var id = $(this).attr('id');
                        if (id) {
                            editedValues.labels[id] = {
                                text: $(this).text(),
                                lbltag: $(this).attr('lbltag')
                            };
                        }
                    });
                    
                    savedRowData.push(editedValues);
                });
                
                // Step 2: Rebuild DataTable in new order
                ProductTable.clear();
                savedRowData.forEach(function(rowData) {
                    if (rowData.dtData) {
                        ProductTable.row.add(rowData.dtData);
                    }
                });
                ProductTable.draw(false);
                
                // Step 3: Restore edited values to the NEW DOM nodes created by DataTable
                $('#tblProductData tbody tr').each(function(index) {
                    var $newRow = $(this);
                    var editedData = savedRowData[index];
                    
                    if (editedData) {
                        // Restore input values
                        $.each(editedData.inputs, function(id, data) {
                            var $input = $newRow.find('#' + id);
                            if ($input.length) {
                                $input.val(data.value);
                                if (data.txttag) {
                                    $input.attr('txttag', data.txttag);
                                }
                            }
                        });
                        
                        // Restore select values
                        $.each(editedData.selects, function(id, value) {
                            var $select = $newRow.find('#' + id);
                            if ($select.length) {
                                $select.val(value);
                            }
                        });
                        
                        // Restore label values
                        $.each(editedData.labels, function(id, data) {
                            var $label = $newRow.find('#' + id);
                            if ($label.length) {
                                $label.text(data.text);
                                if (data.lbltag) {
                                    $label.attr('lbltag', data.lbltag);
                                }
                            }
                        });
                    }
                });
                
                // Step 4: Update serial numbers
                ReorderSerialNo();
                
                //console.log("Rows interchanged, indices synced, values preserved!");
            }
        });
    }    
    $('#tblProductData tbody').on('click', 'tr', function () {
        //alert('Row index: ' + ProductTable.row(this).index());
        var tttselrid = ProductTable.row(this).index()
        console.log("Click row index : ", tttselrid);
    });
    function arrowKeyHandlersave(e) {
        if (e.key === "ArrowRight") {
            e.preventDefault();
            document.querySelector(".clsNo")?.focus();
        } else if (e.key === "ArrowLeft") {
            e.preventDefault();
            document.querySelector(".clsYes")?.focus();
        }
    }
        var cfFocus = '@Session["ConfirmFocus"]';
    function ConfirmDialogMsg(message) {
        var IsAccepted = false;
        $('<div></div>').appendTo('body')
            .html('<div><h6>' + message + '</h6></div>')
            .dialog({
                modal: true,
                closeOnEscape: true,
                title: 'Confirm Popup',
                zIndex: 100,
                autoOpen: true,
                width: '300px',
                resizable: true,
                close: false,
                open: function () {
                    document.addEventListener("keydown", arrowKeyHandlersave);
                    $(this).closest(".ui-dialog")
                        .find(".ui-dialog-titlebar-close")
                        .removeClass("ui-dialog-titlebar-close")
                        .html("x");
                },
                close: function () {
                    // Remove event listener when dialog is closed
                    document.removeEventListener("keydown", arrowKeyHandlersave);
                    $(this).dialog("destroy").remove(); // Fully remove the dialog from DOM

                },
                buttons: [
                    {
                        text: "Yes",
                        class: "btn btn-success clsYes",
                        click: function () {
                            $(this).dialog("close");
                            SaveData();
                        },
                    },
                    {
                        text: "No",
                        class: "btn btn-danger clsNo cfforeclr",
                        click: function () {
                            $(this).dialog("close");
                        }
                    }
                ],
            });
        if (cfFocus == 1) {
            $(".clsYes").focus();
        }
        else if (cfFocus == 2) {
            $(".clsNo").focus();
        }
    };
    var ClearcfFocus = '@Session["ClearConfirmFocus"]';
    //$(".ui-dialog-titlebar-close").html('x');
    function ClearConfirmDialogMsg(message) {
        var IsAccepted = false;
        $('<div></div>').appendTo('body')
            .html('<div><h6>' + message + '</h6></div>')
            .dialog({
                modal: true,
                closeOnEscape: true,
                title: 'Confirm Popup',
                zIndex: 100,
                autoOpen: true,
                width: '300px',
                resizable: true,
                close: false,
                open: function () {
                    document.addEventListener("keydown", arrowKeyHandlersave);
                    $(this).closest(".ui-dialog")
                        .find(".ui-dialog-titlebar-close")
                        .removeClass("ui-dialog-titlebar-close")
                        .html("x");
                },
                close: function () {
                    // Remove event listener when dialog is closed
                    document.removeEventListener("keydown", arrowKeyHandlersave);
                    $(this).dialog("destroy").remove(); // Fully remove the dialog from DOM

                },
                buttons: [
                    {
                        text: "Yes",
                        class: "btn btn-success clsYes",//clsclrYes
                        click: function () {
                            $(this).dialog("close");
                            ClearForm();
                        },
                    },
                    {
                        text: "No",
                        class: "btn btn-danger clsNo",//clsclrNo
                        click: function () {
                            $(this).dialog("close");
                        }
                    }
                ],
            });
        if (ClearcfFocus == 1) {
            $(".clsYes").focus();
        }
        else {
            $(".clsNo").focus();
        }
    };
    var ClosecfFocus = '@Session["CloseConfirmFocus"]';
//$(".ui-dialog-titlebar-close").html('x');
function CloseConfirmDialogMsg(message) {
    var IsAccepted = false;
    $('<div></div>').appendTo('body')
        .html('<div><h6>' + message + '</h6></div>')
        .dialog({
            modal: true,
            closeOnEscape: true,
            title: 'Confirm Popup',
            zIndex: 100,
            autoOpen: true,
            width: '300px',
            resizable: true,
            close: false,
            open: function () {
                document.addEventListener("keydown", arrowKeyHandlersave);
                $(this).closest(".ui-dialog")
                    .find(".ui-dialog-titlebar-close")
                    .removeClass("ui-dialog-titlebar-close")
                    .html("x");
            },
            close: function () {
                // Remove event listener when dialog is closed
                document.removeEventListener("keydown", arrowKeyHandlersave);
                $(this).dialog("destroy").remove(); // Fully remove the dialog from DOM

            },
            buttons: [
                {
                    text: "Yes",
                    class: "btn btn-success clsYes",//clsclsYes
                    click: function () {
                        $(this).dialog("close");
                        CloseForm();
                    },
                },
                {
                    text: "No",
                    class: "btn btn-danger clsNo",//clsclsNo
                    click: function () {
                        $(this).dialog("close");
                    }
                }
            ],
        });
    if (ClosecfFocus == 1) {
        $(".clsYes").focus();
    }
    else {
        $(".clsNo").focus();
    }
    };

    var allowprint = '@Session["AllowPrint"]';
    function PrintConfirmDialogMsg(ID, TypeID, nConfigID, message) {
        var IsAccepted = false;
        $(".ui-dialog-titlebar-close").hide();
        $('<div></div>').appendTo('body')
            .html('<div><h6>' + message + '</h6></div>')
            .dialog({
                modal: true,
                closeOnEscape: true,
                title: 'Confirm Print Popup',
                zIndex: 10000,
                autoOpen: true,
                width: '300px',
                resizable: true,
                close: false,
                open: function () {
                    document.addEventListener("keydown", arrowKeyHandlersave);
                    $(this).closest(".ui-dialog")
                        .find(".ui-dialog-titlebar-close")
                        .removeClass("ui-dialog-titlebar-close")
                        .html("x");
                },
                close: function () {
                    // Remove event listener when dialog is closed
                    document.removeEventListener("keydown", arrowKeyHandlersave);
                    $(this).dialog("destroy").remove(); // Fully remove the dialog from DOM

                },
                buttons: [
                    {
                        text: "Yes",
                        class: "btn btn-success clsYes",
                        click: function () {
                            $(this).dialog("close");
                            PrintDocument(ID, TypeID, nConfigID);
                        },
                    },
                    {
                        text: "No",
                        class: "btn btn-danger clsNo cfforeclr",
                        click: function () {
                            $(this).dialog("close");
                        }
                    }
                ],
            });
        if (allowprint == 3) {
            $(".clsYes").focus();
        }
        else if (allowprint == 4) {
            $(".clsNo").focus();
        }
    };
    setupArrowKeyNavigation();
    // 👇 Function to apply keydown listener to all input elements in the table
    function setupArrowKeyNavigation() {
        if ($('#tblProductData').length) {
            const allInputs = document.querySelectorAll('#tblProductData tbody input');
            //allInputs.forEach((input, index) => {
            //    input.onkeydown = function (e) {
            //        const currentRow = input.closest('tr');
            //        const inputIndex = Array.from(currentRow.querySelectorAll('input')).indexOf(input);
            //        if (e.key === 'ArrowDown') {
            //            const nextRow = currentRow.nextElementSibling;
            //            if (nextRow) {
            //                const nextInputs = nextRow.querySelectorAll('input');
            //                if (nextInputs[inputIndex]) nextInputs[inputIndex].focus();
            //                e.preventDefault();
            //            }
            //        }
            //        if (e.key === 'ArrowUp') {
            //            const prevRow = currentRow.previousElementSibling;
            //            if (prevRow) {
            //                const prevInputs = prevRow.querySelectorAll('input');
            //                if (prevInputs[inputIndex]) prevInputs[inputIndex].focus();
            //                e.preventDefault();
            //            }
            //        }
            //        if (e.key === 'Enter') {
            //            const allInputsList = Array.from(document.querySelectorAll('#tblProductData tbody input'));
            //            const currentInputIndex = allInputsList.indexOf(input);
            //            const nextInput = allInputsList[currentInputIndex + 1];

            //            if (nextInput) {
            //                nextInput.focus();
            //            } else {
            //                // Call your add row function here
            //                Addprodgridline();
            //                setTimeout(() => {
            //                    const newInputs = document.querySelectorAll('#tblProductData tbody tr:last-child input');
            //                    if (newInputs[0]) newInputs[0].focus();
            //                }, 100);
            //            }
            //            e.preventDefault();
            //        }

            //    };
            //});
            allInputs.forEach((input, index) => {
                input.onkeydown = function (e) {
                    const currentRow = input.closest('tr');
                    const inputsInRow = Array.from(currentRow.querySelectorAll('input'));
                    const inputIndex = inputsInRow.indexOf(input);
                    var hasclass = $(this).hasClass('ui-autocomplete-input');
                    if (e.key === 'ArrowDown') {
                        if (hasclass) {
                            var vbl = $('.ui-menu-item').is(":visible");
                            if (vbl) {
                                //console.log("Autolist field Down");
                            }
                        }
                        else {
                            const nextRow = currentRow.nextElementSibling;
                            if (nextRow) {
                                const nextInputs = nextRow.querySelectorAll('input');
                                if (nextInputs[inputIndex]) nextInputs[inputIndex].focus();
                                e.preventDefault();
                            }
                        }
                    }

                    if (e.key === 'ArrowUp') {
                        if (hasclass) {
                            var vbl = $('.ui-menu-item').is(":visible");
                            if (vbl) {
                                //console.log("Autolist field Down");
                            }
                        }
                        else {
                            const prevRow = currentRow.previousElementSibling;
                            if (prevRow) {
                                const prevInputs = prevRow.querySelectorAll('input');
                                if (prevInputs[inputIndex]) prevInputs[inputIndex].focus();
                                e.preventDefault();
                            }
                        }
                    }

                    if (e.key === 'ArrowRight') {
                        const nextInput = inputsInRow[inputIndex + 1];
                        if (nextInput) {
                            nextInput.focus();
                            e.preventDefault();
                        }
                    }

                    if (e.key === 'ArrowLeft') {
                        const prevInput = inputsInRow[inputIndex - 1];
                        if (prevInput) {
                            prevInput.focus();
                            e.preventDefault();
                        }
                    }

                    if (e.key === 'Enter') {
                        const allInputsList = Array.from(document.querySelectorAll('#tblProductData tbody input'));
                        const currentInputIndex = allInputsList.indexOf(input);
                        const nextInput = allInputsList[currentInputIndex + 1];

                        if (nextInput) {
                            var nm = nextInput.name;
                            if (nm == "ProdDiscPern") {
                                setTimeout(() => {
                                    const newInputs = document.querySelectorAll('#tblProductData tbody tr:last-child input');
                                    if (newInputs[0]) newInputs[0].focus();
                                }, 100);
                            } else {
                                nextInput.focus();
                            }
                        } else {
                            // Call your add row function here
                            Addprodgridline();
                            setTimeout(() => {
                                const newInputs = document.querySelectorAll('#tblProductData tbody tr:last-child input');
                                if (newInputs[0]) newInputs[0].focus();
                            }, 100);
                        }
                        e.preventDefault();
                    }
                };
            });

        }
    }
    function InfoDialogMsg(message, Heading) {
        var IsAccepted = false;
        $(".ui-dialog-titlebar-close").hide();
        $('<div></div>').appendTo('body')
            .html('<div><h6>' + message + '</h6></div>')
            .dialog({
                modal: true,
                closeOnEscape: true,
                title: Heading,
                zIndex: 100,
                autoOpen: true,
                width: '400px',
                resizable: true,
                close: false,
                open: function () {
                    $(this).closest(".ui-dialog")
                        .find(".ui-dialog-titlebar-close")
                        .removeClass("ui-dialog-titlebar-close")
                        .html("x");
                },
                buttons: [
                    {
                        text: "Close",
                        class: "btn btn-warning clsclrNo",
                        click: function () {
                            $(this).dialog("close");
                        }
                    }
                ],
            });
        $(".clsclrNo").focus();
    };
    function OpenOneView(ID, PartyType) {
        var Url = '@Session["url"].ToString()';
        var EnablePurchaseOneView = '@Session["PurchaseOneView"]';
        var EnableSalesOneView = '@Session["SalesOneView"]';
        vw = window.innerWidth - 100;
        vh = window.innerHeight - 50;

        const left = window.screenX + (window.innerWidth - vw) / 2;
        const top = window.screenY + (window.innerHeight - vh) / 2;
        //Session["PurchaseOneView"],Session["SalesOneView"]
        var OpenOneView = false;
        if (PartyType == 1)//customer
        {
            OpenOneView = EnableSalesOneView == "1";
        } else if (PartyType == 2)//vendor
        {
            OpenOneView = EnablePurchaseOneView == "1";
        }
        if (OpenOneView) {
            var SCDUrl = Url + "OneView?name=sH%2BTEIdelWKGNxqaVlmc0mDpErf3b%2B6xXTQX8LLAeLU%3D&strFormID=jJOtHsRVwYECOhoiBc69dA%3D%3D&TypeID=jJOtHsRVwYECOhoiBc69dA%3D%3D&TranID=jJOtHsRVwYECOhoiBc69dA%3D%3D&ID=" + ID + "&PartyType=" + PartyType;
            window.open(SCDUrl, "_blank", "width=" + vw + ",height=" + vh + ",top=" + top + ",left=" + left + ",scrollbars=yes,resizable=yes");
        }
    }
    function GetBranchwiseABSQty(nProdID) {
        $.ajax({
            url: Aurl + "automaticindent/getbranchqty",
            type: 'get',
            contentType: 'json',
            data: { ProdID: nProdID },
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                var Branches = "", ProdName = "", ProdCode = "", totabs = 0, totFreeabs = 0, totDmgabs = 0;
                $.each(data, function (i, items) {
                    ProdName = items.Name; ProdCode = items.Code;
                    Branches += '<tr><td align="left">' + items.Branch + '</td><td align="right">' + items.ABSQty + '</td><td align="right">' + items.ABSFreeQty + '</td><td align="right">' + items.ABSDmgQty + '</td></tr>';
                    totabs += parseFloat(items.ABSQty);
                    totFreeabs += parseFloat(items.ABSFreeQty);
                    totDmgabs += parseFloat(items.ABSDmgQty);
                });
                var branchinfo = '<table class="table table-bordered" style="text-align:center;font-size:12px"><tr><td colspan="4" align="left">' + ProdName + '</td></tr><tr><td><b>Branch Name</b></td><td><b>Qty</b></td><td><b>Free</b></td><td><b>Dmg</b></td></tr>';
                branchinfo += Branches;
                branchinfo += '<tr><td></td><td align="right" style="font-size:14px;"><b>' + parseFloat(totabs).toFixed(DecVal) + '</b></td><td align="right" style="font-size:14px;"><b>' + parseFloat(totFreeabs).toFixed(DecVal) + '</b></td><td align="right" style="font-size:14px;"><b>' + parseFloat(totDmgabs).toFixed(DecVal) + '</b></td></tr></table>';
                setTimeout(() => {
                    InfoDialogMsg(branchinfo, "Branch wise Qty");
                }, 500)
            }
        });
    }
    var albgc = "";
    function GetColorData(nMode, strName = null) {
        $.ajax({
            url: Aurl + "colorsettings/get",
            type: 'get',
            contentType: 'json',
            data: { Mode: nMode, Name: strName },
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                if (nMode == 1) {
                    $.each(data, function (i, items) {
                        $(".navbar-fixed-top,.sidenav,.dropdown-container,.dvmainmenuheader").css("background-color", items.MenuHeader);
                        $("#acompname,#algot").css("color", items.CompanyNameColor);

                        $(".btn-info").css("background-color", items.AddButton);

                        $(".btn-primary").css("background-color", items.DraftButton);
                        $(".btn-success").css("background-color", items.SaveButton);

                        $(".btn-danger").css("background-color", items.ClearButton);

                        $(".btn-warning").css("background-color", items.CloseButton);

                        $(".clrforpdf").css("background-color", items.PDFButton);
                        $(".clrforpreview").css("background-color", items.PreviewButton);
                        $(".clrforpdf").css("color", "white");
                        $(".clrforpreview").css("color", "white");
                        $(".modal-header").css("background-color", items.PopupHeader);

                        $(".modal-footer").css("background-color", items.PopupFooter);

                        $(".clsclrYes,.clsYes").css("background-color", items.ConfirmPopupYes);

                        $(".clsclrNo,.clsNo").css("background-color", items.ConfirmPopupNo);

                        $("ul a").css("color", items.SubMenuColor);
                        $(".dropdown-btn").css("color", items.MenuColor);
                        $(".trclrforcolheader").css("background-color", items.GridHeaderBackGround);
                        $(".trclrforcolheader").css("color", items.GridHeaderTextColor);
                        $(".modal-title").css("color", items.PopupHeaderText);
                        //$(".ui-menu-item-wrapper.ui-state-active").attr("style", "background-color: " + items.AutocompleteBG + " !important");
                        document.documentElement.style.setProperty('--dynamic-bg', items.AutocompleteBG);
                        //$(".acItem .name").css("color", items.AutocompleteLine1);
                        document.documentElement.style.setProperty('--acitemname', items.AutocompleteLine1);
                        //$(".acItem .desc").css("color", items.AutocompleteLine2);
                        document.documentElement.style.setProperty('--acitemdesc', items.AutocompleteLine2);
                    });
                }
            }
        });
    }
    function animateCounter(id, start, end, duration) {
        if (end !== "" && end !== null) {
            const obj = document.getElementById(id);
            const range = end - start;
            let current = start;
            const fps = 60; // smooth animation: 60 frames per second
            const totalSteps = duration / (1000 / fps);
            const increment = range / totalSteps;
            let stepCount = 0;

            const timer = setInterval(() => {
                stepCount++;
                current += increment;
                if ((range > 0 && current >= end) || (range < 0 && current <= end) || stepCount >= totalSteps) {
                    current = end; // Ensure it ends exactly
                    clearInterval(timer);
                }
                obj.textContent = current.toFixed(2); // change decimal places as needed
            }, 1000 / fps);
        }
    }
    function formatIndianCurrency(num) {
        return '₹ ' + parseFloat(num).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function disableNumberFieldControls() {
        document.querySelectorAll('table input[type="number"]').forEach(function (input) {
            // Block arrow key increment
            input.addEventListener('keydown', function (e) {
                if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                    e.preventDefault();
                }
            });

            // Block scroll wheel increment
            input.addEventListener('wheel', function (e) {
                e.preventDefault();
            });
        });
    }
    // Run on page load
    document.addEventListener('DOMContentLoaded', function () {
        disableNumberFieldControls();
    });
    // If using jQuery DataTables or dynamic tables, also hook into redraw:
    $(document).on('draw.dt', function () {
        disableNumberFieldControls();
    });

    $('#cmbPrintProfile').change(function (e) {
        var selval = e.target.value;
        if (selval > 0) {
            PrintConfigID = $('#cmbPrintProfile').val();
        } else {
            $('#cmbPrintProfile').val(PrintConfigID);
        }
    });

        $("#btnPrint,#btniframePrint").click(function (e) {
        //modalPayment.style.display = "block";
        var id = $("#txtID").val() == "" ? 0 : $("#txtID").val();
        var sts = $("#txtStatus").val();
        if (PrintConfigID > 0) {
            if (id > 0) {
                if (sts != 2 && sts != 4) {
                    if (allowprint == 1) {
                        PrintDocument(id, PrintTransID, PrintConfigID);
                    } else if (allowprint == 3 || allowprint == 4) {
                        PrintConfirmDialogMsg(id, PrintTransID, PrintConfigID, "Do you want to print ?");
                    }
                    else {
                        showErrorSnackbar("Unable to print. Print Document is disabled in Application config.");
                    }
                }
                else {
                    if (allowprint != 2) {
                        modalPrintAppPassword.style.display = "block";
                        $("#txtCommonPrintPrevieworPDF").val(1);//1 - Preview , 2 - PDF
                        $("#txtCommonPrintTransID").val(id);
                        $("#txtCommonPrintTranTypeID").val(PrintTransID);
                        $("#txtCommonPrintConfigID").val(PrintConfigID);
                    }
                    else {
                        showErrorSnackbar("Unable to print. Print Document is disabled in Application config.");
                    }
                }
                //PrintDocument(id, 4);
            }
        }
        else {
            showErrorSnackbar("Select Print profile");
        }
    });
    $("#btnPreview").click(function (e) {
        //modalPayment.style.display = "block";
        var id = $("#txtID").val() == "" ? 0 : $("#txtID").val();
        var sts = $("#txtStatus").val();
        if (PrintConfigID > 0) {
            if (id > 0) {
                if (sts != 2 && sts != 4) {
                    PrintDocument(id, PrintTransID, PrintConfigID, 1);
                }
                else {
                    if (allowprint != 2) {
                        modalPrintAppPassword.style.display = "block";
                        $("#txtCommonPrintPrevieworPDF").val(1);//1 - Preview , 2 - PDF
                        $("#txtCommonPrintTransID").val(id);
                        $("#txtCommonPrintTranTypeID").val(PrintTransID);
                        $("#txtCommonPrintConfigID").val(PrintConfigID);
                    }
                    else {
                        showErrorSnackbar("Unable to print. Print Document is disabled in Application config.");
                    }
                }
                //PrintDocument(id, 4);
            }
        }
        else {
            showErrorSnackbar("Select Print profile");
        }
    });
    $("#btnPDF,#btniframePDF").click(function (e) {
        //modalPayment.style.display = "block";
        var id = $("#txtID").val() == "" ? 0 : $("#txtID").val();
        var sts = $("#txtStatus").val();
        //showSuccessSnackbar("sts : " + sts+ " allowprint : " + allowprint);
        if (PrintConfigID > 0) {
            if (id > 0) {
                //PDFDocument(id, 4, 1);
                if (sts != 2 && sts!= 4) {// || sts == 3 || sts == 5
                    if (allowprint != 2) {
                        PDFDocument(id, PrintTransID, PrintConfigID);
                    }
                    else {
                        showErrorSnackbar("Unable to print. Print Document is disabled in Application config.");
                    }
                }
                else {
                    if (allowprint != 2) {
                        modalPrintAppPassword.style.display = "block";
                        $("#txtCommonPrintPrevieworPDF").val(2);//1 - Preview , 2 - PDF
                        $("#txtCommonPrintTransID").val(id);
                        $("#txtCommonPrintTranTypeID").val(PrintTransID);
                        $("#txtCommonPrintConfigID").val(PrintConfigID);
                    }
                    else {
                        showErrorSnackbar("Unable to print. Print Document is disabled in Application config.");
                    }
                }
            }
        }
        else {
            showErrorSnackbar("Select Print profile");
        }
    });
    function PrintDocument(ID, strTransID, nConfigID, printorpreview = 0) {
        if (nConfigID > 0) {
        $.ajax({
            //url: '@Url.Action("PDFGenerate", "Invoice")',
            url: Aurl + "invoice/PDFGenerate",
            type: 'GET',
            datatype: 'json',
            data: { DocID: ID, TransID: strTransID, ConfigID: nConfigID },
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                if (data.length > 0) {
                    var pdfpathDownload = 'Invoice/ExportData?Fname=' + data;
                    var pdfpathPreview = 'Invoice/PreviewData?Fname=' + data;

                    var tempurl = Aurl.replace("/api/", "/");
                    if (printorpreview == 0) {
                        printEmbedDocument(tempurl + "PDF/" + data);//myurl
                    } else {

                        previewiframe(tempurl + "PDF/" + data);//myurl
                    }
                } else {
                    showErrorSnackbar('PDF File not generate. Try Again');
                }
            }, error: function (data) {
                if (data.status == "401") {
                    var msg = data.responseJSON.Message;
                    //showErrorSnackbar(msg + " Logout and Login again.");
                }
            }
        });
        }
        else {
            showErrorSnackbar("Select Print profile");
        }
    }
    function PDFDocument(ID, strTransID, nConfigID) {
        if (nConfigID > 0) {
            $.ajax({
                //url: '@Url.Action("PDFGenerate", "Invoice")',
                url: Aurl + "invoice/PDFGenerate",
                type: 'GET',
                datatype: 'json',
                data: { DocID: ID, TransID: strTransID, ConfigID: nConfigID },
                xhrFields: {
                    withCredentials: true
                },
                success: function (data) {
                    if (data.length > 0) {
                        //location.href = 'Invoice/ExportData?Fname=' + data;
                        location.href = Aurl + 'Invoice/downloadprint?Fname=' + data;
                    } else {
                        showErrorSnackbar('PDF File not generate. Try Again');
                    }
                }, error: function (data) {
                    if (data.status == "401") {
                        var msg = data.responseJSON.Message;
                        //showErrorSnackbar(msg + " Logout and Login again.");
                    }
                }
            });
        }
        else {
            showErrorSnackbar("Select Print profile");
        }
    }
    var myurl = '@Session["url"]';
    function printEmbedDocument(testlink) {
        //testlink = "https://morth.nic.in/sites/default/files/dd12-13_0.pdf";
        //testlink = "https://www.gksapp.in/VIG001api/myUploadFiles/pot1.pdf"
        //testlink = "https://localhost:44396/pdf/INV_2425_200_202511101208256146.pdf"; // API
        //testlink = "https://localhost:44326/pdf/INV_2425_200_202511101208256146.pdf" // UI
        // Fetch the remote file
        console.log("testlink", testlink)
        fetch(testlink)
            .then(response => response.blob())
            .then(pdfBlob => {
                const pdfURL = URL.createObjectURL(pdfBlob);
                console.log("pdfURL", pdfURL);
                let ifr = document.createElement("iframe");
                ifr.style.position = 'absolute';
                ifr.style.width = "0px";
                ifr.style.height = "0px";
                ifr.style.border = "none";
                ifr.src = pdfURL;// testlink;
                ifr.onload = function () {
                    ifr.contentWindow.focus();
                    ifr.contentWindow.print();
                    //setTimeout(() => document.body.removeChild(ifr), 1000);
                }
                document.body.appendChild(ifr);
                //URL.revokeObjectURL(pdfURL);

            }).catch(err => { console.log("Failed to load PDF:", err); console.error("Failed to load PDF:", err) });

        //OLD
        //let ifr = document.createElement("iframe");
        //ifr.style.position = 'absolute';
        //ifr.style.width = "0px";
        //ifr.style.height = "0px";
        //ifr.style.border = "none";
        //ifr.src = testlink;// testlink;
        //ifr.onload = function () {
        //    ifr.contentWindow.focus();
        //    ifr.contentWindow.print();
        //    //setTimeout(() => document.body.removeChild(ifr), 1000);
        //}
        //document.body.appendChild(ifr);
    }
    //async function printEmbedDocument(testlink) {
    //    testlink = "https://localhost:44396/pdf/INV_2425_200_202511101208256146.pdf"; // API
    //    //testlink = "https://localhost:44326/pdf/INV_2425_200_202511101208256146.pdf" // UI
    //    const response = await fetch(testlink, { credentials: 'include' });
    //    const blob = await response.blob();
    //    const blobUrl = URL.createObjectURL(blob);

    //    const iframe = document.createElement('iframe');
    //    iframe.style.display = 'none';
    //    iframe.src = blobUrl;

    //    iframe.onload = () => iframe.contentWindow.print();

    //    document.body.appendChild(iframe);
    //}
    function previewiframe(link) {
        console.log(link);
        const options = "#toolbar=0&navpanes=0&scrollbar=0&zoom=80";
        document.getElementById("iframepreview").src = link + options;
        modaliframePreview.style.display = "block";
    }
    $('#tblMasterData tbody').on('click', '.clsCancel', function (e) {
        $("#txtNarration,#txtRemarks").prop("disabled", false);
    });
    //$("#btnCommonDocFilter").click(function () {
    //    modalFilterModal.style.display = "block";
    //});
    setDate("dtpCommonDocFilterFrom", 2);
    setDate("dtpCommonDocFilterTo", 0);
    $("#btnCommonDocumentFilter").click(function () {
        $("#DocumetFiltersGrid").html("");
        var IsValid = true;
        $(".clrdivs").html("");

        if ($("#dtpCommonDocFilterFrom").val() == "") {
            IsValid = false;
            $("#divErrCommonDocFilterFrom").html("From date should not be empty");
        }
        if ($("#dtpCommonDocFilterTo").val() == "") {
            IsValid = false;
            $("#divErrCommonDocFilterFTo").html("To date should not be empty");
        }
        if ($("#dtpCommonDocFilterFrom").val() > $("#dtpCommonDocFilterTo").val()) {
            IsValid = false;
            $("#divErrCommonDocFilterFrom").html("From date should be lessthan To Date");
        }
        if (IsValid) {
            //var FilterData = [];
            var FilterData = {
                "TransID": $("#txtcommonfilterapplytransid").val(),
                "FromDate": $("#dtpCommonDocFilterFrom").val(),
                "ToDate": $("#dtpCommonDocFilterTo").val(),
                "DocRange": $("#txtCommonDocFilterRange").val(),
                "Party": $("#txtCommonDocFilterPartyName").val(),
                "FilterType": $("#dtpCommonDocFilterType").val(),
                //dtpCommonDocFilterType
            }
            //FilterData.push(lst)
            $.ajax({
                url: Aurl + "commonfilter/commonfilterdata",
                type: 'POST',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(FilterData),
                cache: false,
                processData: false,
                xhrFields: {
                    withCredentials: true
                },
                success: function (data) {
                    if (eval(data).length > 0) {
                        CustomFilterbindDataTable(eval(data))
                    } else {
                        showErrorSnackbar("No records found")
                    }
                }
            });
        }
    });
    var customfiltercolumnsettings = [];
    var commonfiltergrid;
    ColumnDetails(2, 1003, 1);

    ej.grids.Grid.Inject(ej.grids.Page, ej.grids.ExcelExport, ej.grids.Toolbar, ej.grids.Aggregate, ej.grids.Group, ej.grids.Sort, ej.grids.Filter, ej.grids.ColumnMenu, ej.grids.ColumnChooser);
    function CustomFilterbindDataTable(data) {
        if (data.length === 0) {
            return; // No data to display
        }

        //customfiltercolumnsettings = [
        //    { field: 'DocValue', visible: false, showInColumnChooser: false },
        //    { field: 'Chk', headerText: '#', width: "20", textAlign: 'left', type: "checkbox", showInColumnChooser: false },
        //    { field: 'DocId', headerText: 'Doc ID', width: "20", textAlign: 'left'},
        //    { field: 'DocDate', headerText: 'Doc Date', width: "20", textAlign: 'left' },
        //    { field: 'RefNo', headerText: 'Ref No', width: "20", textAlign: 'left' },
        //    { field: 'Name', headerText: 'Party Name', width: "50", textAlign: 'left' },
        //    { field: 'NetAmt', headerText: 'Net Amt', width: "20", textAlign: 'left', format: "N2" },
        //    { field: 'ItemsCount', headerText: 'Items Count', width: "20", textAlign: 'left',format:"N0" },
        //    ];
        commonfiltergrid = new ej.grids.Grid({
            dataSource: data,
            allowPaging: false,
            //pageSettings: { pageSize: 25 },
            allowSorting: true,
            allowFiltering: true,
            allowResizing: true,
            filterSettings: { type: 'Excel' },
            toolbar: ['Search'],//, { tooltipText: 'Customize Columns', id: 'CommonFiltercustomizeBtn', prefixIcon: 'e-icons e-settings' }
            allowExcelExport: true,
            height: 250,
            enableColumnVirtualization: true,
            allowReordering: true,
            showColumnChooser: true, // ✅ Must be true
            showColumnMenu: true,
            rowSelected: onRowSelected,
            columns: customfiltercolumnsettings,
            toolbarClick: function (args) {
                if (args.item.id === 'CommonFiltercustomizeBtn') {
                    SelectTableID = 1;
                    modalReportColumnsetting.style.display = "block";
                    ColumnSettings(1, 1003, SelectTableID);
                }
            },
            resizeStop: function (args) {
                const field = args.column.field;
                const fieldIndex = args.column.index;
                const newWidth = args.column.width;
                //showErrorSnackbar("Column resized: " + field + " → New width: " + newWidth);
                // You can store or use the new width as needed
            },
            columnVisibilityChanged: function (args) {
                console.log("Column visibility changed:");
                console.log("Field:", args.column.field);
                console.log("Now Visible:", args.visible);
            },
        });

        commonfiltergrid.appendTo('#DocumetFiltersGrid');

        function onRowSelected(args) {
            var rowData = args.data;
            //showErrorSnackbar("Doc ID " + rowData["Doc ID"])//.
            //console.log("Selected Row Data:", rowData);
            //$("#DocumentGrid").html("");
            //$("#ProductInfo").show();
            //GetProductDocuments(rowData["ID"]);
            //$("#lblProductName").text(rowData["Name"]);
        }
        function getCheckedRows() {
            // Get grid instance
            var gridObj = document.getElementById('DocumetFiltersGrid').ej2_instances[0];
            console.log("gridObj:", gridObj);
            // Filter rows where checkbox is true
            var checkedRows = gridObj.getCurrentViewRecords().filter(function (row) {
                return row.Chk === true;
            });

            console.log("Checked Rows:", checkedRows);
            return checkedRows;
        }

    }
    $("#btnAcceptDocFilterModal").click(function () {
        if (commonfiltergrid) {
            var selectedRows = commonfiltergrid.getSelectedRecords();
            if (selectedRows.length > 0) {
                var commfieldid = $("#txtcommonfilterapplyfieldid").val();
                //console.log(selectedRows);
                var selectedDocs = "";
                for (var i = 0; i < selectedRows.length; i++) {
                    selectedDocs += selectedRows[i].DocValue + (((selectedRows.length - 1) == i) ? "" : ",");
                }
                $("#" + commfieldid).val(selectedDocs);
                modalFilterModal.style.display = "none";
                $("#txtcommonfilterapplyfieldid,#txtcommonfilterapplytransid").val("");
            } else {
                showErrorSnackbar("Select atleast one document");
            }
        } else {
            showErrorSnackbar("No Documents Found");
        }
    });

    function ColumnDetails(nMode, nReportID, nTableID) {
        customfiltercolumnsettings = [];
        $.ajax({
            url: Aurl + "reportcolumnsettings/getRepColumnSettings",
            type: 'get',
            contentType: 'json',
            data: { Mode: nMode, ReportID: nReportID, TableID: nTableID },
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                var jsData = eval(data);
                console.log(jsData);
                if (nTableID == 1) {
                    var chkfield = { field: 'Chk', headerText: '#', width: "5", textAlign: 'left', type: "checkbox", showInColumnChooser: false };
                    //jsData.push(chkfield);
                    //customfiltercolumnsettings = jsData;//.push(jsData);
                    var tempcols = []
                    tempcols.push(chkfield);
                    $.each(jsData, function (i, items) {
                        tempcols.push(items);
                    });
                    customfiltercolumnsettings = tempcols;
                }
            }
        });
    }
    $(document).on("click", ".action-btn", function (e) {
        e.stopPropagation();

        let table = $('#tblMasterData').DataTable();
        let row = table.row($(this).closest('tr')).data();

        // Build action list
        let actions = getActionsByRole(userRole, row);
        let menuHtml = actions.map(a => `<li><a class="${a.cls}">${a.label}</a></li>`).join("");

        $("#actionPopup ul").html(menuHtml);

        let popup = $("#actionPopup");
        popup.removeClass("show");

        let offset = $(this).offset();
        let popupH = popup.outerHeight();
        let popupW = popup.outerWidth();
        let winH = $(window).height();
        let scrollTop = $(window).scrollTop();

        // Default DOWN position
        let top = offset.top + 20;

        // Flip UP if overflow
        if (top + popupH > winH + scrollTop)
            top = (offset.top - popupH - 15) + 20;

        let left = ((offset.left - popupW) - 30) + 20;

        // Apply position BEFORE animation
        popup.css({ top: top, left: left }).show();

        // Trigger animation
        setTimeout(() => popup.addClass("show"), 10);
    });
    $(document).on("click", function () {
        let popup = $("#actionPopup");
        popup.removeClass("show");
        setTimeout(() => popup.hide(), 150);
    });
    $(".close-popup").on("click", function () {
        $("#actionPopup").removeClass("show");
        setTimeout(() => $("#actionPopup").hide(), 150);
    });
    let popup = document.getElementById("actionPopup");
    let header = popup.querySelector(".popup-header");
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    header.onmousedown = dragMouseDown;
    function dragMouseDown(e) {
        e.preventDefault();
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
    }
    function elementDrag(e) {
        e.preventDefault();
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;

        popup.style.top = (popup.offsetTop - pos2) + "px";
        popup.style.left = (popup.offsetLeft - pos1) + "px";
    }
    function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
    }
    $(document).on("click", ".action-btn", function (e) {
        e.stopPropagation();

        let table = $('#tblMasterData').DataTable();
        let row = table.row($(this).closest('tr')).data();

        // SAVE ROW DATA FOR LATER
        window.__SelectedRowData = row;

        // Build popup items…
        let actions = getActionsByRole(userRole, row);
        let menuHtml = actions.map(a => `<li><a class="${a.cls}">${a.label}</a></li>`).join("");

        $("#actionPopup ul").html(menuHtml);

        //showPopupAtButton(this); // (your existing position code)
    });

</script>