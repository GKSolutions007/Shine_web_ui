@model ShineWeb.Models.Homescreen
@{
    ViewBag.Title = "Home Page";
}
<link href="~/Content/bootstrap.min.css" rel="stylesheet" />
<link href="~/Content/navbar.css" rel="stylesheet" />
<link href="~/Content/buttonTop.css" rel="stylesheet" />
<link href="~/Content/jquery-ui.css" rel="stylesheet" />
<link href="~/Content/dataTables.dataTables.2.2.2.css" rel="stylesheet" />
<script src="~/Scripts/bootstrap.min.js"></script>
<script src="~/Scripts/jquery-1.10.2.min.js"></script>
<script src="~/Scripts/jquery-3.7.1.js"></script>
<script src="~/Scripts/bootstrap-typeahead.min.js"></script>
<script src="~/Scripts/jquery-ui.js"></script>
<script src="~/Scripts/dataTables.2.2.2.js"></script>
<script src="~/Scripts/js/refreshtoken.js"></script>
@*<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
*@
<script src="~/Scripts/npm_charts.js"></script>
<script src="~/Scripts/npm_chart_datalabels.js"></script>
<style>
    :root {
        --primary-color: #4a90e2;
        --secondary-color: #6c757d;
        --bg-color: #f0f2f5;
        --card-bg: #ffffff;
        --text-color: #333333;
        --border-color: #e0e6ed;
        --input-border: #ced4da;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    td {
        font-weight: 600;
    }

    .total-row {
        font-weight: 700 !important;
        background-color: #f0f7ff !important;
        color: var(--primary-color) !important;
    }
    body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    .modern-card {
        background: var(--card-bg);
        border-radius: 8px;
        box-shadow: var(--shadow);
        padding: 12px;
        margin-bottom: 12px;
        border: 1px solid var(--border-color);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

        .modern-card:hover {
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.08);
        }

    .card-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .modern-card .table td, .modern-card .table th {
        font-size: 11px;
        padding: 6px 8px;
    }

    /* Sidebar Widgets */
    .sidebar-widget {
        margin-bottom: 5px;
    }

    .widget-header {
        background: var(--primary-color);
        color: white;
        padding: 8px 12px;
        border-radius: 8px 8px 0 0;
        font-weight: 600;
        font-size: 13px;
    }

    .widget-body {
        background: white;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 8px 8px;
    }

    .widget-body label {
        font-size: 11px;
        margin-bottom: 3px;
    }

    .sidebar-widget .form-control {
        height: 28px;
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: 600;
    }

    .sidebar-widget .btn-sm {
        height: 28px;
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 4px;
        font-weight: 600;
    }

    .sidebar-widget .form-group {
        margin-bottom: 10px;
    }

    /* Balance Summary */
    .summary-tile {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        min-width: 120px;
    }

    .bg-cash {
        background-color: #e3fcef;
        border-left: 4px solid #36b37e;
    }

    .bg-bank {
        background-color: #deebff;
        border-left: 4px solid #0052cc;
    }

    .summary-label {
        font-size: 11px;
        color: var(--secondary-color);
        margin-bottom: 2px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .summary-value {
        font-size: 16px;
        font-weight: 700;
        color: #172b4d;
    }

    /* Forms */
    .form-control {
        border-radius: 6px;
        border: 1px solid var(--input-border);
        box-shadow: none;
        height: 38px;
        font-weight: 600;
    }

    .btn {
        border-radius: 6px;
        font-weight: 600;
        padding: 8px 16px;
        transition: all 0.2s;
    }

    /* Tables */
    .table {
        width: 100%;
        margin-bottom: 0;
    }

        .table thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid var(--border-color);
            font-size: 12px;
            color: #5e6c84;
        }

    /* Modal */
    .modalBatch1 {
        display: none;
        position: fixed;
        z-index: 1050;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        backdrop-filter: blur(4px);
    }

    .modalBatch-content1 {
        background-color: #ffffff;
        margin: 5% auto;
        border-radius: 12px;
        width: 90%;
        max-width: 1000px;
        max-height: 85vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }
</style>
<body>
    <div class="toastBox"></div>
    @Html.HiddenFor(model => model.CollectionDetailEnable, new { @autocomplete = "off", @class = "form-control", @id = "txtCollectionDetailEnable" })
    @Html.HiddenFor(model => model.ChequeDetailEnable, new { @autocomplete = "off", @class = "form-control", @id = "txtChequeDetailEnable" })
    @Html.HiddenFor(model => model.TransVariantEnable, new { @autocomplete = "off", @class = "form-control", @id = "txtTransVariantEnable" })

    <div class="container-fluid" style="padding: 10px;">
        <div class="row">
            <!-- Sidebar / Side Widgets -->
            <div class="col-md-3">
                <!-- Balance Tiles -->
                <div class="col-md-12" style="margin-bottom: 24px;">
                    <div style="display: flex; gap: 20px;">
                        <div class="summary-tile bg-cash">
                            <div class="summary-label">Cash Balance</div>
                            <div class="summary-value" id="dvCash">₹ 0.00</div>
                        </div>
                        <div class="summary-tile bg-bank">
                            <div class="summary-label">Bank Balance</div>
                            <div class="summary-value" id="dvBank">₹ 0.00</div>
                        </div>
                    </div>
                </div>
                <!-- Quick Access -->
                <div class="sidebar-widget">
                    <div class="widget-header">
                        <span class="glyphicon glyphicon-flash"></span> Quick Access
                    </div>
                    <div class="widget-body">
                        <div class="form-group">
                            <label>Transaction:</label>
                            <select class="form-control" id="cmbQAtransaction"></select>
                            <div style="color: red; font-size: 11px;" id="divErrTransName"></div>
                        </div>
                        <div class="form-group">
                            <label>Doc ID:</label>
                            <input type="text" class="form-control" id="txtQAdocid" placeholder="Enter Doc ID">
                            <div style="color: red; font-size: 11px;" id="divErrDocID"></div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" id="btnQAClear" class="btn btn-danger btn-sm btn-block">Reset</button>
                            <button type="button" id="btnQASubmit" class="btn btn-success btn-sm btn-block">Submit</button>
                        </div>
                    </div>
                </div>

                <!-- Transaction Variant -->
                <div class="sidebar-widget Transvariant-container">
                    <div class="widget-header">
                        <span class="glyphicon glyphicon-list-alt"></span> Transaction Variant
                    </div>
                    <div class="widget-body">
                        <div class="form-group">
                            <label>Transaction:</label>
                            <select class="form-control" id="cmbVariantTransaction">
                                <option value="0">Select</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Doc ID:</label>
                            <input type="text" class="form-control" id="txtVariantDocID" placeholder="Select Doc ID">
                        </div>
                        <div class="form-group">
                            <label>Party Name:</label>
                            <input type="text" class="form-control" id="txtVariantPartyName" placeholder="Select Party">
                            <input hidden id="txtPartyID" />
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" id="btnVariantClear" class="btn btn-danger btn-sm btn-block">Reset</button>
                            <button type="button" id="btnVariantSubmit" class="btn btn-success btn-sm btn-block" style="background: #6c757d; border-color: #6c757d; color:white;">Submit</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Dashboard Area -->
            <div class="col-md-9">
                <div class="row">                    
                    <!-- Pending Drafts Card -->
                    <div class="col-md-5">
                        
                        <!--Pending Drafts -->
                        <div class="modern-card">
                            <div class="card-title">
                                <span class="glyphicon glyphicon-time"></span> Pending Drafts
                            </div>
                            <table class="table table-hover" id="tblDraftCount">
                                <thead>
                                    <tr>
                                        <th style="display:none;">TransID</th>
                                        <th style="display:none;">TransName</th>
                                        <th>Transaction</th>
                                        <th style="text-align:center;">Count</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                        <!-- Cheque Details -->
                        <div class="modern-card" id="dvChequeDetail">
                            <div class="card-title">
                                <span class="glyphicon glyphicon-briefcase"></span> Cheque In Hand
                            </div>
                            <table class="table" id="tblChequeDetail">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th style="text-align:center;">Count</th>
                                        <th style="text-align:right;">Amount ₹</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>

                    <!-- Details Tables Column -->
                    <div class="col-md-7">
                        <!-- Collection Details -->
                        <div class="modern-card" id="dvCollectionDetail">
                            <div class="card-title" style="justify-content: space-between;">
                                <span><span class="glyphicon glyphicon-stats"></span> Collections</span>
                                <select id="cmbTimeFilter" class="form-control input-sm" style="width: 100px; display: inline-block;">
                                    <option value="1">Today</option>
                                    <option value="2">Week</option>
                                    <option value="3">Month</option>
                                    <option value="4">Quarter</option>
                                    <option value="5">All</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-start; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 250px;">
                                    <table class="table" id="tblCollectionDetail">
                                        <thead>
                                            <tr>
                                                <th>Payment Mode</th>
                                                <th style="text-align:right;">Amount ₹</th>
                                            </tr>
                                        </thead>
                                    </table>
                                </div>
                                <div style="flex: 1; min-width: 200px; max-height: 200px; display: flex; justify-content: center;">
                                    <canvas id="collectionChart"></canvas>
                                </div>
                            </div>
                        </div>


                        <!-- Transaction Details -->
                        <div class="modern-card" id="dvCollectionDetail">
                            <div class="card-title" style="justify-content: space-between;">
                                <span><span class="glyphicon glyphicon-stats"></span> Transaction</span>
                                <select id="cmbTransactionTimeFilter" class="form-control input-sm" style="width: 100px; display: inline-block;">
                                    <option value="1">Today</option>
                                    <option value="2">Week</option>
                                    <option value="3">Month</option>
                                    <option value="4">Quarter</option>
                                    <option value="5">All</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-start; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 250px;">
                                    <table class="table" id="tblTransactionDetail">
                                        <thead>
                                            <tr>
                                                <th>Transaction</th>
                                                <th style="text-align:right;">Amount ₹</th>
                                            </tr>
                                        </thead>
                                    </table>
                                </div>
                                <div style="flex: 1; min-width: 200px; max-height: 200px; display: flex; justify-content: center;">
                                    <canvas id="TransactionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Draft Data -->
    <div class="modalBatch1" id="myModalfg1">
        <div class="modalBatch-content1">
            <div class="modal-header" style="background: var(--primary-color); color: white; padding: 15px 20px;">
                <button type="button" class="close closefg1" style="color: white; opacity: 1;">&times;</button>
                <h4 class="modal-title" id="lblPopupheading" style="margin: 0; font-weight: 600;">Draft Details</h4>
            </div>
            <div class="modal-body" style="padding: 20px; overflow-y: auto; flex-grow: 1;">
                <input hidden id="txtTransID" />
                <input hidden id="txtTransName" />
                <table class="table table-bordered table-striped" id="tblDraftData" width="100%">
                    <thead>
                        <tr>
                            <th style="display:none;">TransID</th>
                            <th style="display:none;">ID</th>
                            <th style="display:none;">Mode</th>
                            <th style="display:none;">EncPrefix</th>
                            <th>Doc ID</th>
                            <th>Date</th>
                            <th>Ref No</th>
                            <th>Branch</th>
                            <th style="display:none;">Beat</th>
                            <th style="display:none;">Salesman</th>
                            <th>Party Name</th>
                            <th style="text-align:right;">Gross</th>
                            <th style="text-align:right;">Tax</th>
                            <th style="text-align:right;">Net ₹</th>
                        </tr>
                    </thead>
                </table>
            </div>
            <div class="modal-footer" style="padding: 15px 20px; border-top: 1px solid var(--border-color);">
                <button type="button" class="btn btn-default" id="btnClose">Close</button>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript">
    var RID = '@Session["RoleID"]';
    var Aurl = '@Session["APIurl"]';
    var TblDraftCount = $('#tblDraftCount').DataTable({
        "bFilter": false,
        "bSearchable": false,
        "bInfo": false,
        "bPaginate": false,
        "ordering": false,
        scrollY: "400px",
        scrollX: true,
        scrollCollapse: true,
        "columnDefs": [{ "targets": [0, 1], "visible": false, searchable: false }, { "targets": [3], "class": "dt-body-center" }],
    });
    var TblDraftData = $('#tblDraftData').DataTable({
        "bFilter": true,
        "bSearchable": true,
        "bInfo": true,
        "bPaginate": true,
        "ordering": false,
        scrollY: "300px",
        scrollX: true,
        scrollCollapse: true,
        "columnDefs": [{ "targets": [0, 1, 2,3,4,7,8,9], "visible": false, searchable: false }],
    });
    var tblCollectionDetail = $('#tblCollectionDetail').DataTable({
        "bFilter": false,
        "bSearchable": false,
        "bInfo": false,
        "bPaginate": false,
        "ordering": false,
        scrollY: "400px",
        scrollX: true,
        scrollCollapse: true,
    });
    var tblTransactionDetail = $('#tblTransactionDetail').DataTable({
        "bFilter": false,
        "bSearchable": false,
        "bInfo": false,
        "bPaginate": false,
        "ordering": false,
        scrollY: "400px",
        scrollX: true,
        scrollCollapse: true,
    });
    
    var tblChequeDetail = $('#tblChequeDetail').DataTable({
        "bFilter": false,
        "bSearchable": false,
        "bInfo": false,
        "bPaginate": false,
        "ordering": false,
        scrollY: "400px",
        scrollCollapse: true,
});
    var collectionChart = null;

    function updateCollectionChart(data) {
        var labels = data.map(function(item) { return item.PaymentMode; });
        var values = data.map(function(item) { return parseFloat(item.ColAmt.replace(/,/g, '')); });

        var ctx = document.getElementById('collectionChart').getContext('2d');

        if (collectionChart) {
            collectionChart.destroy();
        }

        collectionChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        '#4a90e2', '#36b37e', '#ffab00', '#ff5630', '#00b8d9', '#6554c0'
                    ],
                    borderWidth: 1,
                    borderColor: '#ffffff',
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                hover: {
                    mode: 'nearest',
                    intersect: true,
                    animationDuration: 400
                },        
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: { size: 11 }
                        }
                    },
                    datalabels: {
                        color: '#fff',
                        font: {
                            weight: 'bold',
                            size: 11
                        },
                        formatter: function(value, ctx) {
                            var sum = 0;
                            var dataArr = ctx.chart.data.datasets[0].data;
                            dataArr.map(function(data) {
                                sum += data;
                            });
                            var percentage = (value * 100 / sum).toFixed(1) + "%";
                            return percentage;
                        },
                        display: function(context) {
                            return context.dataset.data[context.dataIndex] > 0;
                        }
                    }
                },
                cutout: '60%'
            },
            plugins: [ChartDataLabels]
        });
    }

    var TransactionsChart = null;

    function updateTransactionsChart(data) {
        var labels = data.map(function (item) { return item.Transaction; });
        var values = data.map(function (item) { return parseFloat(item.Values.replace(/,/g, '')); });

        var ctx = document.getElementById('TransactionChart').getContext('2d');

        if (TransactionsChart) {
            TransactionsChart.destroy();
        }

        TransactionsChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        '#4a90e2', '#36b37e', '#ffab00', '#ff5630', '#00b8d9', '#6554c0'
                    ],
                    borderWidth: 1,
                    borderColor: '#ffffff',
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                hover: {
                    mode: 'nearest',
                    intersect: true,
                    animationDuration: 400
                },
                plugins: {
                    legend: {
                        position: 'bottom',                        
                        labels: {                            
                            usePointStyle: true,
                            padding: 15,
                            font: { size: 11 }
                        }
                    },
                    datalabels: {
                        color: '#fff',
                        font: {
                            weight: 'bold',
                            size: 11
                        },
                        formatter: function (value, ctx) {
                            var sum = 0;
                            var dataArr = ctx.chart.data.datasets[0].data;
                            dataArr.map(function (data) {
                                sum += data;
                            });
                            var percentage = (value * 100 / sum).toFixed(1) + "%";
                            return percentage;
                        },
                        display: function (context) {
                            return context.dataset.data[context.dataIndex] > 0;
                        }
                    }
                },
                cutout: '60%'
            },
            plugins: [ChartDataLabels]
        });
    }

    function displayResult(item) {
        $('.alert').show().html('You selected <strong>' + item.value + '</strong>: <strong>' + item.text + '</strong>');
    }
    var modal = document.getElementById("myModalfg1");
    var span = document.getElementsByClassName("closefg1")[0];
    span.onclick = function () {
        modal.style.display = "none";
    }
    $('#btnClose').click(function (e) {
        modal.style.display = "none";
    });
    if ($("#txtCollectionDetailEnable").val() == 0) {
        $("#dvCollectionDetail").hide();
    }
    if ($("#txtChequeDetailEnable").val() == 0) {
        $("#dvChequeDetail").hide();
    }
    if ($("#txtTransVariantEnable").val() == 0) {
        $(".Transvariant-container").hide();
    }
    GetData(1, 0);
    GetData(5, 0);
    GetData(6, RID);
    var arrTrans = [];
    function GetData(nMode, ID) {
        $.ajax({
            url: Aurl + "homescreendraft/get",
            type: 'get',
            contentType: 'json',
            data: { Mode: nMode, Trans: ID },
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                if (nMode == 1) {
                    if (data.length > 0) {
                        TblDraftCount.draw().clear(); TblDraftCount.draw().clear();
                        $.each(data, function (i, items) {
                            TblDraftCount.row.add([
                                items.ID,
                                items.Mode,
                                items.Name,
                                items.Value
                            ]).draw(false);
                        });
                    }
                }
                else if (nMode == 2) {
                    TblDraftData.draw().clear(); TblDraftData.draw().clear();
                    if (data.length > 0) {
                        $.each(data, function (i, items) {
                            TblDraftData.row.add([
                                items.TransID,
                                items.ID,
                                items.TransMode,
                                items.EncDocPrefix,
                                items.DocID,
                                items.Date,
                                items.RefNo,
                                items.BranchID,
                                items.IsDraft,
                                items.DraftID,
                                items.VendorName,
                                items.GrossAmt,
                                items.TaxAmt,
                                items.NetAmt,
                            ]).draw(false);
                        });
                        //TblDraftData.column(5).visible(false);
                        //TblDraftData.column(6).visible(false);
                    }
                }
                if (nMode == 5) {
                    $("#dvCash").html("₹ 0.00");
                    $("#dvBank").html("₹ 0.00");
                    var pmdata = eval(data);
                    if (pmdata.length > 0) {
                        $("#dvCash").html("₹ " + pmdata[0].Balance);
                        $("#dvBank").html("₹ " + pmdata[1].Balance);
                    }
                }
                if (nMode == 6) {
                    arrTrans = [];
                    $('#cmbQAtransaction').find("option").remove();
                    $('#cmbQAtransaction').append($('<option/>', {
                        value: 0,
                        text: "-- Select --",
                    }));
                    var transdata = eval(data);
                    if (transdata.length > 0) {
                        $.each(transdata, function (i, items) {
                            $('#cmbQAtransaction').append($('<option/>', {
                                value: items.TransID,
                                text: items.TransName,
                                name: items.DocPrefix
                            }));
                            arrTrans.push(items);
                        });
                    } else {
                        //showErrorSnackbar("You dont have any Transaction permissions");
                    }
                }
            }
        });
    }
    $('#cmbQAtransaction').change(function (e) {
        var selval = e.target.value;
        if (selval > 0) {
            var ftrans = arrTrans.filter(tr => tr.TransID == selval)
            if (ftrans.length > 0) {
                $("#txtQAdocid").val(ftrans[0].DocPrefix);
            }
        } else {
            $("#txtQAdocid").val("");
        }
    });
    $("#txtQAdocid1").change(function (e) {
    //$("#txtQAdocid").keydown(function (e) {
        //if (e.key === "Enter") {
            $("#divErrDocID").html("");
            var val = e.target.value;
            if (val.includes("/")) {
                //var ftrans = arrTrans.filter(tr => tr.DocPrefix.includes(val))
                //console.log(ftrans);
                let filtered = arrTrans.filter(item =>
                    item.DocPrefix.toLowerCase().includes(val.toLowerCase())
                );
                if (filtered.length > 0) {
                    $("#txtQAdocid").val(filtered[0].DocPrefix);
                    $('#cmbQAtransaction').val(filtered[0].TransID);
                } else {
                    //no trans found
                    $("#divErrDocID").html("No Transaction found");
                    $('#cmbQAtransaction').val(0);
                }
            } else {

            }
        //}
    });
    $("#btnQAClear").click(function () {
        $("#divErrDocID").html("");
        $("#txtQAdocid").val("");
        $('#cmbQAtransaction').val(0);
    });
    $("#btnQASubmit").click(function () {
        $("#divErrDocID,#divErrTransName").html("");
        if ($('#cmbQAtransaction').val() == 0) {
            $("#divErrTransName").html("Select Transaction");
        }
        else if ($('#txtQAdocid').val() == "") {
            $("#divErrTransName").html("Doc ID should not be empty");
        }
        else {
            var dTransID = $('#cmbQAtransaction').val();
            var DocID = $('#txtQAdocid').val();
            QuickAccessDocument(dTransID, DocID);
        }
    });
    function QuickAccessDocument(dTransID, DocID) {
        $.ajax({
            url: Aurl + "quicaccessdocument/validate",
            type: 'get',
            contentType: 'json',
            data: { TransID: dTransID, strDocID: DocID },
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                $.each(data, function (i, items) {
                    if (items.MsgID == "0") {
                        if (dTransID == 1) {
                            window.open(
                                'PurchaseBill?name=Vd%2B%2BrU8QQpt1lN1iIJW1a%2FK0VGZeYK0pqK2Sc7MnuHQ%3D&strFormID=jJOtHsRVwYECOhoiBc69dA%3D%3D&TypeID=BOII5FUynjpl5RZJJ8nW1g%3d%3d&TranID=' + items.ID,
                                '_blank'
                            );
                        }
                        if (dTransID == 2) {
                            window.open(
                                'AutomaticIndent?name=w2ZCPJkGFF0AoGvRO1%2BMNrYg%2FTlGSP7RFKOTKnKk7TZy%2BjK6iu0iUfEo8qMSw%2BYi&strFormID=jJOtHsRVwYECOhoiBc69dA%3D%3D&TypeID=BOII5FUynjpl5RZJJ8nW1g%3d%3d&TranID=' + items.ID,
                                '_blank'
                            );
                        }
                        if (dTransID == 3) {
                            window.open(
                                'PurchaseOrder?name=Vd%2B%2BrU8QQpt1lN1iIJW1a5vMQ8aDbizObKKScceojgs%3D&strFormID=jJOtHsRVwYECOhoiBc69dA%3D%3D&TypeID=BOII5FUynjpl5RZJJ8nW1g%3d%3d&TranID=' + items.ID,
                                '_blank'
                            );
                        }


                        if (dTransID == 12) {
                            window.open(
                                'PurchaseReturn?name=Vd%2B%2BrU8QQpt1lN1iIJW1a4zfOkO06OcdMkE6UiXKDWE%3D&strFormID=jJOtHsRVwYECOhoiBc69dA%3D%3D&TypeID=BOII5FUynjpl5RZJJ8nW1g%3d%3d&TranID=' + items.ID,
                                '_blank'
                            );
                        }
                        if (dTransID == 13) {
                            window.open(
                                'InventoryAdjustment?name=i3DMZtc%2FTn0UH9DhV75tUuopguddgZuQmQzrgq7DF2pb%2BgzoOuIpBbtZod7IAoud&strFormID=jJOtHsRVwYECOhoiBc69dA%3D%3D&TypeID=BOII5FUynjpl5RZJJ8nW1g%3d%3d&TranID=' + items.ID,
                                '_blank'
                            );
                        }
                        if (dTransID == 14) {
                            window.open(
                                'Quotation?name=BTQgLv%2BebY48FN9pEezgnyVrVumuVVzPVnoCFOjqIsU%3D&strFormID=jJOtHsRVwYECOhoiBc69dA%3D%3D&TypeID=BOII5FUynjpl5RZJJ8nW1g%3d%3d&TranID=' + items.ID,
                                '_blank'
                            );
                        }
                        if (dTransID == 15) {
                            window.open(
                                'Invoice?name=KUGYxS%2BKhoQB3%2FYrx1I0cQ%3D%3D&strFormID=jJOtHsRVwYECOhoiBc69dA%3D%3D&TypeID=BOII5FUynjpl5RZJJ8nW1g%3d%3d&TranID=' + items.ID,
                                '_blank'
                            );
                        }
                        if (dTransID == 16) {
                            window.open(
                                'SalesReturn?name=6%2B9sxOBkg1PjlBjpubNIcRsbDdS%2F%2BKzbighA08XDWD0%3D&strFormID=EvsdnH%2BUlJpTVhFYh%2Bi13g%3D%3D&TypeID=BOII5FUynjpl5RZJJ8nW1g%3d%3d&TranID=' + items.ID,
                                '_blank'
                            );
                        }
                        //if (dTransID == 17) {
                        //    window.open(
                        //        'SalesReturn?name=cPfu941CFnux5sU80vV6w6mcrcNWP7Vs7hhrLOCLYgo%3D&strFormID=WHYf4alVgNJY%2FX917pnZ3w%3D%3D&TypeID=BOII5FUynjpl5RZJJ8nW1g%3d%3d&TranID=' + items.ID,
                        //        '_blank'
                        //    );
                        //}
                        if (dTransID == 19) {
                            window.open(
                                'CollectionPayment?name=V5BIclDO7YSWXMUYe9qSUbB92jlocOM14lUepH77xc4%3D&strFormID=NyU15GCpL%2FZR9n8fK57WAg%3D%3D&TypeID=BOII5FUynjpl5RZJJ8nW1g%3d%3d&TranID=' + items.ID,
                                '_blank'
                            );
                        }
                        if (dTransID == 18) {
                            window.open(
                                'CollectionPayment?name=w3tjkQAA1vr%2BSnaRJEKUVw%3D%3D&strFormID=IXL1NOfIxouMMmMKvHxKbA%3D%3D&TypeID=BOII5FUynjpl5RZJJ8nW1g%3d%3d&TranID=' + items.ID,
                                '_blank'
                            );
                        }


                    } else {
                        showErrorSnackbar("Doc ID not matched. Enter correct Doc ID");
                    }
                });
            }
        });
    }
    getCollectionData(1);
    getTransactionData(1);
    function getCollectionData(FType) {
        $.ajax({
            url: Aurl + "homescreendraft/get",
            type: 'get',
            contentType: 'json',
            data: { Mode: 3, Trans: FType },
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                var colldata = eval(data);
                console.log("Collection : ", colldata);
                var MainData = colldata.filter(col => col.PaymentMode != 'Total');
                $('#tblCollectionDetail').DataTable({
                    scrollY: "250px",
                    scrollX: true,
                    scrollCollapse: true,
                    paging: false,
                    info:false,
                    destroy: true,
                    data: colldata,
                    fixedColumns: false,
                    searching: false,
                    ordering: false,
                    sorting: false,
                    columns: [
                        { "data": "PaymentMode", "autoWidth": true, className: "dt-body-left" },
                        { "data": "ColAmt", "autoWidth": true, className: "dt-body-right" },
                    ],
                    createdRow: function(row, data, dataIndex) {
                        if (data.PaymentMode && data.PaymentMode.toLowerCase().includes("total")) {
                            $(row).addClass('total-row');
                        }
                    }

                });
                tblCollectionDetail = $('#tblCollectionDetail').DataTable();
                $("#cmbTimeFilter").val(FType);
                updateCollectionChart(MainData);
            }
        });
    }
    function getTransactionData(FType) {
        $.ajax({
            url: Aurl + "homescreendraft/get",
            type: 'get',
            contentType: 'json',
            data: { Mode: 7, Trans: FType },
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                var Transdata = eval(data);
                console.log("Transaction : ", Transdata);
                var MainData = Transdata.filter(col => col.PaymentMode != 'Total');
                $('#tblTransactionDetail').DataTable({
                    scrollY: "250px",
                    scrollX: true,
                    scrollCollapse: true,
                    paging: false,
                    info: false,
                    destroy: true,
                    data: Transdata,
                    fixedColumns: false,
                    searching: false,
                    ordering: false,
                    sorting: false,
                    columns: [
                        { "data": "Transaction", "autoWidth": true, className: "dt-body-left" },
                        { "data": "Values", "autoWidth": true, className: "dt-body-right" },
                    ],
                    createdRow: function (row, data, dataIndex) {
                        if (data.PaymentMode && data.PaymentMode.toLowerCase().includes("total")) {
                            $(row).addClass('total-row');
                        }
                    }

                });
                tblTransactionDetail = $('#tblTransactionDetail').DataTable();
                $("#cmbTransactionTimeFilter").val(FType);
                updateTransactionsChart(MainData);
            }
        });
    }
    getChequeData();
    function getChequeData() {
        $.ajax({
            url: Aurl + "homescreendraft/get",
            type: 'get',
            contentType: 'json',
            data: { Mode: 4, Trans: "" },
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
                var chqdata = eval(data);
                $('#tblChequeDetail').DataTable({
                    scrollY: "250px",
                    scrollX: true,
                    scrollCollapse: true,
                    paging: false,
                    info: false,
                    destroy: true,
                    data: chqdata,
                    fixedColumns: false,
                    searching: false,
                    ordering: false,
                    sorting: false,
                    columns: [
                        { "data": "DateType", "autoWidth": true, className: "dt-body-left" },
                        { "data": "Counts", "autoWidth": true, className: "dt-body-center" },
                        { "data": "collAmt", "autoWidth": true, className: "dt-body-right" },
                    ],
                    createdRow: function(row, data, dataIndex) {
                        if (data.DateType && data.DateType.toLowerCase().includes("total")) {
                            $(row).addClass('total-row');
                        }
                    }
                });
                tblChequeDetail = $('#tblChequeDetail').DataTable();
            }
        });
    }
    //$('#cmbTimeFilter').on('change', function (e) {
    $(document).on("change", "#cmbTimeFilter", function (e) {
    //$('#tblCollectionDetail').on('change', '#cmbTimeFilter', function (e) {
        var Selval = e.target.value;
        getCollectionData(Selval);
    })
    $(document).on("change", "#cmbTransactionTimeFilter", function (e) {
        //$('#tblCollectionDetail').on('change', '#cmbTimeFilter', function (e) {
        var Selval = e.target.value;
        getTransactionData(Selval);
    })
    $('#tblDraftCount tbody').on('dblclick', 'td', function () {
        rowdata = TblDraftCount.row($(this).parents('tr')).data();
        var ID = rowdata[0];
        var Name = rowdata[2];
        var Trans = rowdata[1];
        $("#txtTransID").val(ID); $("#txtTransName").val(Trans);
        $("#lblPopupheading").text(Name);
        GetData(2, ID);
        modal.style.display = "block";
    });
    $('#tblDraftData tbody').on('dblclick', 'td', function () {
        rowdata = TblDraftData.row($(this).parents('tr')).data();
        var TransID = rowdata[0];
        var ID = rowdata[1];
        var TransMode = rowdata[2];
        var docprefix = rowdata[3];
        var trn = $("#txtTransName").val();
        //alert("ID : " + ID + ", Trans : " + TransMode + ", Name : " + trn);
        if (TransID == 1) {
            window.open(
                'PurchaseBill?name=' + trn + '&strFormID=' + TransMode + '&TypeID=' + TransMode + '&TranID=' + ID,
                '_blank'
            );
        } else if (TransID == 2) {
            window.open(
                'AutomaticIndent?name=' + trn + '&strFormID=' + TransMode + '&TypeID=' + TransMode + '&TranID=' + ID,
                '_blank'
            );
        } else if (TransID == 3) {
            window.open(
                'PurchaseOrder?name=' + trn + '&strFormID=' + TransMode + '&TypeID=' + TransMode + '&TranID=' + ID,
                '_blank'
            );
        } else if (TransID == 15) {
            window.open(
                'Invoice?name=' + trn + '&strFormID=' + TransMode + '&TypeID=' + TransMode + '&TranID=' + ID,
                '_blank'
            );
        } else if (TransID == 14) {
            window.open(
                'Quotation?name=' + trn + '&strFormID=' + TransMode + '&TypeID=' + TransMode + '&TranID=' + ID,
                '_blank'
            );
        }
        else if (TransID == 16 || TransID == 17) {
            window.open(
                'SalesReturn?name=' + trn + '&strFormID=' + docprefix + '&TypeID=' + TransMode + '&TranID=' + ID,
                '_blank'
            );
        }
    });
    var arrVarTrans = [], arrPartyData = [], nVariantTransID = 0;
    GetVariantData(1);
    function GetVariantData(nMode, nID = 0) {
        $.ajax({
            url: Aurl + "transactionvariant/gettrans",
            type: 'get',
            contentType: 'json',
            data: { Mode: nMode, PartyType: nID },
            xhrFields: {
                withCredentials: true
            },
            async: false,
            success: function (data) {
                if (data.length > 0) {
                    if (nMode == 1) {
                        arrVarTrans = [];
                        $('#cmbVariantTransaction').find("option").remove();
                        $('#cmbVariantTransaction').append($('<option/>', {
                            value: 0,
                            text: "-- Select --",
                        }));
                        $.each(eval(data), function (i, items) {
                            var al = {
                                "Transaction": items.Name,
                                "TypeID": items.ID,
                                "DocPrefix": items.DocPrefix,
                                "TransID": items.TransID,
                            }
                            arrVarTrans.push(al);
                            $('#cmbVariantTransaction').append($('<option/>', {
                                value: items.ID,
                                text: items.Name,
                                name: items.DocPrefix
                            }));
                        });
                        console.log(eval(data));
                    }
                    else if (nMode == 2) {
                        arrPartyData = [];
                        $.each(eval(data), function (i, items) {
                            var al = {
                                "label": items.Name,
                                "id": items.ID,
                            }
                            arrPartyData.push(al);
                        });
                        $("#txtVariantPartyName").autocomplete({
                            minLength: 0,
                            source: arrPartyData,
                            //autoFocus: true,
                            //focus: function (event, ui) {
                            //    $("#txtName").val(ui.item.label);
                            //    return false;
                            //},
                            select: function (event, ui) {
                                $("#txtPartyID").val(ui.item.id);
                                $("#txtVariantPartyName").val(ui.item.label);
                                //$("#txtRemarks").val(ui.item.id);
                                return false;
                            },
                        }).autocomplete("instance")._renderItem = function (ul, item) {
                            return $("<li class='each'>")
                                .append("<div class='acItem'><span class='name'>" +
                                    item.label + "</span></div>")
                                .appendTo(ul);
                        };
                    }

                }
                else {
                    showErrorSnackbar("No Records Found");
                }
            }
            , error: function (data) {
                if (data.status == "401") {
                    var msg = data.responseJSON.Message;
                    ////showErrorSnackbar(msg + " Logout and Login again.");
                }
            }
        });
    }
    $('#cmbVariantTransaction').change(function (e) {
        var ID = e.target.value;
        if (ID > 0) {
            var ftrans = arrVarTrans.filter(tr => tr.TypeID == ID)
            if (ftrans.length > 0) {
                nVariantTransID = ftrans[0].TransID;
                $("#txtVariantDocID").val(ftrans[0].DocPrefix);
            }
            PType = (ID == 1 || ID == 2 || ID == 3) ? 1 : 2;
            GetVariantData(2, PType);
        } else {
            $("#txtVariantDocID").val("");
            nVariantTransID = 0;
            showErrorSnackbar("Select Transaction");
        }
    });
    $('#btnVariantClear').click(function (e) {
        ClearVariantForm();
    });
    function ClearVariantForm() {
        GetVariantData(1);
        $(".clrdivs").html("");
        $("#txtVariantDocID,#txtVariantPartyName").val("");
        $("#cmbVariantTransaction").focus();
    }
    $("#btnVariantSubmit").click(function () {
        $(".clrdivs").html("");
        var IsValid = true;
        if ($("#cmbVariantTransaction").val() == 0) {
            IsValid = false;
            $("#divErrVariantTransName").html("Select Transaction");
            showErrorSnackbar("Select Transaction");
        }
        if ($("#txtPartyID").val() == 0 || $("#txtPartyID").val() == "") {
            IsValid = false;
            $("#divErrVariantPartyName").html("Select valid party");
            showErrorSnackbar("Select valid party");
        }
        if ($("#txtVariantDocID").val() == "") {
            IsValid = false;
            $("#divErrVariantDocID").html("Doc ID should not be empty");
            showErrorSnackbar("Doc ID should not be empty");
        }
        if (IsValid) {
            var DocID = $("#txtVariantDocID").val()
            var dTransID = nVariantTransID;
            var VariantType = $("#cmbVariantTransaction").val();
            $.ajax({
                url: Aurl + "quicaccessdocument/validate",
                type: 'get',
                contentType: 'json',
                data: { TransID: dTransID, strDocID: DocID },
                xhrFields: {
                    withCredentials: true
                },
                success: function (data) {
                    $.each(data, function (i, items) {
                        if (items.MsgID == "0") {
                            if (VariantType == 1) {// Inv to Qtn
                                window.open(
                                    'Quotation?name=BTQgLv%2BebY48FN9pEezgnyVrVumuVVzPVnoCFOjqIsU%3D&strFormID=jJOtHsRVwYECOhoiBc69dA%3D%3D&TypeID=ydRRTTxkdt6Trx91pX1%2BcA%3D%3D&TranID=' + items.ID + '&TransVariantID=' + VariantType,
                                    '_blank'
                                );
                            }
                            if (VariantType == 2) {// Inv to Sales Return
                                window.open(
                                    'SalesReturn?name=6%2B9sxOBkg1PjlBjpubNIcRsbDdS%2F%2BKzbighA08XDWD0%3D&strFormID=EvsdnH%2BUlJpTVhFYh%2Bi13g%3D%3D&TypeID=ydRRTTxkdt6Trx91pX1%2BcA%3D%3D&TranID=' + items.ID + '&TransVariantID=' + VariantType + '&PartyID=' + $("#txtPartyID").val(),
                                    '_blank'
                                );
                            }
                            if (VariantType == 3) {// Inv to Damage Return
                                window.open(
                                    'SalesReturn?name=cPfu941CFnux5sU80vV6w6mcrcNWP7Vs7hhrLOCLYgo%3D&strFormID=WHYf4alVgNJY%2FX917pnZ3w%3D%3D&TypeID=ydRRTTxkdt6Trx91pX1%2BcA%3D%3D&TranID=' + items.ID + '&TransVariantID=' + VariantType + '&PartyID=' + $("#txtPartyID").val(),
                                    '_blank'
                                );
                            }
                        }
                    });
                }
            });
        }
    });
</script>
